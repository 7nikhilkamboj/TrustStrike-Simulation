{{define "body"}}
{{template "nav" .}}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main redesign-page">
    <!-- Page Header -->
    <h1 class="page-header">Templates</h1>

    <!-- Flash Messages -->
    <div id="flashes" class="row"></div>

    <!-- Main Template Type Tabs -->
    <div class="template-main-tabs" style="margin-top: 20px;">
        <button class="template-main-tab active" data-tab="email" onclick="switchMainTab('email')">
            <i class="fa fa-envelope"></i> Email
        </button>
        <button class="template-main-tab" data-tab="qr" onclick="switchMainTab('qr')">
            <i class="fa fa-qrcode"></i> QR
        </button>
        <button class="template-main-tab" data-tab="sms" onclick="switchMainTab('sms')">
            <i class="fa fa-commenting"></i> SMS
        </button>
        <button class="template-main-tab" data-tab="redirector" onclick="switchMainTab('redirector')">
            <i class="fa fa-external-link"></i> Redirector Page
        </button>
        <button class="template-main-tab" data-tab="login-page" onclick="switchMainTab('login-page')">
            <i class="fa fa-sign-in"></i> Login Page
        </button>
    </div>

    <!-- ================== TEMPLATES TAB (EMAIL/QR/SMS) ================== -->
    <div id="tab-templates" class="template-tab-content active">
        <!-- Action Bar -->
        <div class="page-action-bar">
            <div class="page-action-left">
                <button type="button" class="btn btn-primary" onclick="edit(-1)">
                    <i class="fa fa-plus"></i> New Template
                </button>
                <div class="btn-group">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-ellipsis-h"></i> Bulk Actions <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="bulkDeleteSelected()"><i class="fa fa-trash-o text-danger"></i> Delete
                                Selected</a></li>
                    </ul>
                </div>
            </div>
            <div class="page-action-right">
                <!-- Secondary filter removed as tabs now handle demerging -->
            </div>
        </div>

        <!-- Search Box -->
        <div class="row" style="margin-bottom: 30px;">
            <div class="col-md-12">
                <div class="search-container">
                    <input type="text" class="form-control search-input" id="templateSearch"
                        placeholder="Search templates...">
                    <button class="btn btn-search">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading">
            <i class="fa fa-spinner fa-spin fa-4x"></i>
        </div>

        <!-- Empty Message -->
        <div id="emptyMessage" class="row" style="display:none;">
            <div class="alert alert-info" id="emptyMessageText">
                No templates yet. Let's create one!
            </div>
        </div>

        <!-- Template Cards Container -->
        <div id="templateCardsContainer" class="row" style="display:none;">
            <!-- Cards populated by JavaScript -->
        </div>
    </div>

    <!-- ================== REDIRECTOR TEMPLATES TAB ================== -->
    <div id="tab-redirector" class="template-tab-content" style="display: none;">
        <!-- Action Bar -->
        <div class="page-action-bar">
            <div class="page-action-left">
                <button class="btn btn-primary" onclick="openCreateModal()">
                    <i class="fa fa-plus"></i> New Redirector
                </button>
            </div>
            <div class="page-action-right">
                <div class="search-container">
                    <input type="text" class="form-control search-input" id="searchRedirectors"
                        placeholder="Search redirectors...">
                    <button class="btn btn-search" type="button"><i class="fa fa-search"></i></button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="redirectorLoading">
            <i class="fa fa-spinner fa-spin fa-4x"></i>
        </div>

        <!-- Empty Message -->
        <div id="redirectorEmptyMessage" class="row" style="display:none;">
            <div class="col-md-12">
                <div class="alert alert-info">
                    No redirectors created yet. Let's create one!
                </div>
            </div>
        </div>

        <!-- Redirector Cards Grid -->
        <div class="row" id="redirectorGrid" style="display:none;">
            <!-- Cards populated by JavaScript -->
        </div>

        <!-- Pagination -->
        <div class="row">
            <div class="col-md-12 text-center" id="redirectorPagination"></div>
        </div>
    </div>

    <!-- ================== LOGIN PAGE TEMPLATES TAB ================== -->
    <div id="tab-login-page" class="template-tab-content" style="display: none;">
        <!-- Action Bar -->
        <div class="page-action-bar">
            <div class="page-action-right">
                <div class="search-container">
                    <input type="text" class="form-control search-input" id="phishletSearch"
                        placeholder="Search phishlets...">
                    <button class="btn btn-search" type="button"><i class="fa fa-search"></i></button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loginPageLoading">
            <i class="fa fa-spinner fa-spin fa-4x"></i>
        </div>

        <!-- Empty Message -->
        <div id="loginPageEmptyMessage" class="row" style="display:none;">
            <div class="col-md-12">
                <div class="alert alert-info">
                    No phishlets available. Please check your Simulation Server connection.
                </div>
            </div>
        </div>

        <!-- Phishlet Cards Grid -->
        <div class="phishlet-grid-container" id="phishletGrid" style="display:none;">
            <div id="phishletCardsRow">
                <!-- Cards populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Redirector Modal -->
<div class="modal fade" id="redirectorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title" id="redirectorModalTitle">New Redirector</h4>
            </div>
            <div class="modal-body">
                <div id="redirectorModal.flashes"></div>
                <input type="hidden" id="editingRedirectorName" value="">

                <div class="form-group">
                    <label for="redirectorName">Name</label>
                    <input type="text" class="form-control" id="redirectorName" placeholder="e.g., turnstile">
                    <small class="help-block">A unique name (no spaces). Use <code>{strike_url_html}</code> in
                        HTML for the lure URL.</small>
                </div>

                <div class="form-group">
                    <label for="redirectorHtml">HTML Content</label>
                    <textarea class="form-control" id="redirectorHtml" rows="15"
                        placeholder="Enter HTML content..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRedirectorBtn" onclick="saveRedirector()">
                    <i class="fa fa-save"></i> Save Redirector
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Full Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document" style="width: 900px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title" id="previewModalTitle">Preview</h4>
            </div>
            <div class="modal-body" style="padding: 0;">
                <iframe id="previewFrame" style="width: 100%; height: 500px; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Main Template Type Tabs */
    .template-main-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 2px solid #E5E7EB;
        padding-bottom: 0;
    }

    .template-main-tab {
        background: transparent;
        border: none;
        padding: 12px 24px;
        font-weight: 600;
        font-size: 14px;
        color: #6B7280;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        border-radius: 8px 8px 0 0;
    }

    .template-main-tab:hover {
        color: #4338CA;
        background: #F3F4F6;
    }

    .template-main-tab.active {
        color: #4338CA;
        background: #EEF2FF;
    }

    .template-main-tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: #4338CA;
        border-radius: 3px 3px 0 0;
    }

    .template-main-tab i {
        margin-right: 8px;
    }

    .template-tab-content {
        display: none;
    }

    .template-tab-content.active {
        display: block;
    }

    .page-subtitle {
        color: #6B7280;
        font-size: 14px;
        font-weight: 500;
    }

    .search-container {
        display: flex;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        background: #FFFFFF;
    }

    .search-input {
        border: none;
        border-radius: 0;
        height: 50px;
        font-size: 16px;
        padding-left: 20px;
        box-shadow: none;
    }

    .search-input:focus {
        box-shadow: none;
        border-color: transparent;
    }

    .btn-search {
        background: #4338CA;
        color: #fff;
        border: none;
        border-radius: 0;
        padding: 0 25px;
        height: 50px;
    }

    .btn-search:hover {
        background: #3730A3;
        color: #fff;
    }

    .template-card {
        background: #fff;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.2s ease;
    }

    .template-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .template-card-header {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #F3F4F6;
        background: #F9FAFB;
    }

    .template-card-title {
        font-weight: 600;
        font-size: 16px;
        color: #111827;
        margin-left: 10px;
    }

    .btn-full-preview {
        background: #4338CA;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-full-preview:hover {
        background: #3730A3;
        color: #fff;
    }

    .template-card-preview {
        padding: 16px;
        min-height: 200px;
        max-height: 280px;
        overflow: hidden;
        background: #fff;
        border-bottom: 1px solid #F3F4F6;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
        color: #374151;
        line-height: 1.6;
    }

    .template-card-preview iframe {
        width: 100%;
        height: 240px;
        border: none;
        pointer-events: none;
        border-radius: 8px;
    }

    .template-card-actions {
        padding: 16px 20px;
        display: flex;
        justify-content: center;
        gap: 12px;
        background: #F9FAFB;
    }

    .btn-action-card {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        border: none;
        transition: all 0.2s;
    }

    .btn-action-card.btn-edit {
        background: #EFF6FF;
        color: #3B82F6;
    }

    .btn-action-card.btn-edit:hover {
        background: #3B82F6;
        color: #fff;
    }

    .btn-action-card.btn-copy {
        background: #ECFDF5;
        color: #10B981;
    }

    .btn-action-card.btn-copy:hover {
        background: #10B981;
        color: #fff;
    }

    .btn-action-card.btn-delete {
        background: #FEF2F2;
        color: #DC2626;
    }

    .btn-action-card.btn-delete:hover {
        background: #DC2626;
        color: #fff;
    }

    .template-checkbox-wrapper {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 10;
    }

    .template-checkbox-wrapper input[type="checkbox"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border: 2px solid #4338CA;
        border-radius: 50%;
        background: #FFFFFF;
        cursor: pointer;
        margin: 6px 6px 0;
        position: relative;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .template-checkbox-wrapper input[type="checkbox"]:hover {
        border-color: #3730A3;
        background: #EEF2FF;
    }

    .template-checkbox-wrapper input[type="checkbox"]:checked {
        background: #4338CA;
        border-color: #4338CA;
    }

    .template-checkbox-wrapper input[type="checkbox"]:checked::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #FFFFFF;
        font-size: 14px;
        font-weight: bold;
    }

    .template-card-wrapper {
        position: relative;
    }

    /* Filter Pills Override for Templates */
    .redesign-page #templateTypeFilter {
        display: flex !important;
        gap: 4px !important;
        background-color: #DEDEDE !important;
        padding: 4px !important;
        border-radius: 9999px !important;
    }

    .redesign-page #templateTypeFilter .btn,
    .redesign-page #templateTypeFilter .btn.btn-primary {
        background: transparent !important;
        border: none !important;
        color: #4B5563 !important;
        font-weight: 500 !important;
        padding: 8px 16px !important;
        border-radius: 9999px !important;
        transition: all 0.2s ease !important;
        box-shadow: none !important;
    }

    .redesign-page #templateTypeFilter .btn:hover,
    .redesign-page #templateTypeFilter .btn.btn-primary:hover {
        color: #1F2937 !important;
        background-color: #E5E7EB !important;
    }

    .redesign-page #templateTypeFilter .btn.active,
    .redesign-page #templateTypeFilter .btn:active,
    .redesign-page #templateTypeFilter .btn.btn-primary.active,
    .redesign-page #templateTypeFilter .btn.btn-primary:active {
        background-color: #4338CA !important;
        color: #FFFFFF !important;
        font-weight: 600 !important;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
    }

    /* Redirector Card Styles */
    .redirector-card {
        width: 100%;
        height: 360px;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #fff;
        position: relative;
        display: flex;
        flex-direction: column;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
    }

    .redirector-card:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        transform: translateY(-3px);
        border-color: #D1D5DB;
    }

    .redirector-header {
        padding: 14px 18px;
        background: #F9FAFB;
        border-bottom: 1px solid #F3F4F6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 52px;
        flex-shrink: 0;
    }

    .redirector-name {
        font-weight: 600;
        font-size: 15px;
        color: #111827;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 60%;
    }

    .redirector-preview {
        flex: 1;
        background: #fff;
        position: relative;
        overflow: hidden;
    }

    .redirector-preview iframe {
        width: 200%;
        height: 200%;
        border: 0;
        transform: scale(0.5);
        transform-origin: 0 0;
        pointer-events: none;
    }

    .redirector-footer {
        padding: 14px 18px;
        background: #F9FAFB;
        border-top: 1px solid #F3F4F6;
        flex-shrink: 0;
        height: 70px;
    }

    .redirector-actions {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 12px;
    }

    .btn-action {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        background: #ECFDF5;
        border: none;
        color: #10B981;
        transition: all 0.2s ease;
    }

    .btn-action:hover {
        background: #4F46E5 !important;
        color: #fff;
    }

    .btn-action-preview {
        background: #19191A;
        color: #fff;
    }

    .btn-action-preview:hover {
        color: #fff;
        background: #4F46E5 !important;
    }

    .btn-action-delete {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        background: #FEF2F2;
        border: none;
        color: #DC2626;
        transition: all 0.2s ease;
    }

    .btn-action-delete:hover {
        background: #DC2626;
        color: #fff;
    }

    /* Phishlet/Login Page Styles */
    .phishlet-grid-container {
        overflow-y: auto;
        padding: 24px;
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 16px;
        margin-top: 8px;
        margin-bottom: 30px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    #phishletCardsRow {
        display: grid !important;
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        gap: 24px !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .phishlet-card-wrapper {
        width: auto !important;
        max-width: none !important;
        flex: none !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .phishlet-card {
        border: 1px solid #E5E7EB;
        padding: 0;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #FFFFFF;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        width: 100%;
        height: 330px;
        border-radius: 12px;
    }

    .phishlet-card:hover {
        transform: translateY(-4px);
        border-color: #4338CA;
        box-shadow: 0 8px 20px rgba(67, 56, 202, 0.15);
    }

    .phishlet-preview-container {
        width: 100%;
        height: 250px;
        overflow: hidden;
        position: relative;
        border-bottom: 1px solid #F3F4F6;
        background: #F9FAFB;
    }

    .phishlet-preview-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: top;
        transition: transform 0.4s ease;
    }

    .phishlet-card:hover .phishlet-preview-img {
        transform: scale(1.05);
    }

    .phishlet-preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .phishlet-card:hover .phishlet-preview-overlay {
        opacity: 1;
    }

    .btn-preview {
        background: white;
        color: #111827;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transform: translateY(10px);
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .phishlet-card:hover .btn-preview {
        transform: translateY(0);
    }

    .btn-preview:hover {
        background: #F3F4F6;
        transform: scale(1.05);
    }

    .phishlet-card-content {
        padding: 12px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #FFFFFF;
    }

    .phishlet-card .phishlet-icon {
        font-size: 28px;
        color: #4338CA;
        margin-bottom: 8px;
        transition: all 0.3s;
    }

    .phishlet-card .phishlet-name {
        font-weight: 600;
        color: #111827;
        font-size: 14px;
        word-break: break-all;
    }

    .phishlet-status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 10px;
        font-size: 10px;
        font-weight: 600;
        border-radius: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 2;
    }

    .phishlet-status-badge.enabled {
        background: #ECFDF5;
        color: #059669;
    }

    .phishlet-status-badge.disabled {
        background: #F3F4F6;
        color: #6B7280;
    }

    /* Brand Specific Icon Colors */
    .phishlet-icon.brand-google {
        color: #4285F4 !important;
    }

    .phishlet-icon.brand-microsoft {
        color: #00A4EF !important;
    }

    .phishlet-icon.brand-linkedin {
        color: #0077B5 !important;
    }

    .phishlet-icon.brand-github {
        color: #181717 !important;
    }

    .phishlet-icon.brand-amazon {
        color: #FF9900 !important;
    }

    .phishlet-icon.brand-facebook {
        color: #1877F2 !important;
    }

    .phishlet-icon.brand-twitter {
        color: #1DA1F2 !important;
    }

    .phishlet-icon.brand-apple {
        color: #000000 !important;
    }

    .phishlet-icon.brand-reddit {
        color: #FF4500 !important;
    }

    .phishlet-icon.brand-slack {
        color: #4A154B !important;
    }
</style>

{{end}}
{{define "scripts"}}
<script src="/js/src/vendor/ckeditor/ckeditor.js"></script>
<script src="/js/src/vendor/ckeditor/adapters/jquery.js"></script>
<script src="/js/dist/app/autocomplete.min.js"></script>
<script>
    // ===================== MAIN TAB SWITCHING =====================
    var currentMainTab = 'email';
    var tabsLoaded = { 'email': false, 'qr': false, 'sms': false, 'redirector': false, 'login-page': false };

    function switchMainTab(tab) {
        currentMainTab = tab;

        // Update tab buttons
        $('.template-main-tab').removeClass('active');
        $('.template-main-tab[data-tab="' + tab + '"]').addClass('active');

        // Show/hide content
        $('.template-tab-content').removeClass('active').hide();

        // Map templates tabs to the shared container
        var contentId = (tab === 'email' || tab === 'qr' || tab === 'sms') ? 'templates' : tab;
        $('#tab-' + contentId).addClass('active').show();

        // Load data
        if (tab === 'email' || tab === 'qr' || tab === 'sms') {
            templateType = tab;
            load();
        } else if (tab === 'redirector') {
            if (!tabsLoaded[tab]) {
                loadEC2Data('redirector');
                tabsLoaded[tab] = true;
            }
        } else if (tab === 'login-page') {
            if (!tabsLoaded[tab]) {
                loadEC2Data('login-page');
                tabsLoaded[tab] = true;
            }
        }
    }

    var templates = []
    var templateType = "email" // Default to email as requested

    function edit(idx) {
        if (idx == -1) {
            location.href = "/template"
        } else {
            location.href = "/template/" + templates[idx].id
        }
    }

    function copy(idx) {
        location.href = "/template?copy=" + templates[idx].id
    }

    function deleteTemplate(idx) {
        Swal.fire({
            title: "Are you sure?",
            text: "This will delete the template. This can't be undone!",
            type: "warning",
            animation: false,
            showCancelButton: true,
            confirmButtonText: "Delete " + escapeHtml(templates[idx].name),
            confirmButtonColor: "#428bca",
            reverseButtons: true,
            allowOutsideClick: false,
            preConfirm: function () {
                return new Promise(function (resolve, reject) {
                    api.templateId.delete(templates[idx].id)
                        .done(function (msg) {
                            resolve(msg)
                        })
                        .fail(function (data) {
                            var message = "An error occurred"
                            if (data.responseJSON && data.responseJSON.message) {
                                message = data.responseJSON.message
                            } else if (data.responseText) {
                                message = data.responseText
                            }
                            Swal.showValidationMessage(message)
                            resolve(false)
                        })
                })
            }
        }).then(function (result) {
            if (result.value) {
                Swal.fire(
                    'Template Deleted!',
                    'This template has been deleted!',
                    'success'
                ).then(() => {
                    load()
                });
            }
        })
    }

    function load() {
        $("#templateCardsContainer").hide()
        $("#emptyMessage").hide()
        $("#loading").show()

        api.templates.get()
            .done(function (ts) {
                templates = ts

                // Filter based on templateType
                if (templateType == "sms") {
                    templates = templates.filter(t => t.type == "sms")
                } else if (templateType == "qr") {
                    templates = templates.filter(t => t.type == "qr")
                } else if (templateType == "email") {
                    templates = templates.filter(t => !t.type || t.type == "email")
                }

                $("#loading").hide()

                if (templates.length > 0) {
                    renderTemplateCards()
                    $("#templateCardsContainer").show()
                } else {
                    $("#emptyMessage").show()
                }
            })
            .fail(function () {
                $("#loading").hide()
                errorFlash("Error fetching templates")
            })
    }

    function renderTemplateCards() {
        var $container = $("#templateCardsContainer")
        $container.empty()

        templates.forEach(function (template, idx) {
            var name = template.name || "Untitled"
            var html = template.html || template.text || ""

            var cardHtml = `
        <div class="col-md-4 template-card-wrapper" data-name="${escapeHtml(name)}">
            <div class="template-checkbox-wrapper">
                <input type="checkbox" class="template-checkbox" value="${template.id}">
            </div>
            <div class="template-card">
                <div class="template-card-header">
                    <span class="template-card-title">${escapeHtml(name)}</span>
                    <button class="btn btn-full-preview" onclick="showFullPreview(${idx})">
                        FULL PREVIEW
                    </button>
                </div>
                <div class="template-card-preview">
                    <iframe srcdoc="${escapeHtml(html)}" sandbox="allow-same-origin"></iframe>
                </div>
                <div class="template-card-actions">
                    <button class="btn btn-action-card btn-edit" onclick="edit(${idx})" title="Edit">
                        <i class="fa fa-pencil"></i>
                    </button>
                    <button class="btn btn-action-card btn-copy" onclick="copy(${idx})" title="Copy">
                        <i class="fa fa-copy"></i>
                    </button>
                    <button class="btn btn-action-card btn-delete" onclick="deleteTemplate(${idx})" title="Delete">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        `

            $container.append(cardHtml)
        })
    }

    function showFullPreview(idx) {
        var template = templates[idx]
        var html = template.html || template.text || ""

        Swal.fire({
            title: escapeHtml(template.name) + ' - Full Preview',
            html: '<iframe srcdoc="' + escapeHtml(html) + '" style="width: 100%; height: 70vh; border: none;" sandbox="allow-same-origin"></iframe>',
            width: '80%',
            showCloseButton: true,
            showConfirmButton: false
        })
    }

    /* --- Bulk Management --- */
    function bulkDeleteSelected() {
        var ids = []
        $(".template-checkbox:checked").each(function () {
            ids.push($(this).val())
        })

        if (ids.length === 0) {
            Swal.fire("No selection", "Please select at least one template to delete.", "info")
            return
        }

        Swal.fire({
            title: "Delete " + ids.length + " templates?",
            text: "This action cannot be undone!",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Delete",
            confirmButtonColor: "#d9534f",
            reverseButtons: true
        }).then(function (result) {
            if (result.value) {
                Swal.fire({
                    title: 'Deleting...',
                    allowOutsideClick: false,
                    onBeforeOpen: () => {
                        Swal.showLoading()
                    }
                })

                var promises = ids.map(id => api.templateId.delete(id))
                $.when.apply($, promises).then(function () {
                    Swal.fire('Deleted!', 'The selected templates have been removed.', 'success').then(() => {
                        load()
                    })
                }).fail(function () {
                    Swal.fire('Error', 'Some templates could not be deleted.', 'error').then(() => {
                        load()
                    })
                })
            }
        })
    }

    // ===================== REDIRECTOR TEMPLATES =====================
    var redirectors = [];
    var redirectorCurrentPage = 1;
    var redirectorItemsPerPage = 6;
    const REDIRECTOR_API_BASE = "/api/simulationserver/redirectors";
    const EC2_STATUS_API = "/api/simulationserver/ec2/status";

    function loadEC2Data(tab) {
        $.ajax({
            url: EC2_STATUS_API,
            method: "GET",
            success: function (response) {
                if (response.success && response.data.state === "stopped") {
                    $.ajax({
                        url: "/api/simulationserver/ec2/start",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({ start_evil: true, ignore_throttle: false }),
                        timeout: 300000,
                        success: function (response) {
                            //console.log("EC2 auto-start triggered");
                        },
                        error: function (xhr) {
                            if (xhr.status === 429) {
                                //console.log("EC2 auto-start throttled (24h limit)");
                            } else {
                                // console.error("Failed to auto-start EC2", xhr);
                            }
                        },
                        complete: function () {
                            // Always load data regardless of start success (cache fallback will handle it)
                            if (tab === 'redirector') loadRedirectors();
                            else if (tab === 'login-page') loadPhishlets();
                            tabsLoaded[tab] = true;
                        }
                    });
                } else {
                    if (tab === 'redirector') loadRedirectors();
                    else if (tab === 'login-page') loadPhishlets();
                    tabsLoaded[tab] = true;
                }
            },
            error: function (xhr) {
                //console.error("Failed to load EC2 status", xhr);
                if (tab === 'redirector') loadRedirectors();
                else if (tab === 'login-page') loadPhishlets();
                tabsLoaded[tab] = true;
            }
        });
    }

    function loadRedirectors() {
        $("#redirectorLoading").show();
        $("#redirectorGrid").hide();
        $("#redirectorEmptyMessage").hide();
        $("#redirectorCacheNotice").hide();

        $.ajax({
            url: REDIRECTOR_API_BASE,
            method: "GET",
            success: function (response, textStatus, xhr) {
                $("#redirectorLoading").hide();

                // Check if data is from cache
                var cacheStatus = xhr.getResponseHeader("X-Cache-Status");
                if (cacheStatus === "cached") {
                    $("#redirectorCacheNotice").show();
                }

                if (response.success && Array.isArray(response.redirectors)) {
                    redirectors = response.redirectors;
                } else if (Array.isArray(response)) {
                    redirectors = response;
                } else {
                    redirectors = [];
                }

                if (redirectors.length === 0) {
                    $("#redirectorEmptyMessage").show();
                } else {
                    $("#redirectorGrid").show();
                    renderRedirectorCards();
                }
            },
            error: function (xhr) {
                $("#redirectorLoading").hide();
                showRedirectorError("Failed to load redirectors: " + (xhr.responseJSON?.message || "Unknown error"));
            }
        });
    }

    function renderRedirectorCards() {
        var grid = $("#redirectorGrid");
        grid.empty();

        var searchTerm = $("#searchRedirectors").val().toLowerCase();
        var filtered = redirectors.filter(function (r) {
            var name = r.name || r;
            return !searchTerm || name.toLowerCase().indexOf(searchTerm) > -1;
        });

        if (filtered.length === 0) {
            grid.html('<div class="col-md-12"><div class="alert alert-info">No redirectors match your search.</div></div>');
            $("#redirectorPagination").hide();
            return;
        }

        var totalPages = Math.ceil(filtered.length / redirectorItemsPerPage);
        if (redirectorCurrentPage > totalPages) redirectorCurrentPage = 1;

        var startIdx = (redirectorCurrentPage - 1) * redirectorItemsPerPage;
        var endIdx = startIdx + redirectorItemsPerPage;
        var pageItems = filtered.slice(startIdx, endIdx);

        pageItems.forEach(function (redirector) {
            var name = redirector.name || redirector;
            var htmlBase64 = redirector.html_base64 || "";
            var htmlEscaped = redirector.html_escaped || "";

            var previewHtml = "";
            if (htmlBase64) {
                try {
                    previewHtml = atob(htmlBase64);
                } catch (e) {
                    previewHtml = htmlEscaped;
                }
            } else if (htmlEscaped) {
                var div = document.createElement('div');
                div.innerHTML = htmlEscaped;
                previewHtml = div.textContent || div.innerText || "";
            }

            var cardHtml = `
                <div class="col-md-4 col-sm-6">
                    <div class="redirector-card" id="card-${escapeHtml(name)}">
                        <div class="redirector-header">
                            <div class="redirector-name" title="${escapeHtml(name)}">${escapeHtml(name)}</div>
                            <button class="btn btn-success btn-xs btn-action-preview" onclick="previewFull('${escapeHtml(name)}'); event.stopPropagation();" 
                                    style="padding: 4px 8px; font-size: 14px; font-weight: bold;">
                                FULL PREVIEW
                            </button>
                        </div>
                        <div class="redirector-preview">
                            <iframe srcdoc="${previewHtml.replace(/"/g, '&quot;')}" sandbox></iframe>
                        </div>
                        <div class="redirector-footer">
                            <div class="redirector-actions">
                                <button class="btn btn-default btn-sm btn-action" onclick="editRedirector('${escapeHtml(name)}'); event.stopPropagation();" title="Edit">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="btn btn-danger btn-sm btn-action-delete" onclick="deleteRedirector('${escapeHtml(name)}'); event.stopPropagation();" title="Delete">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            grid.append(cardHtml);
        });

        renderRedirectorPagination(totalPages);
    }

    function renderRedirectorPagination(totalPages) {
        if (totalPages <= 1) {
            $("#redirectorPagination").hide();
            return;
        }

        var html = '<ul class="pagination" style="margin: 0;">';
        html += '<li class="' + (redirectorCurrentPage === 1 ? 'disabled' : '') + '"><a href="#" onclick="changeRedirectorPage(' + (redirectorCurrentPage - 1) + '); return false;">&laquo;</a></li>';

        for (var i = 1; i <= totalPages; i++) {
            html += '<li class="' + (i === redirectorCurrentPage ? 'active' : '') + '"><a href="#" onclick="changeRedirectorPage(' + i + '); return false;">' + i + '</a></li>';
        }

        html += '<li class="' + (redirectorCurrentPage === totalPages ? 'disabled' : '') + '"><a href="#" onclick="changeRedirectorPage(' + (redirectorCurrentPage + 1) + '); return false;">&raquo;</a></li>';
        html += '</ul>';

        $("#redirectorPagination").html(html).show();
    }

    function changeRedirectorPage(page) {
        var totalPages = Math.ceil(redirectors.length / redirectorItemsPerPage);
        if (page < 1 || page > totalPages) return;
        redirectorCurrentPage = page;
        renderRedirectorCards();
    }

    function openCreateModal() {
        $("#redirectorModalTitle").text("New Redirector");
        $("#editingRedirectorName").val("");
        $("#redirectorName").val("").prop("readonly", false);

        if (CKEDITOR.instances.redirectorHtml) {
            CKEDITOR.instances.redirectorHtml.setData("");
        } else {
            $("#redirectorHtml").val("");
        }

        $("#redirectorModal").modal("show");
    }

    function editRedirector(name) {
        var redirector = redirectors.find(function (r) {
            return (r.name || r) === name;
        });

        if (!redirector) {
            showRedirectorError("Redirector not found");
            return;
        }

        $("#redirectorModalTitle").text("Edit Redirector");
        $("#editingRedirectorName").val(name);
        $("#redirectorName").val(name).prop("readonly", true);

        var html = "";
        if (redirector.html_base64) {
            try {
                html = atob(redirector.html_base64);
            } catch (e) {
                html = "";
            }
        }

        if (CKEDITOR.instances.redirectorHtml) {
            CKEDITOR.instances.redirectorHtml.setData(html);
        } else {
            $("#redirectorHtml").val(html);
        }

        $("#redirectorModal").modal("show");
    }

    function saveRedirector() {
        var editingName = $("#editingRedirectorName").val();
        var name = $("#redirectorName").val().trim();
        var html = CKEDITOR.instances.redirectorHtml ?
            CKEDITOR.instances.redirectorHtml.getData() :
            $("#redirectorHtml").val();

        if (!name) {
            showRedirectorError("Please enter a name");
            return;
        }

        if (/\s/.test(name)) {
            showRedirectorError("Name cannot contain spaces");
            return;
        }

        if (!html) {
            showRedirectorError("Please enter HTML content");
            return;
        }

        var btn = $("#saveRedirectorBtn");
        var originalHtml = btn.html();
        btn.html('<i class="fa fa-spinner fa-spin"></i> Saving...').prop("disabled", true);

        var isEdit = editingName !== "";
        var url = isEdit ? REDIRECTOR_API_BASE + "/" + encodeURIComponent(editingName) : REDIRECTOR_API_BASE;
        var method = isEdit ? "PUT" : "POST";

        $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            data: JSON.stringify({
                name: name,
                html: html
            }),
            success: function (response) {
                btn.html(originalHtml).prop("disabled", false);

                if (response.success) {
                    $("#redirectorModal").modal("hide");
                    showRedirectorSuccess(isEdit ? "Redirector updated!" : "Redirector created!");
                    loadRedirectors();
                } else {
                    showRedirectorError(response.message || response.error || "Failed to save");
                }
            },
            error: function (xhr) {
                btn.html(originalHtml).prop("disabled", false);
                showRedirectorError("Failed to save: " + (xhr.responseJSON?.message || "Server error"));
            }
        });
    }

    function deleteRedirector(name) {
        Swal.fire({
            title: "Are you sure?",
            text: "Delete redirector '" + name + "'?",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            confirmButtonText: "Yes, delete it!"
        }).then(function (result) {
            if (result.value) {
                $.ajax({
                    url: REDIRECTOR_API_BASE + "/" + encodeURIComponent(name),
                    method: "DELETE",
                    success: function (response) {
                        if (response.success) {
                            showRedirectorSuccess("Redirector deleted!");
                            loadRedirectors();
                        } else {
                            showRedirectorError(response.message || "Failed to delete");
                        }
                    },
                    error: function () {
                        showRedirectorError("Failed to delete redirector");
                    }
                });
            }
        });
    }

    function previewFull(name) {
        var redirector = redirectors.find(function (r) {
            return (r.name || r) === name;
        });

        if (!redirector) return;

        var html = "";
        if (redirector.html_base64) {
            try {
                html = atob(redirector.html_base64);
            } catch (e) {
                html = redirector.html_escaped || "";
            }
        }

        $("#previewModalTitle").text("Preview: " + name);
        document.getElementById("previewFrame").srcdoc = html;
        $("#previewModal").modal("show");
    }

    function showRedirectorSuccess(message) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({ icon: 'success', title: 'Success', text: message, timer: 2000, showConfirmButton: false });
        } else {
            $("#flashes").html('<div class="alert alert-success">' + message + '</div>');
        }
    }

    function showRedirectorError(message) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({ icon: 'error', title: 'Error', text: message });
        } else {
            $("#flashes").html('<div class="alert alert-danger">' + message + '</div>');
        }
    }

    // ===================== LOGIN PAGE TEMPLATES =====================
    var phishlets = [];

    function loadPhishlets() {
        $("#loginPageLoading").show();
        $("#phishletGrid").hide();
        $("#loginPageEmptyMessage").hide();
        $("#loginPageCacheNotice").hide();

        $.ajax({
            url: "/api/simulationserver/modules",
            method: "GET",
            success: function (response, textStatus, xhr) {
                $("#loginPageLoading").hide();

                // Check if data is from cache
                var cacheStatus = xhr.getResponseHeader("X-Cache-Status");
                if (cacheStatus === "cached") {
                    $("#loginPageCacheNotice").show();
                }

                if (response && response.length > 0) {
                    phishlets = response;
                    renderPhishletCards();
                    $("#phishletGrid").show();
                } else {
                    $("#loginPageEmptyMessage").show();
                }
            },
            error: function () {
                $("#loginPageLoading").hide();
                $("#loginPageEmptyMessage").show();
            }
        });
    }

    function renderPhishletCards() {
        var $row = $("#phishletCardsRow");
        $row.empty();

        phishlets.forEach(function (phishlet) {
            var name = phishlet.name || phishlet;
            var enabled = phishlet.enabled || false;

            var iconClass = getBrandIconClass(name);
            var brandClass = getBrandColorClass(name);

            var previewImg = "/images/phishlets/" + name + ".png";
            var fallbackImg = "/images/phishlets/generic_preview.png";

            var cardHtml = `
            <div class="phishlet-card-wrapper" data-name="${name}">
                <div class="phishlet-card"">
                    <div class="phishlet-preview-container">
                        <img class="phishlet-preview-img" src="${previewImg}"
                            onerror="this.src='${fallbackImg}'" alt="${name} preview">
                        <div class="phishlet-preview-overlay">
                            <button class="btn-preview" onclick="openPhishletPreview(event, '${name}')">
                                <i class="fa fa-eye"></i> Full Preview
                            </button>
                        </div>
                    </div>
                    <div class="phishlet-card-content">
                        <img class="phishlet-icon ${brandClass}" src="/${name}.svg"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"
                            style="width: 32px; height: 32px;">
                        <i class="${iconClass} phishlet-icon ${brandClass}" style="display: none;"></i>
                        <span class="phishlet-name">${name}</span>
                    </div>
                </div>
            </div>
        `;

            $row.append(cardHtml);
        });
    }

    function openPhishletPreview(event, name) {
        event.stopPropagation();
        var imgPath = "/images/phishlets/" + name + ".png";

        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: name,
                imageUrl: imgPath,
                imageAlt: name + ' preview',
                showCloseButton: true,
                showConfirmButton: false,
                width: 600,
                padding: '20px',
                background: '#fff'
            });
        } else {
            window.open(imgPath, '_blank');
        }
    }

    function getBrandIconClass(name) {
        var iconMap = {
            'google': 'fa fa-google',
            'microsoft': 'fa fa-windows',
            'o365': 'fa fa-windows',
            'linkedin': 'fa fa-linkedin',
            'github': 'fa fa-github',
            'git': 'fa fa-github',
            'amazon': 'fa fa-amazon',
            'facebook': 'fa fa-facebook',
            'twitter': 'fa fa-twitter',
            'apple': 'fa fa-apple',
            'reddit': 'fa fa-reddit',
            'slack': 'fa fa-slack',
            'example': 'fa fa-shield'
        };
        return iconMap[name.toLowerCase()] || 'fa fa-globe';
    }

    function getBrandColorClass(name) {
        var colorMap = {
            'google': 'brand-google',
            'microsoft': 'brand-microsoft',
            'o365': 'brand-microsoft',
            'linkedin': 'brand-linkedin',
            'github': 'brand-github',
            'git': 'brand-github',
            'amazon': 'brand-amazon',
            'facebook': 'brand-facebook',
            'twitter': 'brand-twitter',
            'apple': 'brand-apple',
            'reddit': 'brand-reddit',
            'slack': 'brand-slack'
        };
        return colorMap[name.toLowerCase()] || '';
    }

    // ===================== INITIALIZATION =====================
    $(document).ready(function () {
        // Load initial tab
        switchMainTab('email');

        // Template search filter
        $("#templateSearch").on("keyup", function () {
            var searchTerm = $(this).val().toLowerCase()
            $(".template-card-wrapper").each(function () {
                var name = $(this).data("name").toLowerCase()
                if (name.indexOf(searchTerm) > -1) {
                    $(this).show()
                } else {
                    $(this).hide()
                }
            })
        });

        // Redirector search filter
        $("#searchRedirectors").on("keyup", function () {
            redirectorCurrentPage = 1;
            renderRedirectorCards();
        });

        // Phishlet search filter
        $("#phishletSearch").on("keyup", function () {
            var searchTerm = $(this).val().toLowerCase();
            $(".phishlet-card-wrapper").each(function () {
                var name = $(this).data("name").toLowerCase();
                if (name.indexOf(searchTerm) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Initialize CKEditor when redirector modal opens
        $("#redirectorModal").on("shown.bs.modal", function () {
            if (!CKEDITOR.instances.redirectorHtml) {
                $("#redirectorHtml").ckeditor({
                    height: 300,
                    allowedContent: true,
                    extraAllowedContent: '*(*);*{*}',
                    fullPage: true
                });
            }
        });
    });
</script>
{{end}}