{{define "body"}}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main redesign-page">
    <div class="page-action-bar">
        <h1 class="page-header">DNS Configuration</h1>
    </div>
    <div id="flashes" class="row">
        {{template "flashes" .Flashes}}
    </div>

    <div class="row">
        <!-- LEFT COLUMN: ALL DOMAINS -->
        <div class="col-md-8">
            <div class="table-container" style="margin-bottom: 30px; padding: 25px; height: 100%;">
                <h4 style="margin-top: 0; margin-bottom: 20px; font-weight: 600; color: #333;">Your Domains</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Domain name</th>
                                <th>Status</th>
                                <th>Name Servers</th>
                            </tr>
                        </thead>
                        <tbody id="allDomainsListBody">
                            <tr>
                                <td colspan="3" class="text-center">Loading domains...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: ONBOARD NEW DOMAIN -->
        <div class="col-md-4">
            <div class="table-container" style="margin-bottom: 30px; padding: 25px; height: 100%;">
                <h4 style="margin-top: 0; margin-bottom: 20px; font-weight: 600; color: #333;">Onboard New Domain</h4>

                <div class="form-group">
                    <label style="margin-bottom: 8px; color: #666;">Domain Name</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="configDomainCF" class="form-control" placeholder="example.com"
                            style="flex: 1;">
                        <button class="btn btn-primary" onclick="setupCloudflare()" style="width: auto;">Set</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label style="margin-bottom: 8px; color: #666;">Nameservers</label>
                            <div id="nsContainer" style="min-height: 40px; padding-top: 5px;"></div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="form-group">
                            <label style="margin-bottom: 8px; color: #666;">
                                Nameserver Status
                                <button type="button" class="btn btn-default btn-sm" onclick="refreshNameserverStatus()"
                                    style="margin-left: 10px; padding: 2px 8px;">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </label>
                            <input type="text" class="form-control" id="nameserverStatus" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <!-- SECTION 3: MANAGE DNS RECORDS -->
            <div class="table-container" style="margin-bottom: 30px; padding: 25px;">
                <h4 style="margin-top: 0; margin-bottom: 20px; font-weight: 600; color: #333;">Manage DNS Records</h4>

                <div class="form-group" style="margin-bottom: 30px;">
                    <label style="margin-bottom: 8px; color: #666;">Select Domain to Manage</label>
                    <select id="domainSelectDropdown" class="form-control" onchange="loadDNSRecords()">
                        <option value="">Select a domain</option>
                    </select>
                </div>

                <!-- DNS Records Table (Hidden by default) -->
                <div id="dnsRecordsSection" style="display: none;">
                    <h5 style="margin-bottom: 15px; font-weight: 600; color: #555;">Current Records</h5>
                    <div class="table-responsive" style="margin-bottom: 30px;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Name</th>
                                    <th>Content</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="dnsRecordsListBody">
                            </tbody>
                        </table>
                    </div>

                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h5 style="margin-top: 0; margin-bottom: 15px; font-weight: 600; color: #555;">Create Subdomain
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label style="font-size: 12px; color: #777;">Subdomain Name</label>
                                    <input type="text" id="newSubdomainName" class="form-control"
                                        placeholder="e.g. admin">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label style="font-size: 12px; color: #777;">IP Address / Content</label>
                                    <input type="text" id="newSubdomainIP" class="form-control"
                                        placeholder="e.g. 1.2.3.4">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group text-center">
                                    <label style="font-size: 12px; visibility: hidden; display: block;">Spacer</label>
                                    <button class="btn btn-primary" onclick="createDNSRecord()">Create</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .ns-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        max-width: 350px;
        padding: 10px 14px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fff;
        margin-bottom: 10px;
    }

    .ns-value {
        font-family: monospace;
        font-size: 14px;
    }

    .ns-copy {
        font-size: 13px;
        color: #1a73e8;
        cursor: pointer;
        text-decoration: none;
    }

    .ns-copy:hover {
        text-decoration: underline;
    }

    .ns-cell-list {
        font-size: 11px;
        font-family: monospace;
        color: #555;
    }
</style>
{{end}}

{{define "scripts"}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        background: '#fff',
        color: '#fff',
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
    });

    function showToast(icon, title) {
        let bgColor = '#28a745';
        let textColor = '#ffffff';
        if (icon === 'error' || icon === 'warning') {
            bgColor = '#dc3545';
        }
        Toast.fire({
            icon: icon,
            title: title,
            background: bgColor,
            color: textColor,
            iconColor: textColor
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadAllDomains();
    });

    // Store domains globally for nameserver lookup
    let allDomains = [];

    async function loadAllDomains() {
        try {
            const response = await fetch('/api/simulationserver/config/fetch_alldomains');
            if (!response.ok) {
                console.error('Failed to fetch all domains');
                return;
            }
            const data = await response.json();
            if (data.success) {
                allDomains = data.data || [];
                renderAllDomains(allDomains);
            }
        } catch (err) {
            console.error('Error in loadAllDomains:', err);
        }
    }

    function renderAllDomains(domains) {
        const tbody = document.getElementById('allDomainsListBody');
        const dropdown = document.getElementById('domainSelectDropdown');

        tbody.innerHTML = "";
        if (dropdown) dropdown.innerHTML = '<option value="">Select a domain</option>';

        if (domains.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">No domains found.</td></tr>';
            return;
        }

        domains.forEach(domain => {
            const tr = document.createElement('tr');
            const nsList = domain.name_servers ? domain.name_servers.map(ns => `<div>${ns}</div>`).join('') : 'None';
            const statusClass = domain.status === 'active' ? 'text-success' : 'text-warning';

            tr.innerHTML = `
                <td style="font-weight: 600;">${domain.name}</td>
                <td><span class="${statusClass}" style="text-transform: capitalize;">${domain.status}</span></td>
                <td class="ns-cell-list">${nsList}</td>
            `;
            tbody.appendChild(tr);

            if (dropdown) {
                const opt = document.createElement('option');
                opt.value = domain.id;
                opt.textContent = domain.name;
                // Store nameservers and status as data attributes
                opt.dataset.nameservers = JSON.stringify(domain.name_servers || []);
                opt.dataset.status = domain.status || 'unknown';
                dropdown.appendChild(opt);
            }
        });
    }

    async function setupCloudflare() {
        const domain = document.getElementById('configDomainCF').value;
        if (!domain) { showToast('warning', 'Please enter a domain'); return; }

        showToast('info', 'Setting up Cloudflare domain...');

        try {
            const response = await fetch('/api/simulationserver/config/cloudflare_setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain: domain })
            });

            if (!response.ok) {
                const text = await response.text();
                showToast('error', `Setup failed: ${text}`);
                return;
            }

            const data = await response.json();
            if (data.success) {
                showToast('success', 'Cloudflare setup completed');
                loadInfo(data.data);
                loadAllDomains();
            } else {
                showToast('error', data.message || 'Error setting up Cloudflare');
            }
        } catch (err) {
            console.error(err);
            showToast('error', 'Failed to connect');
        }
    }

    function loadInfo(data) {
        const statusInput = document.getElementById('nameserverStatus');

        let nameservers = [];
        if (data.ns1 && data.ns2) {
            nameservers = [
                data.ns1,
                data.ns2
            ];
        } else if (data.dns_records) {
            nameservers = data.dns_records;
        }

        renderNameservers(nameservers);

        if (data.status != "error" && data.status != "") {
            statusInput.value = data.status == "active" ? "active" : "pending"
        } else if (data.status == "error") {
            statusInput.value = "Please contact the domain owner to onboard the domain"
            showToast('error', "Please contact the domain owner to onboard the domain");
        } else {
            statusInput.value = ""
        }
    }

    function renderNameservers(nameservers) {
        const container = document.getElementById("nsContainer");
        container.innerHTML = "";

        nameservers.forEach(ns => {
            const box = document.createElement("div");
            box.className = "ns-box";

            box.innerHTML = `
            <span class="ns-value">${ns}</span>
            <a class="ns-copy" onclick="copyToClipboard('${ns}')">Click to copy</a>
        `;

            container.appendChild(box);
        });
    }
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('success', 'Copied!');
        });
    }

    async function loadDNSRecords() {
        const zoneId = document.getElementById('domainSelectDropdown').value;
        if (!zoneId) {
            document.getElementById('dnsRecordsSection').style.display = 'none';
            // Clear nameservers when no domain selected
            document.getElementById('nsContainer').innerHTML = '';
            document.getElementById('nameserverStatus').value = '';
            return;
        }

        // Update nameservers display for selected domain
        // updateNameserverDisplay(zoneId); // Removed to separate Onboard form from Selection

        showToast('info', 'Loading DNS records...');

        try {
            const response = await fetch('/api/simulationserver/config/fetch_dns_records?zone_id=' + zoneId);
            const data = await response.json();
            if (data.success) {
                renderDNSRecords(data.data || []);
                document.getElementById('dnsRecordsSection').style.display = 'block';
            } else {
                showToast('error', 'Failed to load DNS records');
            }
        } catch (err) {
            showToast('error', 'Failed to connect');
        }
    }
    async function refreshNameserverStatus() {
        const domain = document.getElementById('configDomainCF').value;
        if (!domain) {
            showToast('warning', 'Please enter a domain first');
            return;
        }

        showToast('info', 'Refreshing nameserver status...');

        try {
            const response = await fetch('/api/simulationserver/config/cloudflare_setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain: domain })
            });

            if (!response.ok) {
                const text = await response.text();
                showToast('error', `Refresh failed: ${text}`);
                return;
            }

            const data = await response.json();
            if (data.success) {
                loadInfo(data.data || {});
                showToast('success', 'Nameserver status updated');
            } else {
                showToast('error', data.message || 'Error refreshing status');
            }
        } catch (err) {
            showToast('error', 'Failed to refresh status');
        }
    }
    function updateNameserverDisplay(zoneId) {
        // Get the selected option from dropdown
        const dropdown = document.getElementById('domainSelectDropdown');
        const selectedOption = dropdown.options[dropdown.selectedIndex];


        if (selectedOption && selectedOption.dataset.nameservers) {
            // Parse nameservers from data attribute
            const nameservers = JSON.parse(selectedOption.dataset.nameservers);
            const status = selectedOption.dataset.status || 'unknown';

            // Render nameservers
            if (nameservers && nameservers.length > 0) {
                renderNameservers(nameservers);
            } else {
                document.getElementById('nsContainer').innerHTML = '<span class="text-muted">No nameservers found</span>';
            }
            // Update status
            document.getElementById('nameserverStatus').value = status;
        } else {
            document.getElementById('nsContainer').innerHTML = '<span class="text-muted">No data available</span>';
            document.getElementById('nameserverStatus').value = '';
        }
    }

    function renderDNSRecords(records) {
        const tbody = document.getElementById('dnsRecordsListBody');
        tbody.innerHTML = '';

        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No DNS records found.</td></tr>';
            return;
        }

        records.forEach(record => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><code>${record.type}</code></td>
                <td>${record.name}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${record.content}</td>
                <td class="text-center">
                    <button class="btn btn-danger btn-xs" onclick="deleteDNSRecord('${record.id}')" title="Delete">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function createDNSRecord() {
        const zoneId = document.getElementById('domainSelectDropdown').value;
        let name = document.getElementById('newSubdomainName').value.trim();
        const mainDomain = document.getElementById('domainSelectDropdown').options[document.getElementById('domainSelectDropdown').selectedIndex].text;
        const content = document.getElementById('newSubdomainIP').value.trim();

        name = name + '.' + mainDomain;

        if (!zoneId) {
            showToast('warning', 'Please select a domain first');
            return;
        }
        if (!name) {
            showToast('warning', 'Please enter a subdomain name');
            return;
        }
        if (!content) {
            showToast('warning', 'Please enter an IP address');
            return;
        }

        showToast('info', 'Creating DNS record...');

        try {
            const response = await fetch('/api/simulationserver/config/create_dns_record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    zone_id: zoneId,
                    type: 'A',
                    name: name,
                    content: content
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('success', 'DNS record created!');
                document.getElementById('newSubdomainName').value = '';
                document.getElementById('newSubdomainIP').value = '';
                loadDNSRecords();
            } else {
                showToast('error', data.message || 'Failed to create DNS record');
            }
        } catch (err) {
            showToast('error', 'Failed to connect');
        }
    }

    async function deleteDNSRecord(recordId) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then(async (result) => {
            if (result.isConfirmed) {
                const zoneId = document.getElementById('domainSelectDropdown').value;

                showToast('info', 'Deleting DNS record...');

                try {
                    const response = await fetch('/api/simulationserver/config/delete_dns_record?zone_id=' + zoneId + '&record_id=' + recordId, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast('success', 'DNS record deleted!');
                        loadDNSRecords();
                    } else {
                        showToast('error', data.message || 'Failed to delete DNS record');
                    }
                } catch (err) {
                    showToast('error', 'Failed to connect');
                }
            }
        });
    }
</script>
{{end}}