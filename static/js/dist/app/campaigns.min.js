var labels={"In progress":"label-primary",Queued:"label-info",Completed:"label-success","Emails Sent":"label-success",Error:"label-danger"},campaigns=[],campaign={},campaignType="";function switchCampaignType(e){campaignType=e;var a="All Campaigns";"email"==e?a="Email Campaigns":"qr"==e?a="QR Campaigns":"sms"==e&&(a="SMS Campaigns"),$("#page-header").text(a),$("#emptyMessageText").text("No "+(campaignType||"active")+" campaigns created yet. Let's create one!"),loadCampaigns()}function deleteCampaign(e,a){Swal.fire({title:"Are you sure?",text:"This will delete the campaign "+a+". This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(a,t){api.campaignId.delete(e).done((function(e){a(e)})).fail((function(e){var t="An error occurred";e.responseJSON&&e.responseJSON.message?t=e.responseJSON.message:e.responseText&&(t=e.responseText),Swal.showValidationMessage(t),a(!1)}))}))}}).then((function(e){e.value&&Swal.fire("Campaign Deleted!","This campaign has been deleted!","success").then((function(){location.reload()}))}))}function copy(e){location.href="/campaign?copy="+campaigns[e].id}function loadCampaigns(){$("#loading").show(),$("#campaignTable").hide(),$("#campaignTableArchive").hide(),$("#emptyMessage").hide(),api.campaigns.summary("?campaign_type="+campaignType).done((function(e){campaigns=e.campaigns||[],$("#loading").hide(),$.fn.DataTable.isDataTable("#campaignTable")&&$("#campaignTable").DataTable().destroy(),$.fn.DataTable.isDataTable("#campaignTableArchive")&&$("#campaignTableArchive").DataTable().destroy(),$("#campaignTable tbody").empty(),$("#campaignTableArchive tbody").empty(),campaigns&&campaigns.length>0?($("#campaignTable").show(),$("#campaignTableArchive").show(),activeCampaignsTable=$("#campaignTable").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"}],order:[[4,"desc"]]}),archivedCampaignsTable=$("#campaignTableArchive").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"}],order:[[3,"desc"]]}),rows={active:[],archived:[]},$.each(campaigns,(function(e,a){label=labels[a.status]||"label-default";var t="label-default";"email"==a.campaign_type?t="label-success":"qr"==a.campaign_type?t="label-primary":"sms"==a.campaign_type&&(t="label-info");var n=a.stats||{total:0,sent:0,opened:0,clicked:0,submitted_data:0,error:0,email_reported:0},i=(a.campaign_type||"email").toLowerCase();if(moment(a.launch_date).isAfter(moment()))var s="Scheduled to start: "+moment(a.launch_date).format("MMMM Do YYYY, h:mm:ss a")+"<br><br>Number of recipients: "+n.total;else s="Launch Date: "+moment(a.launch_date).format("MMMM Do YYYY, h:mm:ss a")+"<br><br>Number of recipients: "+n.total+"<br><br>"+("sms"==i?"SMS Sent: ":"Emails Sent: ")+n.sent+"<br><br>"+("sms"==i?"SMS Clicked: ":"Clicked: ")+n.clicked+"<br><br>Submitted Credentials: "+n.submitted_data+"<br><br>Errors : "+n.error+"<br><br>Reported : "+n.email_reported;var o=["<input type='checkbox' class='campaign-checkbox index-checkbox' value='"+a.id+"' data-status='"+a.status+"' data-name='"+escapeHtml(a.name)+"'>",escapeHtml(a.name),"<span class='label "+t+"'>"+(a.campaign_type||"EMAIL").toUpperCase()+"</span>",escapeHtml(a.created_by||""),moment(a.created_date).format("MMMM Do YYYY, h:mm:ss a"),'<span class="label '+label+'" data-toggle="tooltip" data-placement="right" data-html="true" title="'+s+'">'+a.status+"</span>","<div style='display: flex; justify-content: flex-end; white-space: nowrap; gap: 5px;'>                        <a class='btn btn-primary' href='/campaigns/"+a.id+"' data-toggle='tooltip' data-placement='left' title='View Results'>                            <i class='fa fa-bar-chart'></i>                        </a>                        <button class='btn btn-primary' onclick='copy("+e+")' data-toggle='tooltip' data-placement='left' title='Copy Campaign'>                            <i class='fa fa-copy'></i>                        </button>                        <button class='btn btn-danger' onclick='deleteCampaign("+a.id+', "'+escapeHtml(a.name).replace(/"/g,"&quot;")+"\")' data-toggle='tooltip' data-placement='left' title='Delete Campaign'>                            <i class='fa fa-trash-o'></i>                        </button>                    </div>"],l=["<input type='checkbox' class='campaign-checkbox archive-checkbox' value='"+a.id+"'>",escapeHtml(a.name),escapeHtml(a.created_by||""),moment(a.created_date).format("MMMM Do YYYY, h:mm:ss a"),'<span class="label '+label+'" data-toggle="tooltip" data-placement="right" data-html="true" title="'+s+'">'+a.status+"</span>",o[6]];"Completed"==a.status?rows.archived.push(l):rows.active.push(o)})),activeCampaignsTable.rows.add(rows.active).draw(),archivedCampaignsTable.rows.add(rows.archived).draw(),$('[data-toggle="tooltip"]').tooltip()):$("#emptyMessage").show()})).fail((function(){$("#loading").hide(),errorFlash("Error fetching campaigns")}))}function toggleSelectAll(e){if("active"===e){var a=$("#selectAllActive").is(":checked");$(".index-checkbox").prop("checked",a)}else{a=$("#selectAllArchived").is(":checked");$(".archive-checkbox").prop("checked",a)}}function getSelectedIds(){var e=[];return $(".campaign-checkbox:checked").each((function(){e.push($(this).val())})),e}function bulkDeleteSelected(){var e=getSelectedIds();0!==e.length?Swal.fire({title:"Delete "+e.length+" campaigns?",text:"This action cannot be undone!",type:"warning",showCancelButton:!0,confirmButtonText:"Delete",confirmButtonColor:"#d9534f",reverseButtons:!0}).then((function(a){if(a.value){Swal.fire({title:"Deleting...",allowOutsideClick:!1,onBeforeOpen:()=>{Swal.showLoading()}});var t=e.map((e=>api.campaignId.delete(e)));$.when.apply($,t).then((function(){Swal.fire("Deleted!","The selected campaigns have been removed.","success").then((()=>{location.reload()}))})).fail((function(){Swal.fire("Error","Some campaigns could not be deleted.","error").then((()=>{location.reload()}))}))}})):Swal.fire("No selection","Please select at least one campaign to delete.","info")}function bulkCompleteSelected(){var e=[];$(".index-checkbox:checked").each((function(){"Completed"!==$(this).data("status")&&e.push($(this).val())})),0!==e.length?Swal.fire({title:"Complete "+e.length+" campaigns?",text:"This will end the selected campaigns.",type:"question",showCancelButton:!0,confirmButtonText:"Complete",confirmButtonColor:"#5cb85c"}).then((function(a){if(a.value){Swal.fire({title:"Completing...",allowOutsideClick:!1,onBeforeOpen:()=>{Swal.showLoading()}});var t=e.map((e=>api.campaignId.complete(e)));$.when.apply($,t).then((function(){Swal.fire("Updated!","The selected campaigns have been completed.","success").then((()=>{location.reload()}))})).fail((function(){Swal.fire("Error","Some campaigns could not be updated.","error").then((()=>{location.reload()}))}))}})):Swal.fire("No selection","Please select at least one ongoing campaign to complete.","info")}function bulkActionAll(e,a){var t=campaigns.filter((a=>a.status===e));if(0!==t.length){var n="delete"===a?"Delete":"Complete",i="delete"===a?"This cannot be undone!":"This will end these campaigns.";Swal.fire({title:n+" all "+t.length+" "+("In progress"===e?"ongoing":"completed")+" campaigns?",text:i,type:"warning",showCancelButton:!0,confirmButtonText:n,confirmButtonColor:"delete"===a?"#d9534f":"#5cb85c"}).then((function(e){if(e.value){Swal.fire({title:"Processing...",allowOutsideClick:!1,onBeforeOpen:()=>{Swal.showLoading()}});var n=t.map((e=>"delete"===a?api.campaignId.delete(e.id):api.campaignId.complete(e.id)));$.when.apply($,n).then((function(){Swal.fire("Finished!","Action completed successfully.","success").then((()=>{location.reload()}))})).fail((function(){Swal.fire("Mixed Results","Some operations may have failed.","warning").then((()=>{location.reload()}))}))}}))}else Swal.fire("Nothing found","There are no campaigns with status: "+e,"info")}function startNewCampaign(){Swal.fire({title:"Checking Server Status",html:'<p style="margin-top: 15px; font-size: 14px;">Checking EC2 instance status...</p>',allowOutsideClick:!1,showConfirmButton:!1,onOpen:function(){Swal.showLoading(),$.ajax({url:"/api/simulationserver/ec2/status",method:"GET",success:function(e){var a=e.data&&e.data.state,t=e.data&&e.data.public_ip;"running"===a&&t?Swal.fire({title:"Server Ready!",text:"Simulation server is already running.",icon:"success",timer:1500,showConfirmButton:!1}).then((function(){location.href="/campaign"})):(Swal.close(),startEC2WithProgressBar())},error:function(){Swal.close(),startEC2WithProgressBar()}})}})}function startEC2WithProgressBar(){var e=0,a=[{percent:0,text:"Starting EC2 instance..."},{percent:20,text:"Instance initializing..."},{percent:35,text:"Loading modules..."},{percent:50,text:"Configuring server..."},{percent:65,text:"Setting up phishlets..."},{percent:80,text:"Waiting for SSH..."},{percent:90,text:"Starting simulation engine..."},{percent:100,text:"Ready!"}];Swal.fire({title:"Preparing Simulation Server",html:'<div class="progress" style="height: 25px; margin-top: 20px;"><div id="ec2-progress-bar" class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0%; font-size: 14px;">0%</div></div><p id="ec2-status-text" style="margin-top: 15px; font-size: 14px;">Starting EC2 instance...</p>',allowOutsideClick:!1,showConfirmButton:!1,onOpen:function(){var t=setInterval((function(){e<85&&((e+=5*Math.random())>85&&(e=85),updateEC2ProgressUI(e,a))}),500);$.ajax({url:"/api/simulationserver/ec2/start",method:"POST",contentType:"application/json",data:JSON.stringify({start_evil:!0}),timeout:3e5,success:function(e){clearInterval(t),animateEC2ProgressTo(100,a,(function(){Swal.close(),location.href="/campaign"}))},error:function(e){clearInterval(t),Swal.close();var a=e.responseJSON?e.responseJSON.message:"Failed to start EC2 instance";Swal.fire("Error",a,"error")}})}})}function updateEC2ProgressUI(e,a){var t=Math.round(e);$("#ec2-progress-bar").css("width",t+"%").text(t+"%");for(var n="Processing...",i=a.length-1;i>=0;i--)if(t>=a[i].percent){n=a[i].text;break}$("#ec2-status-text").text(n)}function animateEC2ProgressTo(e,a,t){var n=parseInt($("#ec2-progress-bar").css("width"))/$("#ec2-progress-bar").parent().width()*100||0,i=setInterval((function(){(n+=3)>=e?(n=e,clearInterval(i),updateEC2ProgressUI(n,a),setTimeout(t,500)):updateEC2ProgressUI(n,a)}),50)}$(document).ready((function(){campaignType="";-1!==window.location.pathname.indexOf("sms")?campaignType="sms":-1!==window.location.pathname.indexOf("qr")&&(campaignType="qr"),campaignType?$("#type_"+campaignType).parent().addClass("active").siblings().removeClass("active"):$("#type_all").parent().addClass("active").siblings().removeClass("active"),switchCampaignType(campaignType)}));