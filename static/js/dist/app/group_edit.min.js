var group={},groupId=window.location.pathname.split("/").pop();function save(){var e=$("#saveSubmit").data("bulk-token");if(e){var t={};return t.name=$("#name").val(),t.name?(groupId&&(t.group_id=parseInt(groupId)),t.file_token=e,t.group_type=$("#group_type").val(),void api.groups.bulk_import_confirm(t).done((function(e){e.success&&e.job_id?pollJob(e.job_id,e.group_id):modalError(e.message||"Failed to start import")})).fail((function(e){var t="Server error";e.responseJSON&&e.responseJSON.message&&(t=e.responseJSON.message),modalError(t)}))):void modalError("Group name is required")}var a=[];$.each($("#targetsTable").DataTable().rows().data(),(function(e,t){a.push({first_name:unescapeHtml(t[0]),last_name:unescapeHtml(t[1]),email:unescapeHtml(t[2]),position:unescapeHtml(t[3])})}));var r,o={name:$("#name").val(),group_type:$("#group_type").val(),targets:a};groupId?(o.id=parseInt(groupId),r=api.groupId.put(o)):r=api.groups.post(o),r.done((function(e){successFlash("Group saved successfully!"),setTimeout((function(){location.href="/groups"}),1e3)})).fail((function(e){modalError(e)}))}function addTarget(e,t,a,r){var o=escapeHtml(a).toLowerCase(),s=[escapeHtml(e),escapeHtml(t),o,escapeHtml(r),'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>'],i=$("#targetsTable").DataTable(),n=i.column(2,{order:"index"}).data().indexOf(o);n>=0?i.row(n,{order:"index"}).data(s):i.row.add(s)}("group"==groupId||"new"==groupId||isNaN(parseInt(groupId)))&&(groupId=null);var downloadCSVTemplate=function(){var e="group_template.csv",t=Papa.unparse([{"First Name":"Example","Last Name":"User",Email:"foobar@example.com",Position:"Systems Administrator"}],{}),a=new Blob([t],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,e);else{var r=window.URL.createObjectURL(a),o=document.createElement("a");o.href=r,o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)}};function pollJob(e,t){Swal.fire({title:"Importing Targets",html:'<div style="margin-bottom:10px;">Progress: <span id="job-percent" style="font-weight:bold; font-size:1.2em;">0%</span></div><div class="progress" style="margin-bottom:15px; height: 20px;">  <div id="job-bar" class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0%"></div></div><div style="margin-bottom:10px;">  Processed: <span id="job-processed">0</span> / <span id="job-total">?</span><br>  Status: <span id="job-status">Pending</span></div>',allowOutsideClick:!1,showConfirmButton:!0,confirmButtonText:'<i class="fa fa-external-link"></i> Run in Background',confirmButtonColor:"#3085d6",showCancelButton:!0,cancelButtonText:'<i class="fa fa-stop"></i> Cancel Import',cancelButtonColor:"#d33"}).then((t=>{t.value?window.location.href="/groups":t.dismiss===Swal.DismissReason.cancel&&$.ajax({url:"/api/import/job/"+e+"/cancel",type:"POST",success:function(){successFlash("Import cancellation requested")},error:function(){errorFlash("Failed to cancel import")}})}));var a=setInterval((function(){$.get("/api/import/job/"+e,(function(e){!Swal.isVisible()&&window.location.pathname.indexOf("/group");var t=parseInt(e.processed)||0,r=parseInt(e.total)||0,o=0;r>0&&(o=Math.round(t/r*100)),$("#job-processed").text(t.toLocaleString()),$("#job-total").text(r>0?r.toLocaleString():"?"),$("#job-status").text(e.status),$("#job-percent").text(o+"%"),$("#job-bar").css("width",o+"%"),"completed"===e.status?(clearInterval(a),Swal.isVisible()&&Swal.fire({title:"Import Complete",text:e.result,type:"success"}).then((()=>{window.location.href="/groups"}))):"failed"===e.status?(clearInterval(a),Swal.isVisible()&&Swal.fire({title:"Import Failed",text:e.errors?e.errors.join("\n"):"Unknown Error",type:"error"})):"cancelled"===e.status&&(clearInterval(a),Swal.isVisible()&&Swal.fire({title:"Import Cancelled",text:"The import process was stopped.",type:"warning"}))})).fail((function(){clearInterval(a),Swal.isVisible()&&Swal.fire("Error","Failed to poll job status","error")}))}),1e3)}function loadGroup(e){if(e){var t=$("#targetsTable").DataTable();api.groupId.get(e).done((function(e){group=e,$("#groupModalLabel").text("Edit Group: "+group.name),$("#name").val(group.name),$("#group_type").val(group.group_type||"email"),t.clear();var a=[];$.each(group.targets,(function(e,t){a.push([escapeHtml(t.first_name),escapeHtml(t.last_name),escapeHtml(t.email),escapeHtml(t.position),'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>'])})),t.rows.add(a).draw()})).fail((function(){errorFlash("Error fetching group")}))}}$(document).ready((function(){var e=$("#targetsTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]});$("#saveSubmit").click(save),$("#targetForm").submit((function(){var t=document.getElementById("targetForm");if(t.checkValidity())return addTarget($("#firstName").val(),$("#lastName").val(),$("#email").val(),$("#position").val()),e.draw(),$("#targetForm>div>input").val(""),$("#firstName").focus(),!1;t.reportValidity()})),$("#targetsTable").on("click","span>i.fa-trash-o",(function(){e.row($(this).parents("tr")).remove().draw()})),$("#csvupload").fileupload({url:"/api/import/group/bulk",dataType:"json",paramName:"file",formData:function(e){var t=e.serializeArray();return groupId&&t.push({name:"group_id",value:groupId}),t},add:function(e,t){$("#modal\\.flashes").empty();var a=t.originalFiles[0].name;if(a&&!/(csv|txt)$/i.test(a.split(".").pop()))return modalError("Unsupported file extension (use .csv or .txt)"),!1;$("#saveSubmit").removeData("bulk-token"),t.submit()},done:function(t,a){a.result.success&&a.result.file_token?($("#saveSubmit").data("bulk-token",a.result.file_token),e.clear().draw(),a.result.preview&&a.result.preview.length>0&&($.each(a.result.preview,(function(e,t){addTarget(t.first_name||"",t.last_name||"",t.email||"",t.position||"")})),e.draw()),Swal.fire({title:"Preview Loaded",text:"Showing first "+a.result.preview.length+" of "+a.result.total_count+' records. Click "Save Group" to finalize the import.',type:"info"})):modalError(a.result.message||"Unknown error during upload")},fail:function(e,t){modalError("Upload failed: "+(t.responseJSON?t.responseJSON.message:"Server error"))}}),$("#csv-template").click(downloadCSVTemplate),groupId&&loadGroup(groupId)}));