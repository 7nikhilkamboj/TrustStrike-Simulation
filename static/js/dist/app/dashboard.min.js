var campaigns=[],statuses={"Email Sent":{color:"#1abc9c",label:"label-success",icon:"fa-envelope",point:"ct-point-sent"},"Emails Sent":{color:"#1abc9c",label:"label-success",icon:"fa-envelope",point:"ct-point-sent"},"In progress":{label:"label-primary"},Queued:{label:"label-info"},Completed:{label:"label-success"},"Email Opened":{color:"#f9bf3b",label:"label-warning",icon:"fa-envelope",point:"ct-point-opened"},"Email Reported":{color:"#45d6ef",label:"label-warning",icon:"fa-bullhorne",point:"ct-point-reported"},"Clicked Link":{color:"#F39C12",label:"label-clicked",icon:"fa-mouse-pointer",point:"ct-point-clicked"},Success:{color:"#f05b4f",label:"label-danger",icon:"fa-exclamation",point:"ct-point-clicked"},Error:{color:"#6c7a89",label:"label-default",icon:"fa-times",point:"ct-point-error"},"Error Sending Email":{color:"#6c7a89",label:"label-default",icon:"fa-times",point:"ct-point-error"},"Submitted Data":{color:"#f05b4f",label:"label-danger",icon:"fa-exclamation",point:"ct-point-clicked"},Unknown:{color:"#6c7a89",label:"label-default",icon:"fa-question",point:"ct-point-error"},Sending:{color:"#428bca",label:"label-primary",icon:"fa-spinner",point:"ct-point-sending"},"Campaign Created":{label:"label-success",icon:"fa-rocket"},"SMS Sent":{color:"#1abc9c",label:"label-success",icon:"fa-comment",point:"ct-point-sent"}},statsMapping={sent:"Email Sent",opened:"Email Opened",clicked:"Clicked Link",submitted_data:"Submitted Data"};function deleteCampaign(e){Swal.fire({title:"Are you sure?",text:"Delete "+campaigns[e].name+"? This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonText:"Delete",cancelButtonText:"Cancel",confirmButtonClass:"btn btn-danger",cancelButtonClass:"btn btn-default",buttonsStyling:!1,customClass:{confirmButton:"btn btn-danger",cancelButton:"btn btn-default"},showLoaderOnConfirm:!0,preConfirm:function(){return new Promise((function(t,a){api.campaignId.delete(campaigns[e].id).done((function(e){t(e)})).fail((function(e){var a="An error occurred";e.responseJSON&&e.responseJSON.message?a=e.responseJSON.message:e.responseText&&(a=e.responseText),Swal.showValidationMessage(a),t(!1)}))}))},allowOutsideClick:!1}).then((function(e){e.value&&Swal.fire("Campaign Deleted!","This campaign has been deleted!","success").then((function(){location.reload()}))}))}function renderPieChart(e){return Highcharts.chart(e.elemId,{chart:{type:"pie",events:{load:function(){var t=this,a=t.renderer,n=t.series[0],l=t.plotLeft+n.center[0],s=t.plotTop+n.center[1];this.innerText=a.text(e.data[0].count,l,s).attr({"text-anchor":"middle","font-size":"16px","font-weight":"bold",fill:e.colors[0],"font-family":"Helvetica,Arial,sans-serif"}).add()},render:function(){this.innerText.attr({text:e.data[0].count})}}},title:{text:e.title},plotOptions:{pie:{innerSize:"80%",dataLabels:{enabled:!1}}},credits:{enabled:!1},tooltip:{formatter:function(){return null!=this.key&&'<span style="color:'+this.color+'">‚óè</span>'+this.point.name+": <b>"+this.y+"%</b><br/>"}},series:[{data:e.data,colors:e.colors}]})}function generateStatsPieCharts(e){var t=[],a={},n=0,l=$.extend({},statsMapping);"sms"===currentType&&(l.sent="SMS Sent"),$.each(e,(function(e,t){$.each(t.stats,(function(e,t){if("total"==e)return n+=t,!0;a[e]?a[e]+=t:a[e]=t}))})),$.each(a,(function(e,a){if(!(e in l))return!0;if(status_label=l[e],!status_label)return!0;var s="#dddddd";statuses[status_label]&&(s=statuses[status_label].color),t.push({name:status_label,y:Math.floor(a/n*100),count:a}),t.push({name:"",y:100-Math.floor(a/n*100)});renderPieChart({elemId:e+"_chart",title:status_label,name:e,data:t,colors:[s,"#dddddd"]});t=[]}))}function generateTimelineChart(e){var t=[];$.each(e,(function(e,a){var n=moment.utc(a.created_date).local();a.y=0,a.y+=a.stats.clicked,a.y=Math.floor(a.y/a.stats.total*100),t.push({campaign_id:a.id,name:a.name,x:n.valueOf(),y:a.y})})),Highcharts.chart("overview_chart",{chart:{zoomType:"x",type:"areaspline"},title:{text:"Phishing Success Overview"},xAxis:{type:"datetime",dateTimeLabelFormats:{second:"%l:%M:%S",minute:"%l:%M",hour:"%l:%M",day:"%b %d, %Y",week:"%b %d, %Y",month:"%b %Y"}},yAxis:{min:0,max:100,title:{text:"% of Success"}},tooltip:{formatter:function(){return Highcharts.dateFormat("%A, %b %d %l:%M:%S %P",new Date(this.x))+"<br>"+this.point.name+"<br>% Success: <b>"+this.y+"%</b>"}},legend:{enabled:!1},plotOptions:{series:{marker:{enabled:!0,symbol:"circle",radius:3},cursor:"pointer",point:{events:{click:function(e){window.location.href="/campaigns/"+this.campaign_id}}}}},credits:{enabled:!1},series:[{data:t,color:"#f05b4f",fillOpacity:.5}]})}var all_campaigns=[],currentType="";function switchCampaignType(e){currentType=e,renderDashboard()}function renderDashboard(){var e=all_campaigns.filter((function(e){return!currentType||(e.campaign_type||"email")===currentType}));if(0===e.length)$("#dashboard-charts").hide(),$("#dashboard-table").hide(),$("#emptyMessage").show(),$("#emptyMessage .alert").text("No "+(currentType||"active")+" campaigns created yet."),$("#dashboard-view").show();else{$("#emptyMessage").hide(),$("#dashboard-charts").show(),$("#dashboard-table").show(),$("#dashboard-view").show();var t=$("#campaignTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"},{className:"color-sent",targets:[4]},{className:"color-opened",targets:[5]},{className:"color-clicked",targets:[6]},{className:"color-success",targets:[7]}],order:[[3,"desc"]]});t.clear();var a=[];$.each(e,(function(e,t){var n=moment(t.created_date).format("MMMM Do YYYY, h:mm:ss a"),l=statuses[t.status].label||"label-default",s=t.stats||{total:0,opened:0,clicked:0,submitted_data:0,error:0,email_reported:0,sent:0};if(moment(t.launch_date).isAfter(moment()))var o="Scheduled to start: "+moment(t.launch_date).format("MMMM Do YYYY, h:mm:ss a")+"<br><br>Number of recipients: "+s.total;else o="Launch Date: "+moment(t.launch_date).format("MMMM Do YYYY, h:mm:ss a")+"<br><br>Number of recipients: "+s.total+"<br><br>Items opened: "+s.opened+"<br><br>Items clicked: "+s.clicked+"<br><br>Submitted Credentials: "+s.submitted_data+"<br><br>Errors : "+s.error;var i="",r=t.campaign_type||"email";i="email"===r?'<span class="label label-success">EMAIL</span>':"sms"===r?'<span class="label label-info">SMS</span>':"qr"===r?'<span class="label label-primary">QR</span>':'<span class="label label-default">UNKNOWN</span>',a.push([escapeHtml(t.name),i,escapeHtml(t.created_by||""),n,s.sent,s.opened,s.clicked,s.submitted_data,'<span class="label '+l+'" data-toggle="tooltip" data-placement="right" data-html="true" title="'+o+'">'+t.status+"</span>","<a class='btn btn-primary' href='/campaigns/"+t.id+"' data-toggle='tooltip' data-placement='left' title='View Results'>            <i class='fa fa-bar-chart'></i>            </a>            "+("true"===window.modifySystem?"<button class='btn btn-danger' onclick='deleteCampaign("+e+")' data-toggle='tooltip' data-placement='left' title='Delete Campaign'>            <i class='fa fa-trash-o'></i>            </button>":"")])})),t.rows.add(a).draw(),$('[data-toggle="tooltip"]').tooltip(),generateStatsPieCharts(e),generateTimelineChart(e),campaigns=e}}$(document).ready((function(){Highcharts.setOptions({global:{useUTC:!1}}),api.campaigns.summary().success((function(e){$("#loading").hide(),all_campaigns=e.campaigns,switchCampaignType("")})).error((function(){errorFlash("Error fetching campaigns")}))}));