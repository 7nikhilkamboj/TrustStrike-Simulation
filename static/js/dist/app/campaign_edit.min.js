var campaignId=window.location.pathname.split("/").pop();"campaign"==campaignId&&(campaignId=null);var cachedModalData=null,smtp_profiles=[],sms_profiles=[],groups=[],profileCurrentPage=1,profileItemsPerPage=6;function getFilteredProfiles(){return"sms"==$("#campaign_type").val()?sms_profiles:smtp_profiles}function toggleProfileSelection(e,t,a){var r=$("#profile"),o=$("#profile_name");r.val()!=e&&($("#profileTableBody tr").removeClass("success"),$("#profileTableBody .profile-check").removeClass("fa-check-circle-o").addClass("fa-circle-o"),r.val(e),o.val(t),a.addClass("success"),a.find(".profile-check").removeClass("fa-circle-o").addClass("fa-check-circle-o"))}function renderOptions(e){var t=$("#campaign_type").val(),a=$.grep(e.groups,(function(e){return"sms"==t?"sms"==e.group_type:"email"==e.group_type||"qr"==e.group_type||!e.group_type})),r=$.map(a,(function(e){return e.text=e.name,e.title=e.num_targets+" targets",e})),o=$("#users"),n=o.val();o.empty(),$.each(r,(function(e,t){o.append(new Option(t.text,t.text))})),n&&o.val(n);var i=$.grep(e.templates,(function(e){var a=e.type;return a||(a=(!e.html||0===e.html.length)&&e.text&&e.text.length>0?"sms":"email"),"sms"==t?"sms"==a:"email"==t?"email"==a:"qr"==t?"qr"==a:void 0}));$.fn.DataTable.isDataTable("#templateTable")&&$("#templateTable").DataTable().destroy(),currentTypeTemplates=i,renderTemplateGrid(i),updateProfileSelect()}function getTemplateById(e){return cachedModalData&&cachedModalData.templates?cachedModalData.templates.find((function(t){return t.id==e})):null}window.renderProfileTable=function(){var e=getFilteredProfiles(),t=$("#profileTableBody");t.empty();var a=$("#profileSearch").val().toLowerCase();if(e){var r=e.filter((function(e){return!a||e.name&&e.name.toLowerCase().indexOf(a)>-1}));if(0===r.length)return t.append('<tr><td colspan="6" class="text-center">No profiles found matching criteria.</td></tr>'),void $("#profilePagination").hide();var o=Math.ceil(r.length/profileItemsPerPage);profileCurrentPage>o&&(profileCurrentPage=1),profileCurrentPage<1&&(profileCurrentPage=1);var n=(profileCurrentPage-1)*profileItemsPerPage,i=n+profileItemsPerPage,l=r.slice(n,i),s=$("#profile").val();l.forEach((function(e){var a=$("<tr>");a.attr("id","profile-row-"+e.id),a.css("cursor","pointer");var r=s==e.id;r&&a.addClass("success"),a.click((function(t){$(t.target).closest("button").length||toggleProfileSelection(e.id,e.name,a)}));var o=r?"fa-check-circle-o":"fa-circle-o";a.append($("<td class='text-center'>").html(`<i class="fa ${o} profile-check"></i>`)),a.append($("<td>").text(e.name));var n=(e.interface_type||(e.host?"SMTP":"SMS")).toUpperCase(),i="SMS"===n?"label-info":"label-success";a.append($("<td class='text-center'>").html(`<span class="label ${i}" style="font-size: 11px;">${n}</span>`)),a.append($("<td>").text("admin"));var l=e.modified_date?moment(e.modified_date).format("MMMM Do YYYY, h:mm:ss a"):"-";a.append($("<td>").text(l));var d=$("<td class='text-right'>"),c=$('<button class="btn btn-success btn-xs" style="margin-right: 5px;"><i class="fa fa-pencil"></i></button>');c.click((function(t){t.stopPropagation(),editProfile(e.id,n)}));var p=$('<button class="btn btn-success btn-xs" style="margin-right: 5px;" title="Copy Profile"><i class="fa fa-copy"></i></button>');p.click((function(t){t.stopPropagation(),window.copyProfile(e.id,n)}));var m=$('<button class="btn btn-danger btn-xs"><i class="fa fa-trash"></i></button>');m.click((function(t){t.stopPropagation(),deleteProfile(e.id,n,e.name)})),d.append(c).append(p).append(m),a.append(d),t.append(a)})),renderPaginationControls("profilePagination",profileCurrentPage,o,"changeProfilePage")}else t.append('<tr><td colspan="6" class="text-center">No profiles found.</td></tr>')},window.changeProfilePage=function(e){profileCurrentPage=e,window.renderProfileTable()},window.updateProfileSelect=function(){window.renderProfileTable()},$("#profileSearch").on("keyup",(function(){profileCurrentPage=1,window.renderProfileTable()})),window.previewTemplateFull=function(e){window.event&&window.event.stopPropagation();var t=getTemplateById(e);if(t){var a="";a="sms"==t.type||(!t.html||0===t.html.length)&&t.text?"<pre style='text-align: left; white-space: pre-wrap;'>"+escapeHtml(t.text||"")+"</pre>":t.html||"";var r="data:text/html;base64,"+btoa(unescape(encodeURIComponent(a)));Swal.fire({title:"Preview: "+escapeHtml(t.name),html:'<div style="height: 500px; overflow: auto; border: 1px solid #ddd; background: #fff;"><iframe src="'+r+'" sandbox="allow-same-origin" style="width: 100%; height: 100%; border: none;"></iframe></div>',width:800,showCloseButton:!0,showConfirmButton:!1})}},window.editTemplate=function(e){var t=getTemplateById(e);if(t){$("#createTemplateModalLabel").text("Edit Template"),window.currentEditingTemplateId=e;var a=t.type||"email";if($("#modal_template_name").val(t.name),$("#modal_template_type").val(a).trigger("change"),"sms"==a)$("#modal_sms_editor").val(t.text||"");else{$("#modal_subject").val(t.subject||""),$("#modal_envelope_sender").val(t.envelope_sender||"");var r=t.html||"";$("#modal_html_editor").val(r),CKEDITOR.instances.modal_html_editor&&CKEDITOR.instances.modal_html_editor.setData(r),$("#modal_text_editor").val(t.text||"")}$("#createTemplateModal").modal("show"),window.event&&window.event.stopPropagation()}},window.copyTemplate=function(e){var t=getTemplateById(e);if(t){if($("#createTemplateModalLabel").text("New Template (Copy)"),$("#modal_template_name").val(t.name+" (Copy)"),updateTemplateModalUI(t.type||"email"),"sms"==t.type)$("#modal_sms_editor").val(t.text||"");else{$("#modal_subject").val(t.subject||""),$("#modal_envelope_sender").val(t.envelope_sender||"");var a=t.html||"";$("#modal_html_editor").val(a),CKEDITOR.instances.modal_html_editor?CKEDITOR.instances.modal_html_editor.setData(a):$("#modal_html_editor").ckeditor(),$("#modal_text_editor").val(t.text||"")}window.currentEditingTemplateId=null,$("#createTemplateModal").modal("show"),window.event&&window.event.stopPropagation()}},window.deleteTemplate=function(e){window.event&&window.event.stopPropagation();var t=getTemplateById(e);t&&Swal.fire({title:"Are you sure?",text:"Delete template '"+t.name+"'?",type:"warning",showCancelButton:!0,confirmButtonColor:"#d9534f",confirmButtonText:"Delete",reverseButtons:!0}).then((function(t){t.value&&api.templateId.delete(e).done((function(){setupOptions(!0).then((function(){successFlash("Template deleted.")}))})).fail((function(){errorFlash("Failed to delete template.")}))}))},window.selectTemplateCard=function(e){var t=getTemplateById(e);t&&($(".template-card").removeClass("selected"),$("#card-"+e).addClass("selected"),$("#template").val(e),$("#template_name").val(t.name))},window.openCreateTemplateModal=function(){$("#createTemplateModalLabel").text("New Template"),window.currentEditingTemplateId=null,$("#modal_template_name").val(""),$("#modal_subject").val(""),$("#modal_envelope_sender").val(""),CKEDITOR.instances.modal_html_editor&&CKEDITOR.instances.modal_html_editor.setData(""),$("#modal_text_editor").val(""),$("#modal_sms_editor").val("");var e=$("#campaign_type").val();updateTemplateModalUI(e),$("#createTemplateModal").modal("show")};var gridCurrentPage=1,gridItemsPerPage=6,currentGridTemplates=[],currentTypeTemplates=[];function filterAndRenderGrid(e){currentGridTemplates=e?currentTypeTemplates.filter((function(t){var a=t.name.toLowerCase().indexOf(e)>-1,r=(t.type||"").toLowerCase().indexOf(e)>-1;return a||r})):currentTypeTemplates,gridCurrentPage=1,renderTemplateGrid(currentGridTemplates)}function renderTemplateGrid(e){currentGridTemplates=e;var t=Math.ceil(e.length/gridItemsPerPage);gridCurrentPage>t&&(gridCurrentPage=1),gridCurrentPage<1&&(gridCurrentPage=1);var a=(gridCurrentPage-1)*gridItemsPerPage,r=a+gridItemsPerPage,o=e.slice(a,r),n=$("#templateGrid");if(n.empty(),0===e.length)return $("#noTemplatesMessage").show(),void $("#gridPagination").hide();$("#noTemplatesMessage").hide(),o.forEach((function(e){var t="";"sms"==e.type||(!e.html||0===e.html.length)&&e.text?t='<div class="text-preview">'+escapeHtml(e.text||"")+"</div>":t='<iframe srcdoc="'+(e.html||"").replace(/"/g,"&quot;")+'" sandbox></iframe>';var a=e.type?e.type.toUpperCase():"EMAIL",r="btn-success";"SMS"===a&&(r="btn-info"),"QR"===a&&(r="btn-primary");var o=`\n        <div class="col-md-4 col-sm-6">\n            <div class="template-card" id="card-${e.id}" onclick="selectTemplateCard(${e.id})">\n                 <div class="template-header">\n                    <div class="template-name" title="${escapeHtml(e.name)}">${escapeHtml(e.name)}</div>\n                     <div class="template-type">\n                        <button class="btn ${r} btn-xs" onclick="previewTemplateFull(${e.id}); event.stopPropagation();" title="Full Preview" style="padding: 4px 8px; font-size: 14px; font-weight: bold; border-width: 2px;">\n                            FULL PREVIEW\n                        </button>\n                     </div>\n                </div>\n                <div class="template-preview">\n                    ${t}\n                </div>\n                 <div class="template-footer">\n                     <div class="template-actions">\n                        <button class="btn btn-default btn-sm btn-action" onclick="editTemplate(${e.id})" title="Edit">\n                            <i class="fa fa-pencil"></i>\n                        </button>\n                        <button class="btn btn-default btn-sm btn-action" onclick="copyTemplate(${e.id})" title="Copy">\n                            <i class="fa fa-copy"></i>\n                        </button>\n                        <button class="btn btn-danger btn-sm btn-action-delete" onclick="deleteTemplate(${e.id})" title="Delete">\n                             <i class="fa fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        `;n.append(o)})),renderPaginationControls(t);var i=$("#template").val();i&&(o.find((function(e){return e.id==i}))&&$("#card-"+i).addClass("selected"))}function renderPaginationControls(e,t,a,r){if(1===arguments.length){var o=e;if(o<=1)return void $("#gridPagination").hide();var n='<ul class="pagination" style="margin: 0;">';n+='<li class="'+(1===gridCurrentPage?"disabled":"")+'"><a href="#" onclick="changeGridPage('+(gridCurrentPage-1)+'); return false;">&laquo;</a></li>';for(var i=1;i<=o;i++){n+='<li class="'+(i===gridCurrentPage?"active":"")+'"><a href="#" onclick="changeGridPage('+i+'); return false;">'+i+"</a></li>"}return n+='<li class="'+(gridCurrentPage===o?"disabled":"")+'"><a href="#" onclick="changeGridPage('+(gridCurrentPage+1)+'); return false;">&raquo;</a></li>',n+="</ul>",void $("#gridPagination").html(n).show()}if(a<=1)$("#"+e).empty().hide();else{n='<ul class="pagination" style="margin: 0;">';n+='<li class="'+(1===t?"disabled":"")+'"><a href="#" onclick="'+r+"("+(t-1)+'); return false;">&laquo;</a></li>';for(i=1;i<=a;i++){n+='<li class="'+(i===t?"active":"")+'"><a href="#" onclick="'+r+"("+i+'); return false;">'+i+"</a></li>"}n+='<li class="'+(t===a?"disabled":"")+'"><a href="#" onclick="'+r+"("+(t+1)+'); return false;">&raquo;</a></li>',n+="</ul>",$("#"+e).html(n).show()}}$(document).off("keyup","#templateSearch").on("keyup","#templateSearch",(function(){filterAndRenderGrid($(this).val().toLowerCase())})),window.changeGridPage=function(e){var t=Math.ceil(currentGridTemplates.length/gridItemsPerPage);e<1||e>t||(gridCurrentPage=e,renderTemplateGrid(currentGridTemplates))};var currentStep=1,totalSteps=9;function showStep(e){$(".wizard-step").removeClass("active"),$("#step"+e).addClass("active"),1==e?$("#prevBtn").hide():$("#prevBtn").show(),e==totalSteps?($("#nextBtn").hide(),$("#launchButton").show()):($("#nextBtn").show(),$("#launchButton").hide()),currentStep=e,5==e&&refreshLuresForStep5(),window.scrollTo(0,0),$(".modal-body").length&&$(".modal-body").scrollTop(0)}function refreshLuresForStep5(){loadModules(),"function"==typeof refreshLures&&refreshLures()}function validateStep(e){if(1==e&&""==$("#name").val().trim())return errorFlash("Please enter a campaign name."),!1;if(2==e&&""==$("#template").val())return errorFlash("Please select a template."),!1;if(3==e&&$("#useRedirector").is(":checked")){if(""==$("#redirectorDomain").val())return errorFlash("Please select a Redirector Domain."),!1;if(""==$("#redirectorTemplate").val())return errorFlash("Please select a Redirector Template."),!1}if(4==e){if(window.skipPhishletStep)return!0;if(""==$("#phishletSelect").val())return errorFlash("Please select a Phishlet."),!1;if(""==$("#phishletHostname").val())return errorFlash("Please select a Phishlet Hostname."),!1}if(5==e){if(!window.skipPhishletStep&&""==$("#selectedLureId").val())return errorFlash("No lure found. Please select a phishlet in Step 4."),!1;if(""==$("#lureFinalDestination").val())return errorFlash("Enter the final destination URL"),!1}if(6==e){var t=$("#users").val();if(!t||0===t.length)return errorFlash("Please select at least one group."),!1}return 7!=e||""!=$("#profile").val()||(errorFlash("Please select a Sending Profile."),!1)}async function setupOptions(e){if(cachedModalData&&!e)return renderOptions(cachedModalData),Promise.resolve();var t=await getStrikes();return $.when(api.groups.summary(),api.templates.get(),api.SMTP.get(),api.SMS.get()).done((function(e,a,r,o){cachedModalData={groups:e[0].groups,templates:a[0],smtp:r[0],sms:o[0],strikes:t.success?t.data:[]},groups=cachedModalData.groups,smtp_profiles=cachedModalData.smtp,sms_profiles=cachedModalData.sms,renderOptions(cachedModalData),window.renderGroupTable(cachedModalData.groups),renderLureTable(cachedModalData.strikes),pendingCampaignData&&(populateCampaignData(pendingCampaignData),pendingCampaignData=null)})).fail((function(){errorFlash("Failed to load options!")}))}async function getStrikes(){return $.get("/api/simulationserver/get_strikes").then((function(e){return e&&e.success?e:[]}),(function(){return[]}))}function generateQR(e){$("#qrcode").empty();var t=parseInt($("#qr_size").val())||160;e&&new QRCode(document.getElementById("qrcode"),{text:e,width:t,height:t,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}window.currentStep=currentStep,window.nextStep=function(){if($("#flashes").empty(),currentStep<totalSteps){if(!validateStep(currentStep))return;var e=currentStep+1;window.skipPhishletStep&&3===currentStep&&(e=5),showStep(e)}},window.prevStep=function(){if($("#flashes").empty(),currentStep>1){var e=currentStep-1;window.skipPhishletStep&&5===currentStep&&(e=3),showStep(e)}},window.toggleRedirectorOptions=function(){var e=$("#useRedirector").is(":checked"),t=$("#redirectorStatus"),a=$("#flowCaptionText");if(e){$("#redirectorOptions").css({opacity:"1","pointer-events":"auto"}),$("#redirectorTemplatePanel").css({opacity:"1","pointer-events":"auto"}),t.text("Enabled").css("color","#5cb85c"),$(".flow-bypass-arrow").addClass("hidden").hide(),$(".flow-redirector-item").addClass("visible").show();var r=$("#campaign_type").val()||"Email";a.html('<span style="color: #5cb85c;"><i class="fa fa-check-circle"></i></span> With Redirector: '+r.toUpperCase()+" → Template → <strong>Redirector</strong> → Login → Final Redirect")}else{$("#redirectorOptions").css({opacity:"0.4","pointer-events":"none"}),$("#redirectorTemplatePanel").css({opacity:"0.4","pointer-events":"none"}),t.text("Disabled").css("color","#999"),$(".flow-bypass-arrow").removeClass("hidden").show(),$(".flow-redirector-item").removeClass("visible").hide();r=$("#campaign_type").val()||"Email";a.text("Direct flow: "+r.toUpperCase()+" → Template → Login → Final Redirect")}},window.updateFlowDiagram=function(){var e=$("#campaign_type").val()||"email",t=$("#template_name").val()||"Select...";$("#flowCampaignType").text(e.toUpperCase());var a=t;a.length>10&&(a=a.substring(0,8)+"..."),$("#flowTemplateName").text(a||"Select...");var r="fa-envelope";"sms"===e&&(r="fa-commenting"),"qr"===e&&(r="fa-qrcode"),$(".flow-box.email-template i").attr("class","fa "+r)};var allDomains=[],currentDomainPage=1,domainSearchQuery="",selectedDomain=null;const DOMAINS_PER_PAGE=10;function loadCloudflaireDomains(){$.ajax({url:"/api/simulationserver/config/fetch_alldomains",method:"GET",success:function(e){var t=e.data||e.domains||e||[];allDomains=Array.isArray(t)?t:[];var a=$("#redirectorDomain");a.find("option:not(:first)").remove();var r=$("#phishletHostname");r.find("option:not(:first)").remove(),allDomains.forEach((function(e){var t=e.name||e;a.append($("<option>").val(t).text(t)),r.append($("<option>").val(t).text(t))})),renderDomainList(1)},error:function(e){console.error("Failed to load Cloudflare domains:",e.responseText),$("#domainList").html('<div class="text-center text-danger" style="padding: 20px;"><p>Failed to load domains. Please check your Cloudflare configuration.</p></div>')}})}function renderDomainList(e,t){currentDomainPage=e||1,domainSearchQuery=t||"";var a=$("#domainList"),r=$("#domainPagination");a.empty();var o=allDomains.filter((function(e){return-1!==(e.name||e).toLowerCase().indexOf(domainSearchQuery.toLowerCase())}));if(0===o.length)return a.html('<div class="text-center text-muted" style="padding: 20px;"><i class="fa fa-info-circle"></i> <p>No domains found matching "'+domainSearchQuery+'"</p></div>'),void r.hide();var n=Math.ceil(o.length/10),i=10*(currentDomainPage-1),l=i+10;o.slice(i,l).forEach((function(e){var t=e.name||e,r=`\n        <div class="domain-item${selectedDomain===t?" active":""}" data-name="${t}">\n            <span><i class="fa fa-globe" style="margin-right: 10px; color: #11998e;"></i> ${t}</span>\n            <span class="domain-status">${e.status||"Active"}</span>\n        </div>`;a.append(r)})),r.show(),$("#domainPageInfo").text(`Page ${currentDomainPage} of ${n}`),$("#prevDomainPage").prop("disabled",1===currentDomainPage),$("#nextDomainPage").prop("disabled",currentDomainPage===n)}$(document).on("input","#domainSearch",(function(){renderDomainList(1,$(this).val())})),$(document).on("click","#prevDomainPage",(function(){currentDomainPage>1&&renderDomainList(currentDomainPage-1,domainSearchQuery)})),$(document).on("click","#nextDomainPage",(function(){var e=allDomains.filter((function(e){return-1!==(e.name||e).toLowerCase().indexOf(domainSearchQuery.toLowerCase())})).length,t=Math.ceil(e/10);currentDomainPage<t&&renderDomainList(currentDomainPage+1,domainSearchQuery)})),$(document).on("click",".domain-item",(function(){var e=$(this).data("name");selectedDomain=e,$(".domain-item").removeClass("active"),$(this).addClass("active"),$("#phishletHostname").val(e).trigger("change")}));var allRedirectorTemplates=[],selectedRedirectorTemplate=null;function loadRedirectorTemplates(){$.ajax({url:"/api/simulationserver/redirectors",method:"GET",success:function(e){var t=e.redirectors||e||[];renderRedirectorTemplateCards(allRedirectorTemplates=Array.isArray(t)?t:[])},error:function(){console.error("Failed to load redirector templates"),$("#redirectorTemplateCards").html('<div class="col-md-12 text-center text-muted"><p>Failed to load templates</p></div>')}})}function renderRedirectorTemplateCards(e){var t=$("#redirectorTemplateCards");t.empty(),e&&0!==e.length?(e.forEach((function(e){var a=e.name||e,r="";e.html_escaped&&(r=e.html_escaped);var o=(r||"").replace(/"/g,"&quot;"),n=`\n        <div class="col-md-4 col-sm-6">\n            <div class="template-card redirector-template-card${selectedRedirectorTemplate===a?" selected":""}" data-name="${a}">\n                 <div class="template-header">\n                    <div class="template-name" title="${a}">${a}</div>\n                     <div class="template-type">\n                        <button class="btn btn-success btn-xs preview-redirector-btn" data-name="${a}" onclick="event.stopPropagation();" title="Full Preview" style="padding: 4px 8px; font-size: 14px; font-weight: bold; border-width: 2px;">\n                            FULL PREVIEW\n                        </button>\n                     </div>\n                </div>\n                <div class="template-preview">\n                    <iframe srcdoc="${o}" sandbox></iframe>\n                </div>\n                 <div class="template-footer">\n                     <div class="template-actions">\n                        <button class="btn btn-default btn-sm btn-action edit-redirector-btn" data-name="${a}" onclick="event.stopPropagation();" title="Edit">\n                            <i class="fa fa-pencil"></i>\n                        </button>\n                        <button class="btn btn-default btn-sm btn-action copy-redirector-btn" data-name="${a}" onclick="event.stopPropagation();" title="Copy">\n                            <i class="fa fa-copy"></i>\n                        </button>\n                        <button class="btn btn-danger btn-sm btn-action-delete delete-redirector-btn" data-name="${a}" onclick="event.stopPropagation();" title="Delete">\n                             <i class="fa fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        `;t.append(n)})),$(".redirector-template-card").on("click",(function(e){$(e.target).hasClass("btn")||$(e.target).parent().hasClass("btn")||$(e.target).hasClass("fa")||selectRedirectorTemplate($(this).data("name"))})),$(".preview-redirector-btn").on("click",(function(e){e.stopPropagation(),previewRedirectorTemplate($(this).data("name"))})),$(".edit-redirector-btn").on("click",(function(e){e.stopPropagation();var t=$(this).data("name");openRedirectorModal("edit",t)})),$(".copy-redirector-btn").on("click",(function(e){e.stopPropagation();var t=$(this).data("name");openRedirectorModal("copy",t)})),$(".delete-redirector-btn").on("click",(function(e){e.stopPropagation();var t=$(this).data("name");Swal.fire({title:"Delete Redirector?",text:"Are you sure you want to delete '"+t+"'?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d9534f",confirmButtonText:"Delete"}).then((function(e){e.value&&$.ajax({url:"/api/simulationserver/redirectors/"+encodeURIComponent(t),method:"DELETE",success:function(){Swal.fire("Deleted!","Redirector template deleted.","success"),loadRedirectorTemplates()},error:function(){Swal.fire("Error","Failed to delete redirector template.","error")}})}))}))):t.html('<div class="col-md-12 text-center text-muted" style="padding: 40px;"><i class="fa fa-inbox fa-3x"></i><p>No redirector templates found</p></div>')}function selectRedirectorTemplate(e){selectedRedirectorTemplate=e,$("#redirectorTemplate").val(e),renderRedirectorTemplateCards(allRedirectorTemplates)}function previewRedirectorTemplate(e){var t=allRedirectorTemplates.find((function(t){return(t.name||t)===e}));if(t){var a="";if(t.html_base64)try{a=atob(t.html_base64)}catch(e){}else t.html&&(a=t.html);var r="data:text/html;base64,"+btoa(unescape(encodeURIComponent(a)));Swal.fire({title:"Preview: "+escapeHtml(e),html:'<div style="height: 500px; overflow: auto; border: 1px solid #ddd; background: #fff;"><iframe src="'+r+'" sandbox="allow-same-origin" style="width: 100%; height: 100%; border: none;"></iframe></div>',width:800,showCloseButton:!0,showConfirmButton:!1})}}var currentRedirectorAssets=[];function renderRedirectorAssets(e){var t=$("#redirectorAssetsContainer");if(t.empty(),e&&0!==e.length){$("#redirectorAssetsSection").show();var a='<div class="row" style="margin: 0;">';e.forEach((function(e,t){var r=/\.(png|jpg|jpeg|gif|svg|ico|webp)$/i.test(e.name),o="application/octet-stream";e.name.endsWith(".svg")?o="image/svg+xml":e.name.endsWith(".png")?o="image/png":e.name.endsWith(".ico")?o="image/x-icon":e.name.endsWith(".jpg")||e.name.endsWith(".jpeg")?o="image/jpeg":e.name.endsWith(".gif")?o="image/gif":e.name.endsWith(".webp")&&(o="image/webp"),a+='<div class="col-xs-4 col-sm-3" style="padding: 5px; text-align: center;">',a+='<div style="border: 1px solid #ddd; border-radius: 4px; padding: 5px; background: #fff; min-height: 80px;">',r?(a+='<img src="data:'+o+";base64,"+e.base64+'" ',a+='style="max-width: 48px; max-height: 48px; margin-bottom: 5px;" alt="'+e.name+'" />'):a+='<i class="fa fa-file-o" style="font-size: 32px; color: #666; margin-bottom: 5px;"></i>',a+='<div style="font-size: 10px; word-break: break-all; color: #666;" title="'+e.name+'">'+e.name+"</div>",a+='<div style="font-size: 9px; color: #999;">'+formatAssetSize(e.base64)+"</div>",a+="</div></div>"})),a+="</div>",t.html(a)}else $("#redirectorAssetsSection").hide()}function formatAssetSize(e){if(!e)return"0 B";var t=Math.round(3*e.length/4);return t<1024?t+" B":t<1048576?(t/1024).toFixed(1)+" KB":(t/1048576).toFixed(1)+" MB"}window.openRedirectorModal=function(e,t){if($("#redirectorModalMode").val(e),$("#redirectorModalOriginalName").val(t||""),$("#redirectorAssetsSection").hide(),$("#redirectorAssetsContainer").empty(),currentRedirectorAssets=[],"create"===e)$("#redirectorModalLabel").text("New Redirector Template"),$("#redirectorModalName").val(""),$("#redirectorModalHtml").val(""),$("#redirectorModalPreview").attr("srcdoc","");else if("edit"===e||"copy"===e){var a=allRedirectorTemplates.find((function(e){return(e.name||e)===t}));if(!a)return void Swal.fire("Error","Template not found","error");var r="";if(a.html_base64)try{r=atob(a.html_base64)}catch(e){}else a.html&&(r=a.html);"edit"===e?($("#redirectorModalLabel").text("Edit Redirector: "+t),$("#redirectorModalName").val(t)):($("#redirectorModalLabel").text("Copy Redirector: "+t),$("#redirectorModalName").val(t+"_copy")),$("#redirectorModalHtml").val(r),a.assets&&a.assets.length>0&&(currentRedirectorAssets=a.assets,renderRedirectorAssets(a.assets))}$("#redirectorModal").modal("show")},$("#redirectorModal").on("shown.bs.modal",(function(){CKEDITOR.instances.redirectorModalHtml?CKEDITOR.instances.redirectorModalHtml.setData($("#redirectorModalHtml").val()):CKEDITOR.replace("redirectorModalHtml",{height:300,allowedContent:!0,extraAllowedContent:"*(*);*{*}",fullPage:!0,removeButtons:"",toolbar:[{name:"document",items:["Source"]},{name:"clipboard",items:["Cut","Copy","Paste","PasteText","PasteFromWord","-","Undo","Redo"]},{name:"editing",items:["Find","Replace","-","SelectAll"]},"/",{name:"basicstyles",items:["Bold","Italic","Underline","Strike","Subscript","Superscript","-","RemoveFormat"]},{name:"paragraph",items:["NumberedList","BulletedList","-","Outdent","Indent","-","Blockquote","CreateDiv","-","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"links",items:["Link","Unlink","Anchor"]},{name:"insert",items:["Image","Table","HorizontalRule","SpecialChar"]},"/",{name:"styles",items:["Styles","Format","Font","FontSize"]},{name:"colors",items:["TextColor","BGColor"]},{name:"tools",items:["Maximize","ShowBlocks"]}]}),setTimeout((function(){updateRedirectorPreview()}),100)})),$("#redirectorModal").on("hidden.bs.modal",(function(){CKEDITOR.instances.redirectorModalHtml&&CKEDITOR.instances.redirectorModalHtml.destroy()})),window.updateRedirectorPreview=function(){var e="";e=CKEDITOR.instances.redirectorModalHtml?CKEDITOR.instances.redirectorModalHtml.getData():$("#redirectorModalHtml").val(),currentRedirectorAssets&&currentRedirectorAssets.length>0&&currentRedirectorAssets.forEach((function(t){var a="application/octet-stream";t.name.endsWith(".svg")?a="image/svg+xml":t.name.endsWith(".png")?a="image/png":t.name.endsWith(".ico")?a="image/x-icon":t.name.endsWith(".jpg")||t.name.endsWith(".jpeg")?a="image/jpeg":t.name.endsWith(".gif")?a="image/gif":t.name.endsWith(".webp")&&(a="image/webp");var r="data:"+a+";base64,"+t.base64,o=new RegExp("([(\"'])"+t.name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"([(\"'])","g");e=e.replace(o,"$1"+r+"$2")})),$("#redirectorModalPreview").attr("srcdoc",e)},window.saveRedirectorModal=function(){var e=$("#redirectorModalMode").val(),t=$("#redirectorModalOriginalName").val(),a=$("#redirectorModalName").val().trim(),r="";if(r=CKEDITOR.instances.redirectorModalHtml?CKEDITOR.instances.redirectorModalHtml.getData():$("#redirectorModalHtml").val(),a)if(r){var o="edit"===e?"PUT":"POST",n="edit"===e?"/api/simulationserver/redirectors/"+encodeURIComponent(t):"/api/simulationserver/redirectors";$.ajax({url:n,method:o,contentType:"application/json",data:JSON.stringify({name:a,html:r}),success:function(){$("#redirectorModal").modal("hide"),Swal.fire("Success","Redirector template saved!","success"),loadRedirectorTemplates()},error:function(e){var t=e.responseJSON?e.responseJSON.message:"Failed to save redirector template";Swal.fire("Error",t,"error")}})}else Swal.fire("Error","Please enter HTML content","error");else Swal.fire("Error","Please enter a template name","error")},$(document).on("keyup","#redirectorTemplateSearch",(function(){var e=$(this).val().toLowerCase();renderRedirectorTemplateCards(allRedirectorTemplates.filter((function(t){return-1!==(t.name||t).toLowerCase().indexOf(e)})))}));var allPhishlets=[],selectedPhishlet=null;function loadPhishlets(){$.ajax({url:"/api/phishlets",method:"GET",success:function(e){var t=e.phishlets||e||[];allPhishlets=Array.isArray(t)?t:[];var a=$("#phishletSelect");a.find("option:not(:first)").remove(),allPhishlets.forEach((function(e){var t=e.name||e;a.append($("<option>").val(t).text(t))})),renderPhishletCards(allPhishlets)},error:function(){console.error("Failed to load phishlets"),$("#phishletCards").html('<div class="col-md-12 text-center text-muted"><p>Failed to load phishlets</p></div>')}})}function renderPhishletCards(e){var t=$("#phishletCards");t.empty(),e&&0!==e.length?e.forEach((function(e){var a=e.name||e,r=selectedPhishlet===a?" selected":"",o="fa-shield",n="",i=a.toLowerCase(),l="/images/phishlets/"+i+".png";-1!==i.indexOf("google")||-1!==i.indexOf("gmail")?(o="fa-google",n=" brand-google",l="/images/phishlets/google_preview.png"):-1!==i.indexOf("microsoft")||-1!==i.indexOf("o365")||-1!==i.indexOf("outlook")?(o="fa-windows",n=" brand-microsoft",l="/images/phishlets/ms_office.png"):-1!==i.indexOf("linkedin")?(o="fa-linkedin",n=" brand-linkedin",l="/images/phishlets/linkedin_preview.png"):-1!==i.indexOf("github")||-1!==i.indexOf("git")?(o="fa-github",n=" brand-github",l="/images/phishlets/github.png"):-1!==i.indexOf("amazon")?(o="fa-amazon",n=" brand-amazon"):-1!==i.indexOf("reddit")?(o="fa-reddit",n=" brand-reddit",l="/images/phishlets/reddit.png"):-1!==i.indexOf("facebook")?(o="fa-facebook",n=" brand-facebook"):-1!==i.indexOf("twitter")?(o="fa-twitter",n=" brand-twitter"):-1!==i.indexOf("apple")&&(o="fa-apple",n=" brand-apple");var s=`\n        <div class="col-md-3 col-sm-4 mb-4">\n            <div class="phishlet-card${r}" data-name="${a}">\n                <div class="phishlet-preview-container">\n                    <img src="${l}" class="phishlet-preview-img" alt="${a} preview" \n                    onerror="if (!this.dataset.fallback) { this.dataset.fallback = true; this.src='/images/phishlets/generic_preview.png'; }">\n                </div>\n                <div class="phishlet-card-content">\n                    <i class="fa ${o} phishlet-icon${n}"></i>\n                    <div class="phishlet-name" title="${a}">${a}</div>\n                </div>\n            </div>\n        </div>`;t.append(s)})):t.html('<div class="col-md-12 text-center text-muted" style="padding: 40px;"><i class="fa fa-search fa-3x"></i><p>No phishlets found matching your search</p></div>')}function autoEnablePhishlet(e){var t=$("#redirectorDomain").val();$.ajax({url:"/api/simulationserver/modules",method:"GET",success:function(a){var r=a.modules||a;if(Array.isArray(r)){var o=r.find((function(t){return t.name==e})),n=o&&("enabled"==o.status||!0===o.enabled);if(r.forEach((function(t){("enabled"==t.status||!0===t.enabled)&&t.name!=e&&$.post("/api/simulationserver/modules/"+encodeURIComponent(t.name)+"/toggle")})),t&&$.ajax({url:"/api/simulationserver/modules/"+encodeURIComponent(e)+"/landing_domain",method:"POST",contentType:"application/json",data:JSON.stringify({landing_domain:t}),success:function(){console.log("Landing domain set to: "+t)}}),n){Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}).fire({icon:"success",title:'Phishlet "'+e+'" enabled'})}else $.post("/api/simulationserver/modules/"+encodeURIComponent(e)+"/toggle",(function(t){if(t.success){Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}).fire({icon:"success",title:'Phishlet "'+e+'" enabled'})}}))}}})}function loadPhishletHosts(e){e&&($("#phishletHostsLoading").show(),$("#phishletHostsList").empty(),$.ajax({url:"/api/simulationserver/modules/"+encodeURIComponent(e)+"/hosts",method:"GET",success:function(e){$("#phishletHostsLoading").hide();var t=e.hosts||[];t.length>0?t.forEach((function(e){$("#phishletHostsList").append("<li>"+e+"</li>")})):$("#phishletHostsList").append("<li><em>No hosts configured</em></li>")},error:function(){$("#phishletHostsLoading").hide(),$("#phishletHostsList").append("<li class='text-danger'>Failed to load hosts</li>")}}))}function loadPhishletConfig(e){$.ajax({url:"/api/simulationserver/modules",method:"GET",success:function(t){var a=t.modules||t;if(Array.isArray(a)){var r=a.find((function(t){return t.name==e}));if(r){var o=r.hostname||"";o&&0===$("#phishletHostname option[value='"+o+"']").length&&$("#phishletHostname").append($("<option>").val(o).text(o)),$("#phishletHostname").val(o),$("#phishletLandingDomain").val(r.landing_domain||"");var n=$("#phishletStatusBadge");"enabled"==r.status||!0===r.enabled?n.removeClass("label-default label-danger").addClass("label-success").text("Enabled"):n.removeClass("label-success label-default").addClass("label-danger").text("Disabled")}}}}),loadPhishletHosts(e)}function autoCreateDNSRecords(e,t){const a=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:5e3});a.fire({icon:"info",title:"Setting up DNS records..."}),$.ajax({url:"/api/simulationserver/ec2/status",method:"GET",success:function(r){var o=r.data&&r.data.public_ip;o?($.ajax({url:"/api/simulationserver/config/ipv4",method:"POST",contentType:"application/json",data:JSON.stringify({external:o}),success:function(){console.log("Updated")},error:function(){console.error("Failed to update global IPv4")}}),createDNSRecordsWithIP(e,t,o,a)):a.fire({icon:"warning",title:"EC2 not running - no public IP available"})},error:function(){a.fire({icon:"error",title:"Failed to get EC2 status"})}})}function createDNSRecordsWithIP(e,t,a,r){$.ajax({url:"/api/simulationserver/modules/"+encodeURIComponent(e)+"/hosts",method:"GET",success:function(e){var o=e.hosts||[];0!==o.length&&$.ajax({url:"/api/simulationserver/config/fetch_alldomains",method:"GET",success:function(e){var n=(e.data||e.domains||e||[]).find((function(e){return t.endsWith(e.name)}));if(!n)return console.error("Could not find matching Cloudflare zone for",t),void r.fire({icon:"warning",title:"Could not find Cloudflare zone for "+t});var i=n.id,l=0,s=0;o.forEach((function(e){$.ajax({url:"/api/simulationserver/config/create_dns_record",method:"POST",contentType:"application/json",data:JSON.stringify({zone_id:i,name:e,content:a,type:"A",proxied:!1}),success:function(){++l+s===o.length&&showDNSCompletionMessage(l,s)},error:function(t){var a=t.responseJSON||{};a.message&&a.message.indexOf("already exists")>-1?l++:(s++,console.error("Failed to create DNS record for:",e,t.responseText)),l+s===o.length&&showDNSCompletionMessage(l,s)}})}))},error:function(){r.fire({icon:"error",title:"Failed to fetch Cloudflare domains"})}})},error:function(){r.fire({icon:"error",title:"Failed to get phishlet hosts"})}})}function autoCreateDefaultLure(e,t){var a=generateRandomPath(8),r=$("#useRedirector").is(":checked"),o=null;r&&(o=selectedRedirectorTemplate||$("#redirectorTemplate").val()||null),$.ajax({url:"/api/simulationserver/strikes/create",type:"POST",contentType:"application/json",data:JSON.stringify({module:e}),success:function(e){e.success?setTimeout((function(){getStrikes().then((function(e){if(e&&e.success&&e.data){var r=e.data;if(r.length>0){r.sort((function(e,t){return t.id-e.id}));var n=r[0],i={path:"/"+a};o&&(i.redirector=o),$.ajax({url:"/api/simulationserver/strikes/"+n.id+"/edit",type:"POST",contentType:"application/json",data:JSON.stringify(i),success:function(){var e="https://login."+t+"/"+a;$("#lureList").val(e),$("#selectedLureId").val(n.id),$("#manualLureUrl").val(e),$("#currentLureDisplay").val(e);const r=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});var i="Default lure created: /"+a;o&&(i+=" (with redirector: "+o+")"),r.fire({icon:"success",title:i}),refreshLures()},error:function(){console.error("Failed to set lure path")}})}}}))}),500):console.error("Failed to create lure:",e.error)},error:function(){console.error("Failed to create default lure")}})}function generateRandomPath(e){for(var t="abcdefghijklmnopqrstuvwxyz0123456789",a="",r=0;r<e;r++)a+=t.charAt(Math.floor(Math.random()*t.length));return a}function showDNSCompletionMessage(e,t){const a=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:5e3});0===t?a.fire({icon:"success",title:"Created "+e+" DNS records successfully!"}):a.fire({icon:"warning",title:"Created "+e+" DNS records, "+t+" failed"})}function getZoneIdForDomain(e){return new Promise((function(t,a){$.get("/api/simulationserver/domains",(function(a){var r=(a.result||[]).find((function(t){return e.endsWith(t.name)}));t(r?r.id:null)})).fail((function(){t(null)}))}))}function setRedirectorSubdomain(){var e=$("#redirectorDomain").data("baseDomain")||$("#redirectorDomain").val(),t=$("#subdomainInput").val().trim();if(t){var a=t+"."+e,r=$("#redirectorDomain");0===r.find("option[value='"+a+"']").length&&r.append($("<option>").val(a).text(a+" (subdomain)")),r.val(a),updatePhishletLandingDomain(),Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Subdomain set: "+a,showConfirmButton:!1,timer:3e3})}else Swal.fire({toast:!0,position:"top-end",icon:"warning",title:"Please enter a subdomain",showConfirmButton:!1,timer:3e3})}function updatePhishletLandingDomain(){var e=$("#phishletSelect").val(),t=$("#redirectorDomain").val();$("#useRedirector").is(":checked")&&e&&t&&$.ajax({url:"/api/simulationserver/modules/"+encodeURIComponent(e)+"/landing_domain",method:"POST",contentType:"application/json",data:JSON.stringify({landing_domain:t}),success:function(){Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}).fire({icon:"success",title:"Updated phishlet domain to "+t})},error:function(e){console.error("Failed to update phishlet landing domain",e)}})}function populateTrackingDomains(){var e=$("#trackingDomain");e.html('<option value="">-- Select Domain --</option>'),$("#redirectorDomain").find("option").each((function(){var t=$(this).val(),a=$(this).text();t&&e.append($("<option>").val(t).text(a))})),e.find("option").length<=1&&$.get("/api/simulationserver/config/fetch_alldomains",(function(t){t.success&&t.data&&t.data.forEach((function(t){e.append($("<option>").val(t.name).text(t.name))}))}))}function setTrackingSubdomain(){var e=$("#trackingDomain").data("baseDomain")||$("#trackingDomain").val(),t=$("#trackingSubdomainInput").val().trim();if(t){var a=t+"."+e,r=$("#trackingDomain");0===r.find("option[value='"+a+"']").length&&r.append($("<option>").val(a).text(a+" (subdomain)")),r.val(a),$.ajax({url:"/api/simulationserver/phishlets/example",method:"PUT",contentType:"application/json",data:JSON.stringify({phish_sub:t}),success:function(e){Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Tracking subdomain set: "+a,showConfirmButton:!1,timer:3e3})},error:function(){Swal.fire({toast:!0,position:"top-end",icon:"error",title:"Failed to update phishlet subdomain",showConfirmButton:!1,timer:3e3})}})}else Swal.fire({toast:!0,position:"top-end",icon:"warning",title:"Please enter a subdomain",showConfirmButton:!1,timer:3e3})}function launch(){Swal.fire({title:"Are you sure?",text:"This will schedule the campaign to be launched.",type:"question",animation:!1,showCancelButton:!0,confirmButtonText:"Launch",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise((function(e,t){var a=[];($("#users").val()||[]).forEach((function(e){a.push({name:e})}));var r=$("#send_by_date").val();""!=r&&(r=moment(r,"MMMM Do YYYY, h:mm a").utc().format());var o=$("#scheduled_stop_date").val();""!=o&&(o=moment(o,"MMMM Do YYYY, h:mm a").utc().format());var n=$("#useRedirector").is(":checked"),i=$("#redirectorDomain").val()||"",l=$("#selectedLureLandingUrl").val()||"",s={name:$("#name").val(),template:{name:$("#template_name").val()},url:$("#manualLureUrl").val(),page:{name:""},launch_date:moment($("#launch_date").val(),"MMMM Do YYYY, h:mm a").utc().format(),send_by_date:r||null,scheduled_stop_date:o||null,groups:a,campaign_type:$("#campaign_type").val(),attack_objective:$("#attack_objective").val(),redirect_url:l,landing_url:n?"https://"+i:"",use_redirector:n,redirector_domain:i,redirector_template:$("#redirectorTemplate").val(),phishlet:$("#phishletSelect").val()};"email"==s.campaign_type||"qr"==s.campaign_type?s.smtp={name:$("#profile_name").val()||""}:s.sms={name:$("#profile_name").val()||""},"qr"==s.campaign_type&&(s.qr_size=parseInt($("#qr_size").val())||250),("email"!=s.campaign_type&&"qr"!=s.campaign_type&&s.campaign_type?api.sms_campaigns.post(s):api.campaigns.post(s)).done((function(t){e()})).fail((function(t){var a="An error occurred";t.responseJSON&&t.responseJSON.message?a=t.responseJSON.message:t.responseText&&(a=t.responseText),Swal.showValidationMessage(a),e(!1)}))}))}}).then((function(e){e.value&&Swal.fire("Campaign Scheduled!","This campaign has been scheduled for launch!","success").then((function(){location.href="/campaigns"}))}))}function sendTestEmail(){var e=$("#campaign_type").val(),t={template:{name:$("#template_name").val()},first_name:$("input[name=to_first_name]").val(),last_name:$("input[name=to_last_name]").val(),email:$("input[name=to_email]").val(),position:$("input[name=to_position]").val(),url:$("#lureList").val(),page:{name:""}};"email"==e||"qr"==e?(t.smtp={name:$("#profile_name").val()||""},"qr"==e&&(t.qr_size=parseInt($("#qr_size").val())||250)):t.sms={name:$("#profile_name").val()||""};var a=$("#sendTestModalSubmit").html();$("#sendTestModalSubmit").html('<i class="fa fa-spinner fa-spin"></i> Sending'),("email"==e||"qr"==e?api.send_test_email(t):api.send_test_sms(t)).done((function(t){var r="email"==e||"qr"==e?"Email Sent!":"SMS Sent!";$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-success">            <i class="fa fa-check-circle"></i> '+r+"</div>"),$("#sendTestModalSubmit").html(a)})).fail((function(e){var t="An error occurred";e.responseJSON&&e.responseJSON.message?t=e.responseJSON.message:e.responseText&&(t=e.responseText),$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+t+"</div>"),$("#sendTestModalSubmit").html(a)}))}$(document).on("keyup","#phishletSearch",(function(){var e=$(this).val().toLowerCase();renderPhishletCards(allPhishlets.filter((function(t){return-1!==(t.name||t).toLowerCase().indexOf(e)})))})),$(document).on("click",".phishlet-card",(function(){var e=$(this).data("name");selectedPhishlet=e,$(".phishlet-card").removeClass("selected"),$(this).addClass("selected"),$("#phishletSelect").val(e).trigger("change")})),$("#phishletSelect").on("change",(function(){var e=$(this).val();e?($("#phishletConfigPanel").show(),loadPhishletConfig(e)):$("#phishletConfigPanel").hide()})),$("#phishletHostname").on("click",(function(e){e.stopPropagation(),$("#phishletHostsContainer").show()})),$(document).on("click",(function(e){$(e.target).closest("#phishletHostname").length||$(e.target).closest("#phishletHostsContainer").length||$("#phishletHostsContainer").hide()})),$("#phishletHostname").on("change",(function(){var e=$("#phishletSelect").val(),t=$(this).val();e&&t&&$.ajax({url:"/api/simulationserver/config/domain",method:"POST",contentType:"application/json",data:JSON.stringify({domain:t}),success:function(){$.ajax({url:"/api/simulationserver/modules/"+encodeURIComponent(e)+"/hostname",method:"POST",contentType:"application/json",data:JSON.stringify({hostname:t}),success:function(){Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}).fire({icon:"success",title:"Phishlet hostname set to "+t}),loadPhishletHosts(e),autoCreateDNSRecords(e,t),autoEnablePhishlet(e),autoCreateDefaultLure(e,t)},error:function(){Swal.fire("Error","Failed to update phishlet hostname.","error")}})},error:function(){console.error("Failed to update global domain"),Swal.fire("Error","Failed to update global domain.","error")}})})),$("#saveIPv4Btn").on("click",(function(){var e=$("#serverIPv4").val();$.ajax({url:"/api/simulationserver/config/ipv4",method:"POST",contentType:"application/json",data:JSON.stringify({external:e}),success:function(){Swal.fire("Saved","Server IP updated.","success")},error:function(){Swal.fire("Error","Failed to update IP.","error")}})})),$("#addSubdomainDNSBtn").on("click",(function(){var e=$("#phishletHostname").val(),t=$("#serverIPv4").val();$("#redirectorDomain").val();e&&t?(Swal.fire({title:"Creating DNS Record...",text:"Adding A record for "+e+" -> "+t,onBeforeOpen:()=>{Swal.showLoading()}}),getZoneIdForDomain(e).then((function(a){a?$.ajax({url:"/api/simulationserver/config/create_dns_record",method:"POST",contentType:"application/json",data:JSON.stringify({zone_id:a,name:e,content:t,type:"A",proxied:!1}),success:function(){Swal.fire("Success","DNS Record created.","success")},error:function(e){Swal.fire("Error","Failed to create DNS record: "+(e.responseJSON?e.responseJSON.message:e.statusText),"error")}}):Swal.fire("Error","Could not determine Zone ID for "+e,"error")}))):Swal.fire("Error","Please set Hostname and IP first.","warning")})),$(document).on("change","#redirectorDomain",(function(){var e=$(this).val();e?($("#subdomainOption").show(),$("#useSubdomain").prop("checked",!1),$("#subdomainInput").val("").hide(),$("#setSubdomainBtn").hide(),$("#subdomainHelp").hide(),$(this).data("baseDomain",e)):$("#subdomainOption").hide(),updatePhishletLandingDomain()})),$(document).on("change","#useSubdomain",(function(){if($(this).is(":checked"))$("#subdomainInput").show(),$("#setSubdomainBtn").show(),$("#subdomainHelp").show();else{$("#subdomainInput").val("").hide(),$("#setSubdomainBtn").hide(),$("#subdomainHelp").hide();var e=$("#redirectorDomain").data("baseDomain");e&&($("#redirectorDomain").val(e),updatePhishletLandingDomain())}})),$(document).on("change","#trackingDomain",(function(){var e=$(this).val();e?($("#trackingSubdomainOption").show(),$("#useTrackingSubdomain").prop("checked",!1),$("#trackingSubdomainInput").val("").hide(),$("#setTrackingSubdomainBtn").hide(),$("#trackingSubdomainHelp").hide(),$(this).data("baseDomain",e)):$("#trackingSubdomainOption").hide()})),$(document).on("change","#useTrackingSubdomain",(function(){if($(this).is(":checked"))$("#trackingSubdomainInput").show(),$("#setTrackingSubdomainBtn").show(),$("#trackingSubdomainHelp").show();else{$("#trackingSubdomainInput").val("").hide(),$("#setTrackingSubdomainBtn").hide(),$("#trackingSubdomainHelp").hide();var e=$("#trackingDomain").data("baseDomain");e&&$("#trackingDomain").val(e)}}));var pendingCampaignData=null;function populateCampaignData(e){if(cachedModalData){if($("#name").val(campaignId?e.name:"Copy of "+e.name),e.campaign_type?$("#campaign_type").val(e.campaign_type).change():$("#campaign_type").val("email").change(),e.attack_objective&&$("#attack_objective").val(e.attack_objective).change(),$("#lureList").val(e.url),$("#tracking_redirect_url").val(e.redirect_url),e.qr_size&&$("#qr_size").val(e.qr_size),e.template&&e.template.name&&e.template.id&&$("#template").val(e.template.id.toString()).trigger("change"),e.smtp&&e.smtp.id?$("#profile").val(e.smtp.id.toString()).trigger("change"):e.sms&&e.sms.id&&$("#profile").val(e.sms.id.toString()).trigger("change"),e.groups){var t=e.groups.map((function(e){return e.id.toString()}));$("#users").val(t).trigger("change")}e.scheduled_stop_date&&"0001-01-01T00:00:00Z"!=e.scheduled_stop_date&&$("#scheduled_stop_date").data("DateTimePicker").date(moment(e.scheduled_stop_date))}else pendingCampaignData=e}$(document).ready((function(){$.fn.select2.defaults.set("width","100%"),$.fn.select2.defaults.set("theme","bootstrap"),$("#campaign_type").change((function(){var e=$(this).val();$(".qr-only").hide();var t="Email";if("sms"==e&&(t="SMS"),"qr"==e&&(t="QR"),$("#header_campaign_type").text(t),"email"==e?($("#template_label").text("Email Template:"),$("#profile_label").text("Sending Profile:"),$("#delay_label").html('Send Emails By (Optional) <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="right" title="If specified, trust_strike will send emails evenly between the campaign launch and this date."></i>'),$("#testButtonIcon").attr("class","fa fa-envelope"),$("#testButtonText").text("Send Test Email")):"sms"==e?($("#template_label").text("SMS Template:"),$("#profile_label").text("SMS Profile:"),$("#delay_label").html('Send SMS By (Optional) <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="right" title="If specified, trust_strike will send SMS evenly between the campaign launch and this date."></i>'),$("#testButtonIcon").attr("class","fa fa-commenting"),$("#testButtonText").text("Send Test SMS")):"qr"==e&&($("#template_label").text("QR Template:"),$("#profile_label").text("Sending Profile:"),$("#delay_label").html('Send QR By (Optional) <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="right" title="If specified, trust_strike will send QR evenly between the campaign launch and this date."></i>'),$("#testButtonIcon").attr("class","fa fa-envelope"),$("#testButtonText").text("Send Test QR"),$(".qr-only").show(),generateQR($("#manualLureUrl").val())),$('[data-toggle="tooltip"]').tooltip(),$(".btn-filter-group").parent().hide(),window.filterGroups){var a=e;"qr"!=e&&"email"!=e||(a="email"),window.filterGroups&&window.filterGroups(a)}setupOptions(),window.updateFlowDiagram&&window.updateFlowDiagram()})),window.importEmail=function(){var e=$("#email_content").val(),t=$("#convert_links_checkbox").prop("checked");e?api.import_email({content:e,convert_links:t}).done((function(e){$("#modal_text_editor").val(e.text),$("#modal_html_editor").val(e.html),CKEDITOR.instances.modal_html_editor&&CKEDITOR.instances.modal_html_editor.setData(e.html),$("#modal_subject").val(e.subject),e.html&&$('.nav-tabs a[href="#modal_html"]').tab("show"),$("#importEmailModal").modal("hide")})).fail((function(e){var t="An error occurred";e.responseJSON&&e.responseJSON.message&&(t=e.responseJSON.message),$("#importModal\\.flashes").empty().append("<div class='alert alert-danger'>"+t+"</div>")})):$("#importModal\\.flashes").empty().append("<div class='alert alert-danger'>No Content Specified!</div>")},$("#importEmailModal").on("hidden.bs.modal",(function(){$("#createTemplateModal").hasClass("in")&&($("body").addClass("modal-open"),$("#createTemplateModal").css("overflow-y","auto"))})),window.updateTemplateModalUI=function(e){$("#modal_template_type").val(e);var t="Email Template";"sms"==e&&(t="SMS Template"),"qr"==e&&(t="QR Template"),$("#modal_visual_template_type").val(t),"sms"==e?($(".modal-email-only").hide(),$(".modal-sms-only").show(),$('.nav-tabs a[href="#modal_sms"]').tab("show")):($(".modal-email-only").show(),$(".modal-sms-only").hide(),$('.nav-tabs a[href="#modal_html"]').tab("show"))},$("#lureList").on("input",(function(){"qr"==$("#campaign_type").val()&&generateQR($(this).val())})),$("#qr_size").on("keyup change",(function(){"qr"==$("#campaign_type").val()&&generateQR($("#lureList").val())})),$("#launch_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,defaultDate:moment(),format:"MMMM Do YYYY, h:mm a"}),$("#scheduled_stop_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,defaultDate:moment(),format:"MMMM Do YYYY, h:mm a"}),$("#send_by_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,useCurrent:!1,format:"MMMM Do YYYY, h:mm a"}),$("#scheduled_stop_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,useCurrent:!1,format:"MMMM Do YYYY, h:mm a"}),$(document).on("change","#attack_objective",(function(){"Tracking only"==$(this).val()?($("#url").parent().show(),$("#tracking_redirect_url_group").show(),$("#flow_box_redirector").hide(),$("#flow_arrow_2").hide(),$("#flow_box_login .flow-label").text("Redirector"),$("#flow_box_login .flow-value").text("Page"),$("#flow_box_login i").attr("class","fa fa-random"),window.skipPhishletStep=!0,function(){var e=$("#phishletSelect");e.find("option[value='example']").length>0||e.append($("<option>").val("example").text("example")),e.val("example").trigger("change");setTimeout((function(){$.post("/api/simulationserver/modules/example/toggle",(function(e){e.success&&console.log("Example phishlet auto-enabled for tracking mode")}))}),500)}(),$("#trackingDomainSection").show(),$("#currentLureSection").hide(),populateTrackingDomains()):($("#url").parent().show(),$("#tracking_redirect_url_group").hide(),$("#flow_box_redirector").show(),$("#flow_arrow_2").show(),$("#flow_box_login .flow-label").text("Target"),$("#flow_box_login .flow-value").text("Login"),$("#flow_box_login i").attr("class","fa fa-sign-in"),window.skipPhishletStep=!1,$("#trackingDomainSection").hide(),$("#currentLureSection").show())}));var e=new URLSearchParams(window.location.search).get("copy");campaignId?($("#campaignTitle").text("Edit Campaign"),api.campaignId.get(campaignId).done((function(e){$("#campaignTitle").text("Edit Campaign: "+e.name),populateCampaignData(e)}))):e?($("#campaignTitle").text("New Campaign (Copy)"),api.campaignId.get(e).done((function(e){populateCampaignData(e)}))):$("#campaign_type").trigger("change"),setupOptions(),loadCloudflaireDomains(),loadRedirectorTemplates(),loadPhishlets(),$("#useRedirector").on("change",(function(){toggleRedirectorOptions()})),toggleRedirectorOptions(),$("#attack_objective").trigger("change")})),$(document).ready((function(){$("#createTemplateModal").on("shown.bs.modal",(function(){CKEDITOR.instances.modal_html_editor||($("#modal_html_editor").ckeditor(),"function"==typeof setupAutocomplete&&setupAutocomplete(CKEDITOR.instances.modal_html_editor)),$("#modal_template_name").focus();var e=$("#campaign_type").val();$("#modal_template_type").val(e).trigger("change")})),$("#modal_template_type").change((function(){"sms"==$(this).val()?($(".modal-email-only").hide(),$(".modal-sms-only").show(),$("#createTemplateModal .nav-tabs li").removeClass("active"),$("#createTemplateModal .tab-pane").removeClass("active"),$('#createTemplateModal .nav-tabs li[role="sms"]').addClass("active").show(),$("#modal_sms").addClass("active")):($(".modal-email-only").show(),$(".modal-sms-only").hide(),$("#createTemplateModal .nav-tabs li").removeClass("active"),$("#createTemplateModal .tab-pane").removeClass("active"),$('#createTemplateModal .nav-tabs li[role="html"]').addClass("active"),$("#modal_html").addClass("active"))})),$("#modal_saveTemplateSubmit").click((function(){var e=window.currentEditingTemplateId,t={name:$("#modal_template_name").val(),type:$("#modal_template_type").val(),attachments:[]};if(e&&(t.id=parseInt(e)),""!=t.name){"sms"==t.type?(t.text=$("#modal_sms_editor").val(),t.html="",t.subject=""):(t.subject=$("#modal_subject").val(),t.envelope_sender=$("#modal_envelope_sender").val(),t.html=CKEDITOR.instances.modal_html_editor.getData(),t.html=t.html.replace(/https?:\/\/{{\.URL}}/gi,"{{.URL}}"),t.text=$("#modal_text_editor").val());var a=$(this),r=a.html();a.html('<i class="fa fa-spinner fa-spin"></i> Saving...').prop("disabled",!0),(e?api.templateId.put(t):api.templates.post(t)).done((function(t){a.html(r).prop("disabled",!1),window.currentEditingTemplateId=null,$("#createTemplateModal").modal("hide"),$("#modal_template_name").val(""),$("#modal_subject").val(""),$("#modal_envelope_sender").val(""),CKEDITOR.instances.modal_html_editor&&CKEDITOR.instances.modal_html_editor.setData(""),$("#modal_text_editor").val(""),$("#modal_sms_editor").val(""),$.when(api.templates.get()).done((function(a){cachedModalData&&(cachedModalData.templates=a,renderOptions(cachedModalData),t&&t.id&&selectTemplateCard(t.id),e?(successFlash("Template updated!"),selectTemplateCard(e)):(successFlash("Template created!"),t&&t.id&&selectTemplateCard(t.id)))}))})).fail((function(e){console.error("Template save failed:",e),a.html(r).prop("disabled",!1);var t="Failed to save template";e.responseJSON&&e.responseJSON.message?t=e.responseJSON.message:t+=" ("+e.status+": "+e.statusText+")",$("#templateModal\\.flashes").empty().append("<div class='alert alert-danger'>"+t+"</div>")}))}else errorFlash("Template name is required")}));var e=$("#modal_targetsTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]});function t(e,t){$(t).empty().append("<div style='text-align:center' class='alert alert-danger'><i class='fa fa-exclamation-circle'></i> "+e+"</div>")}function t(e,t){$(t).empty().append("<div style='text-align:center' class='alert alert-danger'><i class='fa fa-exclamation-circle'></i> "+e+"</div>")}$("#createGroupModal").on("shown.bs.modal",(function(){window.currentEditingGroupId=null,$("#createGroupModalLabel").text("New Group"),$("#modal_group_name").focus(),$("#modal_group_type").val($("#campaign_type").val())})),$("#createGroupModal").on("hidden.bs.modal",(function(){$("#modal_group_flashes").empty(),$("#modal_group_name").val(""),$("#modal_targetForm .form-control").val(""),e.clear().draw(),$("#modal_saveGroupSubmit").removeData("bulk-token"),$("#modal_csvupload").val("")})),$("#modal_targetForm").submit((function(t){t.preventDefault();var a=document.getElementById("modal_targetForm");if(a.checkValidity()){var r=$("#modal_firstName").val(),o=$("#modal_lastName").val(),n=$("#modal_email").val().toLowerCase(),i=$("#modal_position").val(),l=[escapeHtml(r),escapeHtml(o),escapeHtml(n),escapeHtml(i),'<span style="cursor:pointer;" class="modal_delete_target"><i class="fa fa-trash-o"></i></span>'],s=e.column(2,{order:"index"}).data().indexOf(n);s>=0?e.row(s,{order:"index"}).data(l):e.row.add(l),e.draw(),$("#modal_targetForm .form-control").val(""),$("#modal_firstName").focus()}else a.reportValidity()})),$("#modal_targetsTable").on("click",".modal_delete_target",(function(){e.row($(this).parents("tr")).remove().draw()})),$("#modal_csvupload").fileupload({url:"/api/import/group/bulk",dataType:"json",paramName:"file",add:function(e,a){$("#modal_group_flashes").empty();var r=a.originalFiles[0].name;if(r&&!/(csv|txt)$/i.test(r.split(".").pop()))return t("Unsupported file extension (use .csv or .txt)","#modal_group_flashes"),!1;$("#modal_saveGroupSubmit").removeData("bulk-token"),a.submit()},done:function(a,r){r.result.success&&r.result.file_token?($("#modal_saveGroupSubmit").data("bulk-token",r.result.file_token),e.clear().draw(),r.result.preview&&r.result.preview.length>0&&($.each(r.result.preview,(function(t,a){e.row.add([escapeHtml(a.first_name||""),escapeHtml(a.last_name||""),escapeHtml(a.email||""),escapeHtml(a.position||""),'<span style="cursor:pointer;" class="modal_delete_target"><i class="fa fa-trash-o"></i></span>'])})),e.draw()),Swal.fire({title:"Preview Loaded",text:"Showing first "+r.result.preview.length+" of "+r.result.total_count+' records. Click "Save Group" to finalize.',type:"info"})):t(r.result.message||"Unknown error during upload","#modal_group_flashes")},fail:function(e,a){t("Upload failed: "+(a.responseJSON?a.responseJSON.message:"Server error"),"#modal_group_flashes")}}),$("#modal_csv-template").click((function(){var e=Papa.unparse([{"First Name":"Example","Last Name":"User",Email:"foobar@example.com",Position:"Systems Administrator"}],{}),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),a=window.URL.createObjectURL(t),r=document.createElement("a");r.href=a,r.setAttribute("download","group_template.csv"),document.body.appendChild(r),r.click(),document.body.removeChild(r)})),$("#modal_saveGroupSubmit").click((function(){var a=$(this).data("bulk-token"),r=$("#modal_group_name").val();if(r){var o={name:r,group_type:$("#modal_group_type").val()},n=$(this),i=n.html();if(n.html('<i class="fa fa-spinner fa-spin"></i> Saving...').prop("disabled",!0),a)o.file_token=a,api.groups.bulk_import_confirm(o).done(c).fail(p);else{var l=[];$.each(e.rows().data(),(function(e,t){l.push({first_name:unescapeHtml(t[0]),last_name:unescapeHtml(t[1]),email:unescapeHtml(t[2]),position:unescapeHtml(t[3])})})),o.targets=l;var s,d=window.currentEditingGroupId;d?(o.id=parseInt(d),s=api.groupId.put(o)):s=api.groups.post(o),s.done(c).fail(p)}}else t("Group name is required","#modal_group_flashes");function c(e){n.html(i).prop("disabled",!1),api.groups.summary().done((function(t){if(cachedModalData){cachedModalData.groups=t.groups;var a=$("#users"),r=a.val()||[],o=(e.group_id||e.id||"").toString();o&&-1===r.indexOf(o)&&r.push(o),renderOptions(cachedModalData),a.val(r).trigger("change"),window.renderGroupTable(cachedModalData.groups)}$("#createGroupModal").modal("hide"),successFlash(e.id?"Group updated!":"Group created and selected!")}))}function p(e){n.html(i).prop("disabled",!1);var a=e.responseJSON&&e.responseJSON.message?e.responseJSON.message:"Error saving group";t(a,"#modal_group_flashes")}})),window.editGroup=function(e){window.currentEditingGroupId=e,$("#createGroupModalLabel").text("Edit Group"),api.groupId.get(e).done((function(e){$("#modal_group_name").val(e.name),$("#modal_group_type").val(e.group_type||"email");var t=$("#modal_targetsTable").DataTable();t.clear(),e.targets&&$.each(e.targets,(function(e,a){var r=[escapeHtml(a.first_name||""),escapeHtml(a.last_name||""),escapeHtml(a.email||""),escapeHtml(a.position||""),'<span style="cursor:pointer;" class="modal_delete_target"><i class="fa fa-trash-o"></i></span>'];t.row.add(r)})),t.draw(),$("#createGroupModal").modal("show")})).fail((function(){errorFlash("Failed to fetch group details.")}))}}));var currentModules=[];function loadModules(){$.get("/api/simulationserver/modules",(function(e){currentModules=e||[]}))}var lureCurrentPage=1,lureItemsPerPage=6,currentLures=[];function refreshLures(){getStrikes().then((function(e){e&&e.success&&(cachedModalData.strikes=e.data,window.renderLureTable(e.data))}))}window.renderLureTable=function(e){e?currentLures=e:e=currentLures;var t=$("#lureSearch").val()?$("#lureSearch").val().toLowerCase():"",a=e.filter((function(e){return!t||(e.url&&e.url.toLowerCase().indexOf(t)>-1||e.redirect_url&&e.redirect_url.toLowerCase().indexOf(t)>-1)}));0===currentModules.length&&loadModules();var r=$("#lureTableBody");if(r.empty(),!a||0===a.length)return r.append('<tr><td colspan="4" class="text-center">No lures found matching criteria.</td></tr>'),void $("#lurePagination").hide();var o=Math.ceil(a.length/lureItemsPerPage);lureCurrentPage>o&&(lureCurrentPage=1),lureCurrentPage<1&&(lureCurrentPage=1);var n=(lureCurrentPage-1)*lureItemsPerPage,i=n+lureItemsPerPage,l=a.slice(n,i);$.each(l,(function(e,t){var a=t.url,o=t.redirect_url||"",n=o||"None",i=t.id,l=$("<tr>");l.attr("id","lure-row-"+i),l.css("cursor","pointer");var s=$("#selectedLureId").val()==i;s&&l.addClass("success");var d=t.redirector&&t.landing_url?t.landing_url:"";l.click((function(e){$(e.target).closest("button").length||$(e.target).closest("a").length||(void 0!==selectedRedirectorTemplate&&selectedRedirectorTemplate&&$.ajax({url:"/api/simulationserver/strikes/"+i+"/edit",method:"POST",contentType:"application/json",data:JSON.stringify({redirector:selectedRedirectorTemplate}),success:function(){Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}).fire({icon:"success",title:"Redirector updated to "+selectedRedirectorTemplate}),getStrikes().then((function(e){e.success&&(cachedModalData.strikes=e.data,renderLureTable(e.data))}))},error:function(){console.error("Failed to update lure "+i+" redirector")}}),window.selectLure(a,o,d,$(this),i))}));var c=s?"fa-check-circle-o":"fa-circle-o";l.append($("<td class='text-center'>").html(`<i class="fa ${c} lure-check"></i>`));var p=$("<td>");p.append($(`<span style="margin-right: 10px;">${escapeHtml(a)}</span>`)),l.append(p),l.append($("<td>").html(`<div style="word-break: break-all;">${escapeHtml(n)}</div>`));var m=$("<td class='text-center'>"),u=$('<button class="btn btn-success btn-xs" style="margin-right: 5px;" title="Edit"><i class="fa fa-pencil"></i></button>');u.click((function(e){e.stopPropagation(),window.openEditLureModal(i)}));var f=$('<button class="btn btn-danger btn-xs" title="Delete"><i class="fa fa-trash"></i></button>');f.click((function(e){e.stopPropagation(),window.deleteLure(i)})),m.append(u).append(f),l.append(m),r.append(l)})),renderPaginationControls("lurePagination",lureCurrentPage,o,"changeLurePage")},window.changeLurePage=function(e){lureCurrentPage=e,window.renderLureTable()},$(document).off("keyup","#lureSearch").on("keyup","#lureSearch",(function(){lureCurrentPage=1,window.renderLureTable()})),window.selectLure=function(e,t,a,r,o){$("#manualLureUrl").val(e),$("#selectedLureId").val(o||""),$("#selectedLureLandingUrl").val(a||""),$(".qr-only").is(":visible")&&generateQR(e),t&&$("#tracking_redirect_url").val(t),$("#lureTableBody tr").removeClass("success"),$("#lureTableBody .lure-check").removeClass("fa-check-circle-o").addClass("fa-circle-o"),r.addClass("success"),r.find(".lure-check").removeClass("fa-circle-o").addClass("fa-check-circle-o")},window.openCreateLureModal=function(){var e=currentModules.find((function(e){return e.enabled}));e?($("#createLureModule").val(e.name),$("#createLurePath").val(""),$("#createRedirectUrl").val(""),$("#createLureRedirector").val(""),loadRedirectors().then((function(){populateRedirectorDropdown("createLureRedirector")})),$("#createLureModal").modal("show")):errorFlash("No phishlet enabled. Please configure a phishlet in Step 4 first.")},window.createLure=function(){var e=$("#createLureModule").val(),t=$("#createLurePath").val(),a=$("#createRedirectUrl").val(),r=$("#createLureRedirector").val();e?($("#createLureModal").modal("hide"),$.ajax({url:"/api/simulationserver/strikes/create",type:"POST",contentType:"application/json",data:JSON.stringify({module:e}),success:function(e){e.success?t||a||r?setTimeout((function(){window.updateLatestLure(t,a,r)}),500):(refreshLures(),successFlash("Lure created!")):errorFlash(e.error||"Failed to create lure")},error:function(){errorFlash("Failed to connect to server")}})):errorFlash("Please select a phishlet")},window.updateLatestLure=function(e,t,a){getStrikes().then((function(r){if(r&&r.success&&r.data){var o=r.data;if(o.length>0){o.sort((function(e,t){return t.id-e.id}));var n=o[0];$.ajax({url:"/api/simulationserver/strikes/"+n.id+"/edit",type:"POST",contentType:"application/json",data:JSON.stringify({path:e,redirect_url:t,redirector:a}),success:function(){refreshLures(),successFlash("Lure created and updated!")}})}}}))},window.openEditLureModal=function(e){var t=cachedModalData.strikes.find((function(t){return t.id==e}));t&&($("#editLureId").val(e),$("#editLurePath").val(t.lure_path||""),$("#editRedirectUrl").val(t.redirect_url||""),loadRedirectors().then((function(){populateRedirectorDropdown("editLureRedirector",t.redirector||"")})),$("#editLureModal").modal("show"))},window.saveLureEdit=function(){var e=$("#editLureId").val(),t=$("#editLurePath").val(),a=$("#editRedirectUrl").val(),r=$("#editLureRedirector").val();$.ajax({url:"/api/simulationserver/strikes/"+e+"/edit",type:"POST",contentType:"application/json",data:JSON.stringify({path:t,redirect_url:a,redirector:r}),success:function(e){e.success?($("#editLureModal").modal("hide"),refreshLures(),successFlash("Lure updated!")):errorFlash(e.error||"Failed to update")}})},window.saveFinalDestination=function(){var e=$("#selectedLureId").val(),t=$("#lureFinalDestination").val();if(e)if(t){var a=$("#btnSaveFinalDestination"),r=a.html();a.prop("disabled",!0).html('<i class="fa fa-spinner fa-spin"></i> Saving...'),$.ajax({url:"/api/simulationserver/strikes/"+e+"/edit",type:"POST",contentType:"application/json",data:JSON.stringify({redirect_url:t}),success:function(e){a.prop("disabled",!1).html(r),e.success?(Swal.fire({title:"Final Destination Set!",text:"Targets will be redirected to: "+t,type:"success",timer:2e3,showConfirmButton:!1}),$("#selectedLureLandingUrl").val(t)):errorFlash(e.error||"Failed to update Final Destination")},error:function(){a.prop("disabled",!1).html(r),errorFlash("Server error: Failed to update Final Destination")}})}else errorFlash("Please enter a Final Destination URL.");else errorFlash("No lure found to update. Please complete Step 4 first.")},window.deleteLure=function(e){Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",type:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Yes, delete it!"}).then((function(t){t.value&&$.ajax({url:"/api/simulationserver/strikes/"+e,type:"DELETE",success:function(e){refreshLures(),successFlash("Lure deleted")},error:function(){errorFlash("Failed to delete")}})}))};var currentRedirectors=[];function loadRedirectors(){return $.ajax({url:"/api/simulationserver/redirectors",type:"GET",dataType:"json"}).then((function(e){return currentRedirectors=e.success&&Array.isArray(e.redirectors)?e.redirectors:Array.isArray(e)?e:[]})).fail((function(){return console.error("Failed to load redirectors"),currentRedirectors=[]}))}function populateRedirectorDropdown(e,t){t=t||"";var a=$("#"+e);a.length&&(a.empty().append('<option value="">No Landing Page</option>'),$.each(currentRedirectors,(function(e,r){var o=r.name||r,n=$("<option>",{value:o,text:o});t&&o===t&&n.attr("selected","selected"),a.append(n)})))}var redirectorEditor=null;function renderRedirectorsTable(){var e=$("#redirectorsTableBody");e.empty(),0!==currentRedirectors.length?$.each(currentRedirectors,(function(t,a){var r=a.name||a,o=$("<tr>");o.append($("<td>").html("<code>"+escapeHtml(r)+"</code>")),o.append($('<td class="text-center">').html('<button class="btn btn-danger btn-xs" onclick="deleteRedirector(\''+r+'\')" title="Delete"><i class="fa fa-trash"></i></button>')),e.append(o)})):e.html('<tr><td colspan="2" class="text-center">No redirectors found.</td></tr>')}window.openRedirectorsModal=function(){loadRedirectors().then((function(){renderRedirectorsTable(),$("#newRedirectorName").val(""),!redirectorEditor&&CKEDITOR?$("#newRedirectorHtml").ckeditor((function(){redirectorEditor=this,this.setData("")}),{height:200,allowedContent:!0,extraAllowedContent:"*(*);*{*}",fullPage:!0}):redirectorEditor&&redirectorEditor.setData(""),$("#redirectorsModal").modal("show")}))},window.createNewRedirector=function(){var e=$("#newRedirectorName").val().trim(),t=redirectorEditor?redirectorEditor.getData():$("#newRedirectorHtml").val();e?t?/\s/.test(e)?errorFlash("Name cannot contain spaces"):$.ajax({url:"/api/simulationserver/redirectors",type:"POST",contentType:"application/json",data:JSON.stringify({name:e,html:t}),success:function(t){t.success?(successFlash("Redirector created successfully!"),$("#newRedirectorName").val(""),redirectorEditor&&redirectorEditor.setData(""),loadRedirectors().then((function(){renderRedirectorsTable(),populateRedirectorDropdown("createLureRedirector",e),populateRedirectorDropdown("editLureRedirector")}))):errorFlash(t.message||t.error||"Failed to create redirector")},error:function(){errorFlash("Failed to connect to server")}}):errorFlash("Please enter HTML content for the redirector"):errorFlash("Please enter a name for the redirector")},window.deleteRedirector=function(e){confirm('Are you sure you want to delete redirector "'+e+'"?')&&$.ajax({url:"/api/simulationserver/redirectors/"+encodeURIComponent(e),type:"DELETE",success:function(e){e.success?(successFlash("Redirector deleted successfully!"),loadRedirectors().then((function(){renderRedirectorsTable(),populateRedirectorDropdown("createLureRedirector"),populateRedirectorDropdown("editLureRedirector")}))):errorFlash(e.message||e.error||"Failed to delete redirector")},error:function(){errorFlash("Failed to connect to server")}})},window.copyToClipboard=function(e,t){var a=document.createElement("textarea");a.value=e,document.body.appendChild(a),a.select();try{document.execCommand("copy");var r=$(t).find("i"),o=r.attr("class");r.attr("class","fa fa-check"),setTimeout((function(){r.attr("class",o)}),1500)}catch(e){console.error("Fallback: Oops, unable to copy",e)}document.body.removeChild(a)};var allGroups=[],currentGroupFilter="all",groupCurrentPage=1,groupItemsPerPage=6,currentFilteredGroups=[];function isGroupSelected(e){return($("#users").val()||[]).includes(e)}function toggleGroupSelection(e,t){var a=$("#users"),r=a.val()||[],o=r.indexOf(e);0===a.find("option[value='"+e+"']").length&&a.append(new Option(e,e)),o>-1?(r.splice(o,1),t.removeClass("success"),t.find(".group-check").removeClass("fa-check-square-o").addClass("fa-square-o")):(r.push(e),t.addClass("success"),t.find(".group-check").removeClass("fa-square-o").addClass("fa-check-square-o")),a.val(r).trigger("change")}window.renderGroupTable=function(e){e?allGroups=e:e=allGroups;var t=$("#groupTableBody");t.empty();var a=e.filter((function(e){return"all"==currentGroupFilter||(e.group_type||"email").toLowerCase()===currentGroupFilter})),r=$("#groupSearch").val()?$("#groupSearch").val().toLowerCase():"";r&&(a=a.filter((function(e){return e.name.toLowerCase().indexOf(r)>-1}))),currentFilteredGroups=a;var o=Math.ceil(a.length/groupItemsPerPage);groupCurrentPage>o&&(groupCurrentPage=1),groupCurrentPage<1&&(groupCurrentPage=1);var n=(groupCurrentPage-1)*groupItemsPerPage,i=n+groupItemsPerPage,l=a.slice(n,i);if(0===a.length)return t.append('<tr><td colspan="7" class="text-center">No groups found.</td></tr>'),void $("#groupPagination").hide();$("#users");$.each(l,(function(e,a){var r=$("<tr>");r.css("cursor","pointer");var o=isGroupSelected(a.name);o&&r.addClass("success"),r.click((function(e){$(e.target).closest("button").length||toggleGroupSelection(a.name,r)}));var n=o?"fa-check-square-o":"fa-square-o";r.append($("<td class='text-center'>").html(`<i class="fa ${n} group-check"></i>`)),r.append($("<td>").text(a.name));var i=(a.group_type||"EMAIL").toUpperCase(),l="label-success";"SMS"===i&&(l="label-info"),"QR"===i&&(l="label-primary"),r.append($("<td class='text-center'>").html(`<span class="label ${l}" style="font-size: 11px;">${i}</span>`)),r.append($("<td>").text("admin")),r.append($("<td class='text-center'>").text(a.targets?a.targets.length:a.num_targets||0));var s=a.modified_date?moment(a.modified_date).format("MMMM Do YYYY, h:mm:ss a"):"-";r.append($("<td>").text(s));var d=$("<td class='text-right'>"),c=$('<button class="btn btn-success btn-xs" style="margin-right: 5px;"><i class="fa fa-pencil"></i></button>');c.click((function(e){e.stopPropagation(),window.editGroup(a.id)}));var p=$('<button class="btn btn-danger btn-xs"><i class="fa fa-trash"></i></button>');p.click((function(e){e.stopPropagation(),Swal.fire({title:"Are you sure?",text:"Delete group "+a.name+"?",type:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Yes, delete!"}).then((function(e){e.value&&api.groupId.delete(a.id).done((function(){api.groups.summary().done((function(e){allGroups=e.groups,window.renderGroupTable()})),successFlash("Group deleted")}))}))})),d.append(c).append(p),r.append(d),t.append(r)})),renderPaginationControls("groupPagination",groupCurrentPage,o,"changeGroupPage")},window.changeGroupPage=function(e){groupCurrentPage=e,window.renderGroupTable()},window.filterGroups=function(e){currentGroupFilter=e,groupCurrentPage=1,window.renderGroupTable()},$("#groupSearch").on("keyup",(function(){groupCurrentPage=1,window.renderGroupTable()})),window.currentEditingProfileId=null,window.openCreateProfileModal=function(){window.currentEditingProfileId=null,$("#createProfileModalLabel").text("New Sending Profile");var e="sms"==$("#campaign_type").val()?"SMS":"SMTP";$("#modal_profile_interface_type").val(e),$("#modal_profile_name").val(""),$("#modal_smtp_from, #modal_smtp_host, #modal_smtp_username, #modal_smtp_password").val(""),$("#modal_sms_account_sid, #modal_sms_auth_token, #modal_sms_from").val(""),"SMS"==e?($("#modal_smtp_fields").hide(),$("#modal_sms_fields").show()):($("#modal_sms_fields").hide(),$("#modal_smtp_fields").show()),$("#createProfileModal").modal("show")},window.editProfile=function(e,t){window.currentEditingProfileId=e,$("#createProfileModalLabel").text("Edit Sending Profile"),$("#modal_profile_interface_type").val(t),("SMS"==t?api.SMSId.get(e):api.SMTPId.get(e)).done((function(e){$("#modal_profile_name").val(e.name),"SMS"==t?($("#modal_sms_fields").show(),$("#modal_smtp_fields").hide(),$("#modal_sms_account_sid").val(e.username),$("#modal_sms_auth_token").val(e.password),$("#modal_sms_from").val(e.from_address)):($("#modal_sms_fields").hide(),$("#modal_smtp_fields").show(),$("#modal_smtp_from").val(e.from_address),$("#modal_smtp_host").val(e.host),$("#modal_smtp_username").val(e.username),$("#modal_smtp_ignore_cert_errors").prop("checked",e.ignore_cert_errors)),$("#createProfileModal").modal("show")})).fail((function(){errorFlash("Failed to fetch profile details.")}))},window.copyProfile=function(e,t){window.currentEditingProfileId=null,$("#createProfileModalLabel").text("Copy Sending Profile"),$("#modal_profile_interface_type").val(t),("SMS"==t?api.SMSId.get(e):api.SMTPId.get(e)).done((function(e){$("#modal_profile_name").val("Copy of "+e.name),"SMS"==t?($("#modal_sms_fields").show(),$("#modal_smtp_fields").hide(),$("#modal_sms_account_sid").val(e.username),$("#modal_sms_auth_token").val(e.password),$("#modal_sms_from").val(e.from_address)):($("#modal_sms_fields").hide(),$("#modal_smtp_fields").show(),$("#modal_smtp_from").val(e.from_address),$("#modal_smtp_host").val(e.host),$("#modal_smtp_username").val(e.username),$("#modal_smtp_ignore_cert_errors").prop("checked",e.ignore_cert_errors)),$("#createProfileModal").modal("show")})).fail((function(){errorFlash("Failed to fetch profile details for copy.")}))},window.deleteProfile=function(e,t,a){Swal.fire({title:"Are you sure?",text:"Delete profile "+a+"?",type:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Yes, delete!"}).then((function(a){a.value&&("SMS"==t?api.SMSId.delete(e):api.SMTPId.delete(e)).done((function(){setupOptions(!0).then((function(){successFlash("Profile deleted")}))}))}))},$("#modal_saveProfileSubmit").click((function(){var e=window.currentEditingProfileId,t=$("#modal_profile_interface_type").val(),a=$("#modal_profile_name").val();if(a){var r={name:a,interface_type:t};if(e&&(r.id=parseInt(e)),"SMS"==t)r.username=$("#modal_sms_account_sid").val(),r.password=$("#modal_sms_auth_token").val(),r.from_address=$("#modal_sms_from").val();else{r.from_address=$("#modal_smtp_from").val(),r.host=$("#modal_smtp_host").val(),r.username=$("#modal_smtp_username").val();var o=$("#modal_smtp_password").val();o&&(r.password=o),r.ignore_cert_errors=$("#modal_smtp_ignore_cert_errors").is(":checked")}var n=$(this),i=n.html();n.prop("disabled",!0).html("<i class='fa fa-spinner fa-spin'></i> Saving..."),("SMS"==t?e?api.SMSId.put(r):api.SMS.post(r):e?api.SMTPId.put(r):api.SMTP.post(r)).done((function(){n.prop("disabled",!1).html(i),$("#createProfileModal").modal("hide"),setupOptions(!0).then((function(){successFlash("Profile saved!")}))})).fail((function(e){n.prop("disabled",!1).html(i);var t=e.responseJSON&&e.responseJSON.message?e.responseJSON.message:"Error saving profile";$("#modal_profile_flashes").html("<div class='alert alert-danger'>"+t+"</div>")}))}else $("#modal_profile_flashes").html("<div class='alert alert-danger'>Name is required</div>")}));
