var template={attachments:[]},templateId=window.location.pathname.split("/").pop();"template"==templateId&&(templateId=null);var icons={"application/vnd.ms-excel":"fa-file-excel-o","text/plain":"fa-file-text-o","image/gif":"fa-file-image-o","image/png":"fa-file-image-o","application/pdf":"fa-file-pdf-o","application/x-zip-compressed":"fa-file-archive-o","application/x-gzip":"fa-file-archive-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"fa-file-powerpoint-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"fa-file-word-o","application/octet-stream":"fa-file-o","application/x-msdownload":"fa-file-o"};function save(){var e={attachments:[]};e.name=$("#name").val();var t,a=$("#template_type").val();e.type=a,"sms"==a?(e.text=$("#text_template").val(),e.html="",e.subject="",e.envelope_sender=""):(e.subject=$("#subject").val(),e.envelope_sender=$("#envelope-sender").val(),e.html=CKEDITOR.instances.html_editor.getData(),e.html=e.html.replace(/https?:\/\/{{\.URL}}/gi,"{{.URL}}"),$("#use_tracker_checkbox").prop("checked")?-1==e.html.indexOf("{{.Tracker}}")&&-1==e.html.indexOf("{{.TrackingUrl}}")&&(e.html=e.html.replace("</body>","{{.Tracker}}</body>")):e.html=e.html.replace("{{.Tracker}}</body>","</body>"),e.text=$("#text_editor").val()),$.each($("#attachmentsTable").DataTable().rows().data(),(function(t,a){e.attachments.push({name:unescapeHtml(a[1]),content:a[3],type:a[4]})})),templateId?(e.id=parseInt(templateId),t=api.templateId.put(e)):t=api.templates.post(e),t.done((function(e){successFlash("Template saved successfully!"),setTimeout((function(){location.href="/templates"}),1e3)})).fail((function(e){modalError(e)}))}function attach(e){var t=$("#attachmentsTable").DataTable();$.each(e,(function(e,a){var l=new FileReader;l.onload=function(e){var o=icons[a.type]||"fa-file-o";t.row.add(['<i class="fa '+o+'"></i>',escapeHtml(a.name),'<span class="remove-row"><i class="fa fa-trash-o"></i></span>',l.result.split(",")[1],a.type||"application/octet-stream"]).draw()},l.readAsDataURL(a)}))}function importEmail(){var e=$("#email_content").val(),t=$("#convert_links_checkbox").prop("checked");e?api.import_email({content:e,convert_links:t}).done((function(e){$("#text_editor").val(e.text),CKEDITOR.instances.html_editor.setData(e.html),$("#subject").val(e.subject),e.html&&(CKEDITOR.instances.html_editor.setMode("wysiwyg"),$('.nav-tabs a[href="#html"]').click()),$("#importEmailModal").modal("hide")})).fail((function(e){var t="An error occurred";e.responseJSON&&e.responseJSON.message&&(t=e.responseJSON.message),$("#importModal\\.flashes").empty().append("<div class='alert alert-danger'>"+t+"</div>")})):$("#importModal\\.flashes").empty().append("<div class='alert alert-danger'>No Content Specified!</div>")}$(document).ready((function(){$("#html_editor").ckeditor(),setupAutocomplete(CKEDITOR.instances.html_editor);var e=$("#attachmentsTable").DataTable({destroy:!0,order:[[1,"asc"]],columnDefs:[{orderable:!1,targets:"no-sort"},{sClass:"datatable_hidden",targets:[3,4]}]});if($("#attachmentsTable").on("click","span.remove-row",(function(){e.row($(this).parents("tr")).remove().draw()})),$("#template_type").change((function(){"sms"==$(this).val()?($(".email-only").hide(),$(".sms-only").show(),$(".nav-tabs li").removeClass("active"),$(".tab-pane").removeClass("active"),$('.nav-tabs li[role="sms"]').addClass("active").show(),$("#sms").addClass("active")):($(".email-only").show(),$(".sms-only").hide(),$(".nav-tabs li").removeClass("active"),$(".tab-pane").removeClass("active"),$('.nav-tabs li[role="html"]').addClass("active"),$("#html").addClass("active"))})),$("#saveSubmit").click(save),templateId)api.templateId.get(templateId).done((function(t){template=t,$("#templateModalLabel").text("Edit Template: "+template.name),$("#name").val(template.name),$("#subject").val(template.subject),$("#envelope-sender").val(template.envelope_sender),CKEDITOR.instances.html_editor.setData(template.html),$("#text_editor").val(template.text),$("#text_template").val(template.text);var a=[];$.each(template.attachments,(function(e,t){var l=icons[t.type]||"fa-file-o";a.push(['<i class="fa '+l+'"></i>',escapeHtml(t.name),'<span class="remove-row"><i class="fa fa-trash-o"></i></span>',t.content,t.type||"application/octet-stream"])})),e.rows.add(a).draw(),template.html&&-1!=template.html.indexOf("{{.Tracker}}")?$("#use_tracker_checkbox").prop("checked",!0):$("#use_tracker_checkbox").prop("checked",!1),template.type?$("#template_type").val(template.type).trigger("change"):template.html&&""!==template.html||!template.text?$("#template_type").val("email").trigger("change"):$("#template_type").val("sms").trigger("change")}));else{var t=new URLSearchParams(window.location.search).get("copy");t&&api.templateId.get(t).done((function(t){template=t,$("#templateModalLabel").text("Copy Template: "+template.name),$("#name").val("Copy of "+template.name),$("#subject").val(template.subject),$("#envelope-sender").val(template.envelope_sender),CKEDITOR.instances.html_editor.setData(template.html),$("#text_editor").val(template.text),$("#text_template").val(template.text);var a=[];$.each(template.attachments,(function(e,t){var l=icons[t.type]||"fa-file-o";a.push(['<i class="fa '+l+'"></i>',escapeHtml(t.name),'<span class="remove-row"><i class="fa fa-trash-o"></i></span>',t.content,t.type||"application/octet-stream"])})),e.rows.add(a).draw(),template.html&&-1!=template.html.indexOf("{{.Tracker}}")?$("#use_tracker_checkbox").prop("checked",!0):$("#use_tracker_checkbox").prop("checked",!1),template.type?$("#template_type").val(template.type).trigger("change"):$("#template_type").val("email").trigger("change")}))}$('[data-toggle="tooltip"]').tooltip()}));