let groups=[],currentGroupId=-1;const load=()=>{$("#groupTable").hide(),$("#loading").show(),api.userGroups.get().done((e=>{groups=e,$("#loading").hide(),$("#groupTable").show();let r=$("#groupTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]});r.clear(),groupRows=[],$.each(groups,((e,r)=>{groupRows.push([escapeHtml(r.name),moment(r.modified_date).format("MMMM Do YYYY, h:mm:ss a"),"<button class='btn btn-primary members_button' data-toggle='modal' data-backdrop='static' data-target='#membersModal' data-group-id='"+r.id+"'>                    <i class='fa fa-users'></i>                    </button>                    <button class='btn btn-danger delete_button' data-group-id='"+r.id+"'>                    <i class='fa fa-trash-o'></i>                    </button>"])})),r.rows.add(groupRows).draw()})).fail((()=>{errorFlash("Error fetching user groups")}))},saveGroup=()=>{let e={name:$("#name").val()};api.userGroups.post(e).done((r=>{successFlash("User Group "+escapeHtml(e.name)+" created successfully!"),load(),$("#name").val(""),$("#modal").modal("hide")})).fail((e=>{modalError(e)}))},deleteGroup=e=>{let r=groups.find((r=>r.id==e));r&&Swal.fire({title:"Are you sure?",text:"This will delete the User Group '"+escapeHtml(r.name)+"'. All members will lose shared access. This can't be undone!",type:"warning",showCancelButton:!0,confirmButtonText:"Delete",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(((r,a)=>{api.userGroupId.delete(e).done((()=>r())).fail((e=>a(e.responseJSON.message)))})).catch((e=>{Swal.showValidationMessage(e)}))}}).then((e=>{e.value&&(Swal.fire("Deleted!","The User Group has been deleted.","success"),load())}))},manageMembers=e=>{currentGroupId=e;let r=groups.find((r=>r.id==e));$("#currentGroupName").text(r.name),loadMembers()},loadMembers=()=>{api.userGroupId.get(currentGroupId).done((e=>{refreshMembersTable(e.members||[])})),api.users.get().done((e=>{$("#userSelect").empty().append('<option value="">Select a user to add...</option>'),$.each(e,((e,r)=>{$("#userSelect").append($("<option>",{value:r.id,text:r.username}))}))}))},refreshMembersTable=e=>{let r=$("#membersTable").DataTable({destroy:!0,paging:!1,searching:!1,info:!1,columnDefs:[{orderable:!1,targets:"no-sort"}]});r.clear();let a=[];$.each(e,((e,r)=>{a.push([escapeHtml(r.username),"<button class='btn btn-danger btn-xs remove_member_button' data-user-id='"+r.id+"'>            <i class='fa fa-times'></i> Remove</button>"])})),r.rows.add(a).draw()};$(document).ready((function(){load(),$("#modalSubmit").click(saveGroup),$("#groupTable").on("click",".delete_button",(function(){deleteGroup($(this).attr("data-group-id"))})),$("#groupTable").on("click",".members_button",(function(){manageMembers($(this).attr("data-group-id"))})),$("#addMemberButton").click((function(){let e=$("#userSelect").val();e&&api.userGroupId.addMember(currentGroupId,e).done((()=>{loadMembers(),successFlashFade("User added to group",2)})).fail((e=>{errorFlash(e.responseJSON.message)}))})),$("#membersTable").on("click",".remove_member_button",(function(){let e=$(this).attr("data-user-id");api.userGroupId.removeMember(currentGroupId,e).done((()=>loadMembers())).fail((e=>errorFlash(e.responseJSON.message)))}))}));