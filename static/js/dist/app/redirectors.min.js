var redirectors=[],currentPage=1,itemsPerPage=6;const API_BASE="/api/simulationserver/redirectors";function loadRedirectors(){$("#loading").show(),$("#redirectorGrid").hide(),$("#emptyMessage").hide(),$.ajax({url:API_BASE,method:"GET",success:function(e){$("#loading").hide(),0===(redirectors=e.success&&Array.isArray(e.redirectors)?e.redirectors:Array.isArray(e)?e:[]).length?$("#emptyMessage").show():($("#redirectorGrid").show(),renderRedirectorCards())},error:function(e){$("#loading").hide(),showError("Failed to load redirectors: "+(e.responseJSON?.message||"Unknown error"))}})}function renderRedirectorCards(){var e=$("#redirectorGrid");e.empty();var r=$("#searchRedirectors").val().toLowerCase(),t=redirectors.filter((function(e){var t=e.name||e;return!r||t.toLowerCase().indexOf(r)>-1}));if(0===t.length)return e.html('<div class="col-md-12"><div class="alert alert-info">No redirectors match your search.</div></div>'),void $("#redirectorPagination").hide();var a=Math.ceil(t.length/itemsPerPage);currentPage>a&&(currentPage=1);var i=(currentPage-1)*itemsPerPage,o=i+itemsPerPage;t.slice(i,o).forEach((function(r){var t=r.name||r,a=r.html_escaped||"",i=r.html_base64||"",o="";if(i)try{o=atob(i)}catch(e){o=a}else if(a){var n=document.createElement("div");n.innerHTML=a,o=n.textContent||n.innerText||""}var c=`\n            <div class="col-md-4 col-sm-6">\n                <div class="redirector-card" id="card-${escapeHtml(t)}">\n                    <div class="redirector-header">\n                        <div class="redirector-name" title="${escapeHtml(t)}">${escapeHtml(t)}</div>\n                        <button class="btn btn-success btn-xs btn-action-preview" onclick="previewFull('${escapeHtml(t)}'); event.stopPropagation();" \n                                style="padding: 4px 8px; font-size: 14px; font-weight: bold;">\n                            FULL PREVIEW\n                        </button>\n                    </div>\n                    <div class="redirector-preview">\n                        <iframe srcdoc="${o.replace(/"/g,"&quot;")}" sandbox></iframe>\n                    </div>\n                    <div class="redirector-footer">\n                        <div class="redirector-actions">\n                            <button class="btn btn-default btn-sm btn-action" onclick="editRedirector('${escapeHtml(t)}'); event.stopPropagation();" title="Edit">\n                                <i class="fa fa-pencil"></i>\n                            </button>\n                            <button class="btn btn-danger btn-sm btn-action-delete" onclick="deleteRedirector('${escapeHtml(t)}'); event.stopPropagation();" title="Delete">\n                                <i class="fa fa-trash"></i>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;e.append(c)})),renderPagination(a)}function renderPagination(e){if(e<=1)$("#redirectorPagination").hide();else{var r='<ul class="pagination" style="margin: 0;">';r+='<li class="'+(1===currentPage?"disabled":"")+'"><a href="#" onclick="changePage('+(currentPage-1)+'); return false;">&laquo;</a></li>';for(var t=1;t<=e;t++)r+='<li class="'+(t===currentPage?"active":"")+'"><a href="#" onclick="changePage('+t+'); return false;">'+t+"</a></li>";r+='<li class="'+(currentPage===e?"disabled":"")+'"><a href="#" onclick="changePage('+(currentPage+1)+'); return false;">&raquo;</a></li>',r+="</ul>",$("#redirectorPagination").html(r).show()}}function changePage(e){var r=Math.ceil(redirectors.length/itemsPerPage);e<1||e>r||(currentPage=e,renderRedirectorCards())}function openCreateModal(){$("#redirectorModalTitle").text("New Redirector"),$("#editingRedirectorName").val(""),$("#redirectorName").val("").prop("readonly",!1),CKEDITOR.instances.redirectorHtml?CKEDITOR.instances.redirectorHtml.setData(""):$("#redirectorHtml").val(""),$("#redirectorModal").modal("show")}function editRedirector(e){var r=redirectors.find((function(r){return(r.name||r)===e}));if(r){$("#redirectorModalTitle").text("Edit Redirector"),$("#editingRedirectorName").val(e),$("#redirectorName").val(e).prop("readonly",!0);var t="";if(r.html_base64)try{t=atob(r.html_base64)}catch(e){t=""}CKEDITOR.instances.redirectorHtml?CKEDITOR.instances.redirectorHtml.setData(t):$("#redirectorHtml").val(t),$("#redirectorModal").modal("show")}else showError("Redirector not found")}function saveRedirector(){var e=$("#editingRedirectorName").val(),r=$("#redirectorName").val().trim(),t=CKEDITOR.instances.redirectorHtml?CKEDITOR.instances.redirectorHtml.getData():$("#redirectorHtml").val();if(r)if(/\s/.test(r))showError("Name cannot contain spaces");else if(t){var a=$("#saveRedirectorBtn"),i=a.html();a.html('<i class="fa fa-spinner fa-spin"></i> Saving...').prop("disabled",!0);var o=""!==e,n=o?API_BASE+"/"+encodeURIComponent(e):API_BASE,c=o?"PUT":"POST";$.ajax({url:n,method:c,contentType:"application/json",data:JSON.stringify({name:r,html:t}),success:function(e){a.html(i).prop("disabled",!1),e.success?($("#redirectorModal").modal("hide"),showSuccess(o?"Redirector updated!":"Redirector created!"),loadRedirectors()):showError(e.message||e.error||"Failed to save")},error:function(e){a.html(i).prop("disabled",!1),showError("Failed to save: "+(e.responseJSON?.message||"Server error"))}})}else showError("Please enter HTML content");else showError("Please enter a name")}function deleteRedirector(e){Swal.fire({title:"Are you sure?",text:"Delete redirector '"+e+"'?",type:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Yes, delete it!"}).then((function(r){r.value&&$.ajax({url:API_BASE+"/"+encodeURIComponent(e),method:"DELETE",success:function(e){e.success?(showSuccess("Redirector deleted!"),loadRedirectors()):showError(e.message||"Failed to delete")},error:function(){showError("Failed to delete redirector")}})}))}function previewFull(e){var r=redirectors.find((function(r){return(r.name||r)===e}));if(r){var t="";if(r.html_base64)try{t=atob(r.html_base64)}catch(e){t=r.html_escaped||""}$("#previewModalTitle").text("Preview: "+e),document.getElementById("previewFrame").srcdoc=t,$("#previewModal").modal("show")}}function escapeHtml(e){if(!e)return"";var r=document.createElement("div");return r.appendChild(document.createTextNode(e)),r.innerHTML}function showSuccess(e){"undefined"!=typeof Swal?Swal.fire({icon:"success",title:"Success",text:e,timer:2e3,showConfirmButton:!1}):$("#flashes").html('<div class="alert alert-success">'+e+"</div>")}function showError(e){"undefined"!=typeof Swal?Swal.fire({icon:"error",title:"Error",text:e}):$("#flashes").html('<div class="alert alert-danger">'+e+"</div>")}$(document).ready((function(){loadRedirectors(),$("#searchRedirectors").on("keyup",(function(){currentPage=1,renderRedirectorCards()})),$("#redirectorModal").on("shown.bs.modal",(function(){CKEDITOR.instances.redirectorHtml||$("#redirectorHtml").ckeditor({height:300,allowedContent:!0,extraAllowedContent:"*(*);*{*}",fullPage:!0})}))}));