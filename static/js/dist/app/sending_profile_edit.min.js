var headersTable,profile={headers:[]};function addCustomHeader(e,a){var r=[escapeHtml(e),escapeHtml(a),'<span style="cursor:pointer;" class="delete-header"><i class="fa fa-trash-o"></i></span>'],s=headersTable.column(0).data().indexOf(escapeHtml(e));s>=0?headersTable.row(s).data(r):headersTable.row.add(r),headersTable.draw()}function save(){profile.name=$("#name").val(),profile.interface_type=$("#interface_type").val(),"SMTP"==profile.interface_type?(profile.headers=[],$.each(headersTable.rows().data(),(function(e,a){profile.headers.push({key:unescapeHtml(a[0]),value:unescapeHtml(a[1])})})),profile.from_address=$("#from").val(),profile.host=$("#host").val(),profile.username=$("#username").val(),profile.password=$("#password").val(),profile.ignore_cert_errors=$("#ignore_cert_errors").prop("checked")):(profile.account_sid=$("#account_sid").val(),profile.auth_token=$("#auth_token").val(),profile.sms_from=$("#sms_from").val()),(profile.id?"SMTP"==profile.interface_type?api.SMTPId.put(profile):api.SMSId.put(profile):"SMTP"==profile.interface_type?api.SMTP.post(profile):api.SMS.post(profile)).done((function(e){Swal.fire({title:"Success!",text:"Profile saved successfully!",type:"success"}).then((function(){location.href="/sending_profiles"}))})).fail((function(e){var a="An error occurred";e.responseJSON&&e.responseJSON.message&&(a=e.responseJSON.message),Swal.fire("Error",a,"error")}))}function sendTestEmail(){var e=[];$.each(headersTable.rows().data(),(function(a,r){e.push({key:unescapeHtml(r[0]),value:unescapeHtml(r[1])})}));var a={template:{},first_name:$("input[name=to_first_name]").val(),last_name:$("input[name=to_last_name]").val(),email:$("input[name=to_email]").val(),position:$("input[name=to_position]").val(),url:"",smtp:{from_address:$("#from").val(),host:$("#host").val(),username:$("#username").val(),password:$("#password").val(),ignore_cert_errors:$("#ignore_cert_errors").prop("checked"),headers:e}},r=$("#confirmSendTest"),s=r.html();r.html('<i class="fa fa-spinner fa-spin"></i> Sending').prop("disabled",!0),api.send_test_email(a).done((function(e){$("#testEmailFlashes").empty().append('<div class="alert alert-success"><i class="fa fa-check-circle"></i> Email Sent!</div>'),r.html(s).prop("disabled",!1)})).fail((function(e){var a="An error occurred";e.responseJSON&&e.responseJSON.message&&(a=e.responseJSON.message),$("#testEmailFlashes").empty().append('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+escapeHtml(a)+"</div>"),r.html(s).prop("disabled",!1)}))}$(document).ready((function(){headersTable=$("#headersTable").DataTable({destroy:!0,paging:!1,searching:!1,info:!1,columnDefs:[{orderable:!1,targets:"no-sort"}]}),$("#interface_type").change((function(){"SMTP"==$(this).val()?($("#smtp_fields").show(),$("#sms_fields").hide(),$("#sendTestButton").show()):($("#smtp_fields").hide(),$("#sms_fields").show(),$("#sendTestButton").hide())})).trigger("change"),$("#addCustomHeader").click((function(){var e=$("#headerKey").val(),a=$("#headerValue").val();e&&a&&(addCustomHeader(e,a),$("#headerKey").val("").focus(),$("#headerValue").val(""))})),$("#headersTable").on("click",".delete-header",(function(){headersTable.row($(this).parents("tr")).remove().draw()})),$("#submitButton").click(save),$("#sendTestButton").click((function(){$("#testEmailFlashes").empty(),$("#sendTestEmailModal").modal("show")})),$("#confirmSendTest").click(sendTestEmail);var e=window.location.pathname.split("/").pop(),a=function(e){var a,r,s=window.location.search.substring(1).split("&");for(r=0;r<s.length;r++)if((a=s[r].split("="))[0]===e)return void 0===a[1]||decodeURIComponent(a[1]);return!1}("copy");function r(e,a){profile=e,a?(delete profile.id,$("#name").val("Copy of "+e.name)):$("#name").val(e.name),$("#interface_type").val(e.interface_type||"SMTP").trigger("change"),"SMTP"!=e.interface_type&&e.interface_type?($("#account_sid").val(e.account_sid),$("#auth_token").val(e.auth_token),$("#sms_from").val(e.sms_from)):($("#from").val(e.from_address),$("#host").val(e.host),$("#username").val(e.username),$("#password").val(e.password),$("#ignore_cert_errors").prop("checked",e.ignore_cert_errors),$.each(e.headers,(function(e,a){addCustomHeader(a.key,a.value)})))}e&&!isNaN(e)?($("#pageTitle").text("Edit Sending Profile"),api.SMTPId.get(e).done((function(e){r(e)})).fail((function(){api.SMSId.get(e).done((function(e){r(e)})).fail((function(){Swal.fire("Error","Error fetching profile data","error")}))}))):a&&($("#pageTitle").text("Copy Sending Profile"),api.SMTPId.get(a).done((function(e){r(e,!0)})).fail((function(){api.SMSId.get(a).done((function(e){r(e,!0)})).fail((function(){Swal.fire("Error","Error fetching profile data for copy","error")}))})))}));