var profiles=[],profileType="";function switchProfileType(e){profileType=e,""==e?(pageHeader="All Sending Profiles",$(".page-header").text(pageHeader)):"email"==e?(pageHeader="SMTP Profiles",$(".page-header").text(pageHeader)):"sms"==e&&(pageHeader="SMS Profiles",$(".page-header").text(pageHeader)),$("#emptyMessageText").text("No "+profileType+" profiles created yet. Let's create one!"),load()}function sendTestEmail(){var e=[];$.each($("#headersTable").DataTable().rows().data(),(function(a,t){e.push({key:unescapeHtml(t[0]),value:unescapeHtml(t[1])})}));var a={template:{},first_name:$("input[name=to_first_name]").val(),last_name:$("input[name=to_last_name]").val(),email:$("input[name=to_email]").val(),position:$("input[name=to_position]").val(),url:"",smtp:{from_address:$("#from").val(),host:$("#host").val(),username:$("#username").val(),password:$("#password").val(),ignore_cert_errors:$("#ignore_cert_errors").prop("checked"),headers:e}};btnHtml=$("#sendTestModalSubmit").html(),$("#sendTestModalSubmit").html('<i class="fa fa-spinner fa-spin"></i> Sending'),api.send_test_email(a).done((function(e){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-success">\t    <i class="fa fa-check-circle"></i> Email Sent!</div>'),$("#sendTestModalSubmit").html(btnHtml)})).fail((function(e){var a="An error occurred";e.responseJSON&&e.responseJSON.message?a=e.responseJSON.message:e.responseText&&(a=e.responseText),$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">\t    <i class="fa fa-exclamation-circle"></i> '+escapeHtml(a)+"</div>"),$("#sendTestModalSubmit").html(btnHtml)}))}function save(e){var a={headers:[]};(a.name=$("#name").val(),a.name=$("#name").val(),a.interface_type=$("#interface_type").val(),-1!=e&&(a.interface_type=profiles[e].interface_type),"SMTP"==a.interface_type?($.each($("#headersTable").DataTable().rows().data(),(function(e,t){a.headers.push({key:unescapeHtml(t[0]),value:unescapeHtml(t[1])})})),a.from_address=$("#from").val(),a.host=$("#host").val(),a.username=$("#username").val(),a.password=$("#password").val(),a.ignore_cert_errors=$("#ignore_cert_errors").prop("checked")):(a.account_sid=$("#account_sid").val(),a.auth_token=$("#auth_token").val(),a.sms_from=$("#sms_from").val()),-1!=e)?(a.id=profiles[e].id,("SMTP"==a.interface_type?api.SMTPId.put(a):api.SMSId.put(a)).done((function(e){successFlash("Profile edited successfully!"),load(),dismiss()})).fail((function(e){modalError(e)}))):("SMTP"==a.interface_type?api.SMTP.post(a):api.SMS.post(a)).done((function(e){successFlash("Profile added successfully!"),load(),dismiss()})).fail((function(e){modalError(e.responseJSON.message)}))}function dismiss(){$("#modal\\.flashes").empty(),$("#name").val(""),$("#modal\\.flashes").empty(),$("#name").val(""),$("#interface_type").val("SMTP"),$("#from").val(""),$("#from").val(""),$("#host").val(""),$("#username").val(""),$("#password").val(""),$("#ignore_cert_errors").prop("checked",!0),$("#account_sid").val(""),$("#auth_token").val(""),$("#sms_from").val(""),$("#smtp_fields").show(),$("#sms_fields").hide(),$("#smtp_headers_section").show(),$("#headersTable").dataTable().DataTable().clear().draw(),$("#modal").modal("hide")}var dismissSendTestEmailModal=function(){$("#sendTestEmailModal\\.flashes").empty(),$("#sendTestModalSubmit").html("<i class='fa fa-envelope'></i> Send")},deleteProfile=function(e){var a=profiles[e];Swal.fire({title:"Are you sure?",text:"This will delete the sending profile. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+escapeHtml(a.name),confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(e,t){("SMTP"==a.interface_type?api.SMTPId.delete(a.id):api.SMSId.delete(a.id)).done((function(a){e(a)})).fail((function(a){var t="An error occurred";a.responseJSON&&a.responseJSON.message?t=a.responseJSON.message:a.responseText&&(t=a.responseText),Swal.showValidationMessage(t),e(!1)}))}))}}).then((function(e){e.value&&Swal.fire("Sending Profile Deleted!","This sending profile has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.reload()}))}))};function edit(e){location.href=-1==e?"/sending_profile":"/sending_profile/"+profiles[e].id}function copy(e){location.href="/sending_profile?copy="+profiles[e].id}function load(){$("#profileTable").hide(),$("#emptyMessage").hide(),$("#loading").show();var e=api.SMTP.get(),a=api.SMS.get();$.when(e,a).done((function(e,a){profiles=e[0].concat(a[0]),"email"==profileType?profiles=profiles.filter((e=>!e.interface_type||"SMTP"==e.interface_type)):"sms"==profileType&&(profiles=profiles.filter((e=>"SMS"==e.interface_type))),$("#loading").hide(),profiles.length>0?($("#profileTable").show(),profileTable=$("#profileTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]}),profileTable.clear(),profileRows=[],$.each(profiles,(function(e,a){"SMTP"==a.interface_type?rowClass="label-success":"SMS"==a.interface_type&&(rowClass="label-info"),profileRows.push(["<input type='checkbox' class='profile-checkbox' value='"+a.id+"' data-type='"+a.interface_type+"'>",escapeHtml(a.name),"<span class='label "+rowClass+"'>"+(a.interface_type||"EMAIL").toUpperCase()+"</span>",escapeHtml(a.created_by||""),moment(a.modified_date).format("MMMM Do YYYY, h:mm:ss a"),"<div class='pull-right'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Edit Profile' onclick='edit("+e+")'>                    <i class='fa fa-pencil'></i>                    </button>\t\t    <button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Profile' onclick='copy("+e+")'>                    <i class='fa fa-copy'></i>                    </button>                    <button class='btn btn-danger' data-toggle='tooltip' data-placement='left' title='Delete Profile' onclick='deleteProfile("+e+")'>                    <i class='fa fa-trash-o'></i>                    </button></div>"])})),profileTable.rows.add(profileRows).draw(),$('[data-toggle="tooltip"]').tooltip()):$("#emptyMessage").show()})).fail((function(){$("#loading").hide(),errorFlash("Error fetching profiles")}))}function addCustomHeader(e,a){var t=[escapeHtml(e),escapeHtml(a),'<span style="cursor:pointer;"><i class="fa fa-trash-o"></i></span>'],o=headers.DataTable(),s=o.column(0).data().indexOf(escapeHtml(e));s>=0?o.row(s,{order:"index"}).data(t):o.row.add(t),o.draw()}function toggleSelectAll(){var e=$("#selectAllProfiles").is(":checked");$(".profile-checkbox").prop("checked",e)}function bulkDeleteSelected(){var e=[];$(".profile-checkbox:checked").each((function(){e.push({id:$(this).val(),type:$(this).data("type")})})),0!==e.length?Swal.fire({title:"Delete "+e.length+" profiles?",text:"This action cannot be undone!",type:"warning",showCancelButton:!0,confirmButtonText:"Delete",confirmButtonColor:"#d9534f",reverseButtons:!0}).then((function(a){if(a.value){Swal.fire({title:"Deleting...",allowOutsideClick:!1,onBeforeOpen:()=>{Swal.showLoading()}});var t=e.map((e=>"SMTP"==e.type?api.SMTPId.delete(e.id):api.SMSId.delete(e.id)));$.when.apply($,t).then((function(){Swal.fire("Deleted!","The selected profiles have been removed.","success").then((()=>{location.reload()}))})).fail((function(){Swal.fire("Error","Some profiles could not be deleted.","error").then((()=>{location.reload()}))}))}})):Swal.fire("No selection","Please select at least one profile to delete.","info")}$(document).ready((function(){switchProfileType(""),$(".modal").on("hidden.bs.modal",(function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)})),$(".modal").on("shown.bs.modal",(function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))})),$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy((function(e){this.$element[0]===e.target||this.$element.has(e.target).length||$(e.target).closest(".cke_dialog, .cke").length||this.$element.trigger("focus")}),this))},$(document).on("hidden.bs.modal",".modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")})),$("#modal").on("hidden.bs.modal",(function(e){dismiss()})),$("#modal").on("hidden.bs.modal",(function(e){dismiss()})),$("#interface_type").on("change",(function(){"SMTP"==$(this).val()?($("#smtp_fields").show(),$("#sms_fields").hide(),$("#smtp_headers_section").show()):($("#smtp_fields").hide(),$("#sms_fields").show(),$("#smtp_headers_section").hide())})).trigger("change"),$("#sendTestEmailModal").on("hidden.bs.modal",(function(e){dismissSendTestEmailModal()})),$("#addCustomHeader").on("click",(function(){return headerKey=$("#headerKey").val(),headerValue=$("#headerValue").val(),""==headerKey||""==headerValue||(addCustomHeader(headerKey,headerValue),$("#headerKey").val(""),$("#headerValue").val(""),$("#headerKey").focus()),!1})),$("#headersTable").on("click","span>i.fa-trash-o",(function(){headers.DataTable().row($(this).parents("tr")).remove().draw()})),load()}));